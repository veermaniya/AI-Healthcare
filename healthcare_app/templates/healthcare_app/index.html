<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
{% load static %}
{% csrf_token %}
<meta name="csrf-token" content="{{ csrf_token }}">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>HealthAI ‚Äî Healthcare Intelligence Platform</title>
<link href="https://fonts.googleapis.com/css2?family=DM+Sans:wght@300;400;500;600;700&family=DM+Mono:wght@400;500&family=Playfair+Display:wght@600;700&display=swap" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<style>
:root{
  --bg:#0a0f1a;--surface:#111827;--surface2:#1a2235;--surface3:#1f2d42;
  --border:rgba(99,179,237,0.12);--accent:#38bdf8;--accent2:#34d399;
  --accent3:#f472b6;--accent4:#fb923c;
  --text:#e2e8f0;--text2:#94a3b8;--text3:#64748b;
  --danger:#f87171;--warn:#fbbf24;
  --radius:12px;--radius-lg:20px;--shadow:0 4px 24px rgba(0,0,0,0.4);
}
*{box-sizing:border-box;margin:0;padding:0}
html,body{height:100%;overflow:hidden}
body{font-family:'DM Sans',sans-serif;background:var(--bg);color:var(--text);display:flex;flex-direction:column}
body::before{content:'';position:fixed;inset:0;background-image:linear-gradient(rgba(56,189,248,.03) 1px,transparent 1px),linear-gradient(90deg,rgba(56,189,248,.03) 1px,transparent 1px);background-size:40px 40px;pointer-events:none;z-index:0}

/* HEADER */
.header{flex-shrink:0;height:60px;background:rgba(10,15,26,.95);backdrop-filter:blur(20px);border-bottom:1px solid var(--border);padding:0 24px;display:flex;align-items:center;justify-content:space-between;position:relative;z-index:10}
.logo{display:flex;align-items:center;gap:12px}
.logo-icon{width:34px;height:34px;background:linear-gradient(135deg,var(--accent),var(--accent2));border-radius:9px;display:flex;align-items:center;justify-content:center;font-size:17px}
.logo-text{font-family:'Playfair Display',serif;font-size:19px;font-weight:700;background:linear-gradient(135deg,var(--accent),var(--accent2));-webkit-background-clip:text;-webkit-text-fill-color:transparent}
.logo-sub{font-size:10px;color:var(--text3);letter-spacing:.05em}
.header-right{display:flex;align-items:center;gap:14px}
.badge-free{background:rgba(52,211,153,.15);border:1px solid rgba(52,211,153,.3);color:var(--accent2);font-size:10px;font-weight:600;padding:3px 9px;border-radius:20px}
.status-dot{display:flex;align-items:center;gap:5px;font-size:11px;color:var(--text3)}
.dot{width:6px;height:6px;border-radius:50%;background:var(--accent2);animation:pulse 2s infinite}
@keyframes pulse{0%,100%{opacity:1}50%{opacity:.4}}

/* LAYOUT */
.layout{flex:1;display:grid;grid-template-columns:290px 1fr 330px;overflow:hidden;position:relative;z-index:1}

/* LEFT SIDEBAR */
.sidebar-left{background:var(--surface);border-right:1px solid var(--border);overflow-y:auto;overflow-x:hidden;display:flex;flex-direction:column}
.sidebar-left::-webkit-scrollbar{width:3px}
.sidebar-left::-webkit-scrollbar-thumb{background:var(--border)}
.panel{padding:14px 16px;border-bottom:1px solid var(--border)}
.panel-title{font-size:12px;font-weight:600;color:var(--text2);margin-bottom:10px;display:flex;align-items:center;gap:6px}

/* source tabs */
.tab-group{display:flex;background:var(--surface2);border-radius:10px;padding:3px;gap:2px;margin-bottom:10px}
.tab-btn{flex:1;padding:6px 8px;border:none;border-radius:8px;background:transparent;color:var(--text3);font-size:11px;font-weight:500;cursor:pointer;transition:all .2s;font-family:'DM Sans',sans-serif}
.tab-btn.active{background:var(--surface3);color:var(--accent)}

/* upload zone */
.upload-zone{border:2px dashed var(--border);border-radius:var(--radius);padding:20px 12px;text-align:center;cursor:pointer;transition:all .2s;position:relative;overflow:hidden}
.upload-zone:hover,.upload-zone.drag-over{border-color:var(--accent);background:rgba(56,189,248,.05)}
.upload-zone input{position:absolute;inset:0;opacity:0;cursor:pointer}

/* inputs */
.input-field{width:100%;padding:8px 10px;background:var(--surface2);border:1px solid var(--border);border-radius:var(--radius);color:var(--text);font-size:11px;font-family:'DM Mono',monospace;outline:none;margin-bottom:7px;resize:vertical;transition:border-color .2s}
.input-field:focus{border-color:var(--accent)}
.input-field::placeholder{color:var(--text3)}

/* buttons */
.btn{padding:8px 14px;border:none;border-radius:var(--radius);font-size:12px;font-weight:600;cursor:pointer;transition:all .2s;font-family:'DM Sans',sans-serif;display:inline-flex;align-items:center;gap:5px}
.btn-primary{background:linear-gradient(135deg,var(--accent),#0ea5e9);color:#fff;width:100%;justify-content:center}
.btn-primary:hover{opacity:.9}
.btn-success{background:linear-gradient(135deg,var(--accent2),#10b981);color:#fff;width:100%;justify-content:center}
.btn-danger{background:rgba(248,113,113,.15);color:var(--danger);border:1px solid rgba(248,113,113,.3);font-size:11px;padding:5px 10px}
.btn-sm{padding:7px 14px;font-size:11px;width:auto}

/* dataset info */
#dataset-info{display:none;padding:10px;background:rgba(52,211,153,.08);border:1px solid rgba(52,211,153,.2);border-radius:var(--radius);margin-top:8px}
.ds-stat{display:flex;justify-content:space-between;font-size:11px;color:var(--text2);margin-bottom:3px}
.ds-stat strong{color:var(--accent2)}

/* column selector */
#column-panel{display:none}
.col-search{position:relative;margin-bottom:8px}
.col-search input{width:100%;padding:7px 10px 7px 28px;background:var(--surface2);border:1px solid var(--border);border-radius:var(--radius);color:var(--text);font-size:11px;outline:none;font-family:'DM Sans',sans-serif}
.col-search::before{content:'üîç';position:absolute;left:9px;top:50%;transform:translateY(-50%);font-size:11px;pointer-events:none}
.col-list{max-height:200px;overflow-y:auto;display:flex;flex-direction:column;gap:2px}
.col-list::-webkit-scrollbar{width:3px}
.col-list::-webkit-scrollbar-thumb{background:var(--border)}
.col-item{display:flex;align-items:center;gap:7px;padding:6px 8px;border-radius:7px;cursor:pointer;transition:background .15s;user-select:none}
.col-item:hover{background:var(--surface2)}
.col-item.feat{background:rgba(56,189,248,.1)}
.col-item.tgt{background:rgba(244,114,182,.1)}
.col-chk{width:14px;height:14px;border-radius:3px;border:1.5px solid var(--border);display:flex;align-items:center;justify-content:center;font-size:8px;flex-shrink:0;transition:all .15s}
.col-item.feat .col-chk{background:var(--accent);border-color:var(--accent);color:#fff}
.col-item.tgt .col-chk{background:var(--accent3);border-color:var(--accent3);color:#fff}
.col-name{font-size:11px;font-family:'DM Mono',monospace;color:var(--text);flex:1;overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
.col-badge{font-size:8px;padding:1px 5px;border-radius:8px;font-weight:600}
.badge-num{background:rgba(56,189,248,.15);color:var(--accent)}
.badge-cat{background:rgba(251,146,60,.15);color:var(--accent4)}
.sel-legend{display:flex;gap:8px;margin-bottom:8px}
.legend-item{display:flex;align-items:center;gap:4px;font-size:10px;color:var(--text3)}
.legend-dot{width:7px;height:7px;border-radius:2px}
.sel-summary{font-size:10px;color:var(--text3);margin-top:8px;line-height:1.5}
.sel-summary span{color:var(--accent);font-weight:600}

/* analysis config */
#analysis-panel{display:none}
.cfg-label{font-size:10px;color:var(--text3);margin-bottom:3px;display:block}
.cfg-select{width:100%;padding:7px 10px;background:var(--surface2);border:1px solid var(--border);border-radius:var(--radius);color:var(--text);font-size:11px;outline:none;font-family:'DM Sans',sans-serif;cursor:pointer;margin-bottom:8px}
.cfg-select:focus{border-color:var(--accent)}

/* MAIN */
.main{display:flex;flex-direction:column;overflow:hidden;background:var(--bg)}

/* ‚îÄ‚îÄ TAB NAV SYSTEM ‚îÄ‚îÄ */
.main-tabs{
  flex-shrink:0;
  display:flex;
  background:var(--surface);
  border-bottom:1px solid var(--border);
  padding:0;
  overflow:hidden; /* outer clip */
  position:relative;
}
/* scrollable inner track */
.tabs-scroll{
  display:flex;
  overflow-x:auto;
  overflow-y:hidden;
  scrollbar-width:none;
  flex:1;
  padding:0 8px;
  scroll-behavior:smooth;
}
.tabs-scroll::-webkit-scrollbar{display:none}
/* arrow buttons */
.tab-arrow{
  flex-shrink:0;width:28px;height:44px;
  background:var(--surface);
  border:none;cursor:pointer;
  color:var(--text3);font-size:14px;
  display:flex;align-items:center;justify-content:center;
  transition:all .2s;z-index:2;
  border-bottom:1px solid var(--border);
}
.tab-arrow:hover{color:var(--accent);background:var(--surface2)}
.tab-arrow.hidden{opacity:0;pointer-events:none}
/* tab groups */
.tab-group-sep{
  width:1px;height:22px;
  background:var(--border);
  flex-shrink:0;align-self:center;margin:0 4px;
}
.mtab{
  height:44px;padding:0 11px;
  border:none;background:transparent;
  color:var(--text3);font-size:11px;font-weight:500;
  cursor:pointer;border-bottom:2px solid transparent;
  white-space:nowrap;display:flex;align-items:center;gap:5px;
  font-family:'DM Sans',sans-serif;transition:all .2s;
  flex-shrink:0;margin-bottom:-1px;
  border-radius:0;position:relative;
}
.mtab:hover{color:var(--text2);background:rgba(56,189,248,.04)}
.mtab.active{color:var(--accent);border-bottom-color:var(--accent);background:rgba(56,189,248,.05)}
.new-badge{background:linear-gradient(135deg,var(--accent3),#e879f9);color:#fff;font-size:8px;font-weight:700;padding:1px 5px;border-radius:5px}
/* tab counter badge (for tabs that require data) */
.tab-lock{font-size:8px;color:var(--text3);opacity:.6}

/* tab panels - each scrolls independently */
.tpanel{display:none;flex:1;overflow-y:auto;overflow-x:hidden;padding:20px 22px;min-height:0}
.tpanel.active{display:block}
.tpanel::-webkit-scrollbar{width:4px}
.tpanel::-webkit-scrollbar-thumb{background:var(--border);border-radius:2px}

/* welcome card */
.welcome-card{background:var(--surface);border:1px solid var(--border);border-radius:var(--radius-lg);padding:32px;text-align:center;margin-bottom:18px;position:relative;overflow:hidden}
.welcome-card::before{content:'';position:absolute;top:0;left:0;right:0;height:3px;background:linear-gradient(90deg,var(--accent),var(--accent2),var(--accent3))}
.welcome-title{font-family:'Playfair Display',serif;font-size:22px;font-weight:700;margin-bottom:10px;background:linear-gradient(135deg,var(--text),var(--accent));-webkit-background-clip:text;-webkit-text-fill-color:transparent}
.welcome-desc{font-size:13px;color:var(--text2);max-width:460px;margin:0 auto 18px;line-height:1.7}
.feature-pills{display:flex;gap:7px;justify-content:center;flex-wrap:wrap}
.pill{background:var(--surface2);border:1px solid var(--border);padding:5px 12px;border-radius:20px;font-size:11px;color:var(--text2);display:flex;align-items:center;gap:5px}

/* result cards */
.result-card{background:var(--surface);border:1px solid var(--border);border-radius:var(--radius-lg);padding:18px;margin-bottom:16px;animation:slideIn .3s ease}
@keyframes slideIn{from{opacity:0;transform:translateY(8px)}to{opacity:1;transform:translateY(0)}}
.result-header{display:flex;align-items:center;justify-content:space-between;margin-bottom:14px}
.result-title{font-size:14px;font-weight:600;color:var(--text)}
.result-badge{font-size:10px;font-weight:600;padding:3px 9px;border-radius:20px;letter-spacing:.05em}
.badge-reg{background:rgba(56,189,248,.15);color:var(--accent)}
.badge-cls{background:rgba(244,114,182,.15);color:var(--accent3)}
.badge-clu{background:rgba(251,146,60,.15);color:var(--accent4)}

/* metrics */
.metrics-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(110px,1fr));gap:10px;margin-bottom:14px}
.metric-card{background:var(--surface2);border-radius:var(--radius);padding:12px;text-align:center}
.metric-val{font-family:'DM Mono',monospace;font-size:20px;font-weight:500;color:var(--accent)}
.metric-lbl{font-size:10px;color:var(--text3);margin-top:3px}

/* chart */
.chart-wrap{position:relative;height:170px;margin-top:10px}

/* feature bars */
.feat-bars{display:flex;flex-direction:column;gap:6px;margin-top:10px}
.feat-row{display:flex;align-items:center;gap:8px}
.feat-lbl{font-family:'DM Mono',monospace;font-size:10px;color:var(--text2);width:100px;flex-shrink:0;overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
.feat-track{flex:1;height:6px;background:var(--surface2);border-radius:3px;overflow:hidden}
.feat-fill{height:100%;background:linear-gradient(90deg,var(--accent),var(--accent2));border-radius:3px;transition:width .8s ease}
.feat-pct{font-size:10px;color:var(--text3);width:34px;text-align:right}

/* predict form */
.predict-form{background:var(--surface2);border-radius:var(--radius);padding:14px;margin-top:14px}
.predict-title{font-size:12px;font-weight:600;color:var(--text2);margin-bottom:10px;display:flex;align-items:center;gap:6px}
.predict-inputs{display:grid;grid-template-columns:repeat(auto-fill,minmax(175px,1fr));gap:10px;margin-bottom:12px}
.pred-field{display:flex;flex-direction:column;gap:3px}
.pred-label{display:flex;align-items:center;justify-content:space-between;font-size:9px;color:var(--text3);font-family:'DM Mono',monospace;text-transform:uppercase;letter-spacing:.04em}
.ftype-badge{font-size:8px;padding:1px 5px;border-radius:7px;font-weight:600}
.ftype-num{background:rgba(56,189,248,.15);color:var(--accent)}
.ftype-cat{background:rgba(251,146,60,.15);color:var(--accent4)}
.slider-wrap{display:flex;flex-direction:column;gap:3px}
.slider-row{display:flex;align-items:center;gap:6px}
.slider-input{flex:1;-webkit-appearance:none;appearance:none;height:5px;border-radius:3px;background:var(--surface3);outline:none;cursor:pointer}
.slider-input::-webkit-slider-thumb{-webkit-appearance:none;width:14px;height:14px;border-radius:50%;background:var(--accent);cursor:pointer;border:2px solid var(--surface)}
.slider-val{width:54px;padding:4px 6px;background:var(--surface);border:1px solid var(--border);border-radius:6px;color:var(--accent);font-size:11px;font-family:'DM Mono',monospace;text-align:center;outline:none}
.slider-val:focus{border-color:var(--accent)}
.slider-hints{display:flex;justify-content:space-between;font-size:8px;color:var(--text3);padding:0 2px}
.cat-select{width:100%;padding:7px 8px;background:var(--surface);border:1px solid var(--border);border-radius:8px;color:var(--text);font-size:11px;outline:none;cursor:pointer;appearance:none;background-image:url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='10' height='6'%3E%3Cpath d='M0 0l5 6 5-6z' fill='%2364748b'/%3E%3C/svg%3E");background-repeat:no-repeat;background-position:right 8px center;padding-right:24px}
.cat-select:focus{border-color:var(--accent4)}
.chips{display:flex;flex-wrap:wrap;gap:3px;margin-top:2px}
.chip{padding:2px 7px;background:var(--surface3);border:1px solid var(--border);border-radius:9px;font-size:9px;color:var(--text3);cursor:pointer;transition:all .15s;font-family:'DM Mono',monospace}
.chip:hover,.chip.active{background:rgba(56,189,248,.15);border-color:var(--accent);color:var(--accent)}
.pred-result{padding:12px;background:rgba(52,211,153,.08);border:1px solid rgba(52,211,153,.25);border-radius:var(--radius);display:none;margin-top:10px;animation:slideIn .3s ease}
.pred-result-hdr{font-size:9px;color:var(--text3);text-transform:uppercase;letter-spacing:.08em;margin-bottom:5px}
.pred-result-val{font-family:'DM Mono',monospace;font-size:24px;color:var(--accent2);font-weight:500}
.conf-row{margin-top:7px;display:flex;align-items:center;gap:7px}
.conf-track{flex:1;height:5px;background:var(--surface3);border-radius:3px;overflow:hidden}
.conf-fill{height:100%;background:linear-gradient(90deg,var(--accent2),var(--accent));border-radius:3px;transition:width .8s ease}
.conf-lbl{font-size:10px;color:var(--accent2);font-family:'DM Mono',monospace;width:34px;text-align:right}
.pred-summary{margin-top:8px;padding:7px 9px;background:var(--surface2);border-radius:7px;font-size:9px;color:var(--text3);font-family:'DM Mono',monospace;line-height:1.8}

/* DATA PREVIEW TABLE */
.preview-toolbar{display:flex;align-items:center;gap:8px;margin-bottom:10px;flex-wrap:wrap}
.prev-search{position:relative;flex:1;min-width:160px}
.prev-search input{width:100%;padding:7px 10px 7px 28px;background:var(--surface2);border:1px solid var(--border);border-radius:var(--radius);color:var(--text);font-size:11px;outline:none;font-family:'DM Sans',sans-serif}
.prev-search input:focus{border-color:var(--accent)}
.prev-search input::placeholder{color:var(--text3)}
.prev-search::before{content:'üîç';position:absolute;left:8px;top:50%;transform:translateY(-50%);font-size:11px;pointer-events:none}
.coltog-btn{padding:6px 10px;background:var(--surface2);border:1px solid var(--border);border-radius:var(--radius);color:var(--text3);font-size:10px;cursor:pointer;font-family:'DM Sans',sans-serif;transition:all .15s;white-space:nowrap}
.coltog-btn:hover{border-color:var(--accent);color:var(--accent)}
.coltog-drop{display:none;position:absolute;right:0;top:calc(100% + 5px);background:var(--surface2);border:1px solid var(--border);border-radius:var(--radius);padding:9px;z-index:200;min-width:165px;box-shadow:var(--shadow);max-height:200px;overflow-y:auto}
.coltog-drop.open{display:block}
.coltog-item{display:flex;align-items:center;gap:7px;padding:4px 3px;cursor:pointer;border-radius:5px;font-size:10px;color:var(--text2);font-family:'DM Mono',monospace}
.coltog-item:hover{background:var(--surface3)}
.coltog-item input[type=checkbox]{accent-color:var(--accent);width:12px;height:12px;cursor:pointer}
.prev-table-wrap{overflow-x:auto;border-radius:var(--radius);border:1px solid var(--border)}
.prev-table{width:100%;border-collapse:collapse;font-size:11px}
.prev-table th{background:var(--surface2);color:var(--text3);font-size:9px;font-weight:600;letter-spacing:.06em;text-transform:uppercase;padding:7px 10px;text-align:left;border-bottom:1px solid var(--border);white-space:nowrap;font-family:'DM Mono',monospace;cursor:pointer;position:sticky;top:0;z-index:1;user-select:none}
.prev-table th:hover{color:var(--accent)}
.prev-table th.sort-asc::after{content:' ‚Üë';color:var(--accent)}
.prev-table th.sort-desc::after{content:' ‚Üì';color:var(--accent)}
.prev-table td{padding:6px 10px;border-bottom:1px solid rgba(99,179,237,.05);color:var(--text2);white-space:nowrap;max-width:140px;overflow:hidden;text-overflow:ellipsis}
.prev-table tr:last-child td{border-bottom:none}
.prev-table tr:hover td{background:rgba(56,189,248,.03)}
.prev-table td.rn,.prev-table th.rn{color:var(--text3);font-family:'DM Mono',monospace;font-size:9px;width:36px;text-align:right;padding-right:12px}
.pg-bar{display:flex;align-items:center;justify-content:space-between;padding:9px 12px;background:var(--surface2);border-top:1px solid var(--border);border-radius:0 0 var(--radius) var(--radius);flex-wrap:wrap;gap:7px}
.pg-info{font-size:10px;color:var(--text3);font-family:'DM Mono',monospace}
.pg-info strong{color:var(--accent)}
.pg-btns{display:flex;align-items:center;gap:3px}
.pg-btn{padding:4px 9px;background:var(--surface3);border:1px solid var(--border);border-radius:6px;color:var(--text2);font-size:10px;cursor:pointer;transition:all .15s;font-family:'DM Sans',sans-serif;min-width:30px;text-align:center}
.pg-btn:hover:not(:disabled){background:rgba(56,189,248,.15);border-color:var(--accent);color:var(--accent)}
.pg-btn:disabled{opacity:.3;cursor:not-allowed}
.pg-btn.active{background:var(--accent);border-color:var(--accent);color:#0a0f1a;font-weight:700}
.pg-btn.ellip{background:transparent;border-color:transparent;cursor:default;color:var(--text3)}
.pg-size{padding:4px 7px;background:var(--surface3);border:1px solid var(--border);border-radius:6px;color:var(--text2);font-size:10px;outline:none;cursor:pointer}
.pg-size:focus{border-color:var(--accent)}

/* CHAT */
.sidebar-right{background:var(--surface);border-left:1px solid var(--border);display:flex;flex-direction:column;overflow:hidden}
.section-head{padding:12px 16px;border-bottom:1px solid var(--border);display:flex;align-items:center;justify-content:space-between;flex-shrink:0}
.section-title{font-size:10px;font-weight:600;letter-spacing:.1em;color:var(--text3);text-transform:uppercase}
.chat-msgs{flex:1;overflow-y:auto;overflow-x:hidden;padding:14px;display:flex;flex-direction:column;gap:10px;min-height:0}
.chat-msgs::-webkit-scrollbar{width:3px}
.chat-msgs::-webkit-scrollbar-thumb{background:var(--border)}
.msg{max-width:90%;animation:slideIn .25s ease}
.msg-user{align-self:flex-end}
.msg-ai{align-self:flex-start}
.msg-bubble{padding:9px 13px;border-radius:14px;font-size:12px;line-height:1.6}
.msg-user .msg-bubble{background:linear-gradient(135deg,var(--accent),#0ea5e9);color:#fff;border-bottom-right-radius:3px}
.msg-ai .msg-bubble{background:var(--surface2);color:var(--text);border-bottom-left-radius:3px;border:1px solid var(--border)}
.msg-ai .msg-bubble code{background:var(--surface3);padding:1px 4px;border-radius:3px;font-family:'DM Mono',monospace;font-size:10px;color:var(--accent)}
.msg-time{font-size:9px;color:var(--text3);margin-top:3px;padding:0 3px}
.msg-user .msg-time{text-align:right}
.chat-input-area{padding:10px 14px;border-top:1px solid var(--border);flex-shrink:0}
.quick-btns{display:flex;gap:5px;flex-wrap:wrap;margin-bottom:8px}
.q-btn{padding:3px 9px;background:var(--surface2);border:1px solid var(--border);border-radius:20px;font-size:10px;color:var(--text3);cursor:pointer;transition:all .15s;font-family:'DM Sans',sans-serif}
.q-btn:hover{border-color:var(--accent);color:var(--accent)}
.chat-row{display:flex;gap:7px;align-items:flex-end}
.chat-row textarea{flex:1;padding:9px 12px;background:var(--surface2);border:1px solid var(--border);border-radius:var(--radius);color:var(--text);font-size:12px;font-family:'DM Sans',sans-serif;outline:none;resize:none;max-height:90px;min-height:38px;line-height:1.5;transition:border-color .2s}
.chat-row textarea:focus{border-color:var(--accent)}
.chat-row textarea::placeholder{color:var(--text3)}
.send-btn{width:38px;height:38px;border:none;border-radius:var(--radius);background:linear-gradient(135deg,var(--accent),#0ea5e9);color:#fff;font-size:15px;cursor:pointer;transition:all .2s;display:flex;align-items:center;justify-content:center;flex-shrink:0}
.send-btn:hover{transform:scale(1.05)}
.send-btn:disabled{opacity:.5;cursor:not-allowed}

/* LOADING */
.loading-dots{display:inline-flex;gap:4px;padding:4px 0}
.loading-dots span{width:6px;height:6px;border-radius:50%;background:var(--accent);animation:bounce 1.2s infinite}
.loading-dots span:nth-child(2){animation-delay:.2s}
.loading-dots span:nth-child(3){animation-delay:.4s}
@keyframes bounce{0%,80%,100%{transform:scale(.6);opacity:.5}40%{transform:scale(1);opacity:1}}
.notif{position:fixed;bottom:20px;left:50%;transform:translateX(-50%) translateY(100px);background:var(--surface2);border:1px solid var(--border);color:var(--text);padding:10px 18px;border-radius:var(--radius);font-size:12px;z-index:9999;transition:transform .3s;box-shadow:var(--shadow);display:flex;align-items:center;gap:7px}
.notif.show{transform:translateX(-50%) translateY(0)}
.notif.success{border-color:rgba(52,211,153,.4)}
.notif.error{border-color:rgba(248,113,113,.4)}
.loading-overlay{display:none;position:fixed;inset:0;background:rgba(10,15,26,.7);z-index:500;align-items:center;justify-content:center;backdrop-filter:blur(4px)}
.loading-overlay.active{display:flex}
.loading-card{background:var(--surface);border:1px solid var(--border);border-radius:var(--radius-lg);padding:28px 36px;text-align:center;box-shadow:var(--shadow)}
.loading-spinner{width:40px;height:40px;border:3px solid var(--border);border-top-color:var(--accent);border-radius:50%;animation:spin .8s linear infinite;margin:0 auto 14px}
@keyframes spin{to{transform:rotate(360deg)}}
.loading-text{font-size:13px;color:var(--text2)}
.loading-sub{font-size:11px;color:var(--text3);margin-top:5px}

/* MEDICAL IMAGING */
.img-type-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(120px,1fr));gap:8px;margin-bottom:14px}
.img-type-card{padding:12px 10px;border:2px solid var(--border);border-radius:var(--radius);cursor:pointer;transition:all .2s;text-align:center;background:var(--surface2)}
.img-type-card:hover{border-color:var(--accent);background:rgba(56,189,248,.06)}
.img-type-card.sel{border-color:var(--accent);background:rgba(56,189,248,.12)}
.img-type-icon{font-size:24px;margin-bottom:5px}
.img-type-lbl{font-size:11px;font-weight:600;color:var(--text2)}
.img-type-sub{font-size:9px;color:var(--text3);margin-top:2px}
.img-upload{border:2px dashed var(--border);border-radius:var(--radius);padding:28px 20px;text-align:center;cursor:pointer;transition:all .2s;position:relative;background:var(--surface2);margin-bottom:14px}
.img-upload:hover,.img-upload.over{border-color:var(--accent);background:rgba(56,189,248,.06)}
.img-upload input{position:absolute;inset:0;opacity:0;cursor:pointer}
.img-work{display:none;gap:14px}
.img-work.on{display:grid;grid-template-columns:1fr 1fr}
.img-preview-box{background:var(--surface2);border:1px solid var(--border);border-radius:var(--radius);overflow:hidden;position:relative}
.img-preview-box img{width:100%;max-height:300px;object-fit:contain;display:block;background:#000}
.img-overlay-lbl{position:absolute;top:7px;left:7px;background:rgba(10,15,26,.8);border:1px solid var(--border);border-radius:7px;padding:3px 9px;font-size:10px;color:var(--accent);font-family:'DM Mono',monospace}
.img-toolbar{padding:9px 12px;display:flex;gap:6px;border-top:1px solid var(--border);background:var(--surface);flex-wrap:wrap}
.img-tbtn{padding:4px 10px;background:var(--surface2);border:1px solid var(--border);border-radius:7px;color:var(--text3);font-size:10px;cursor:pointer;transition:all .15s;font-family:'DM Sans',sans-serif}
.img-tbtn:hover{border-color:var(--accent);color:var(--accent)}
.img-findings-box{background:var(--surface2);border:1px solid var(--border);border-radius:var(--radius);display:flex;flex-direction:column;max-height:460px}
.img-findings-hdr{padding:10px 14px;border-bottom:1px solid var(--border);font-size:11px;font-weight:600;color:var(--text2);display:flex;align-items:center;gap:7px;background:var(--surface);flex-shrink:0;border-radius:var(--radius) var(--radius) 0 0}
.img-findings-body{flex:1;padding:14px;overflow-y:auto;font-size:12px;color:var(--text2);line-height:1.7;min-height:0}
.img-findings-body::-webkit-scrollbar{width:3px}
.img-findings-body::-webkit-scrollbar-thumb{background:var(--border)}
.finding{display:flex;gap:9px;padding:9px 11px;border-radius:var(--radius);margin-bottom:7px;border:1px solid transparent;animation:slideIn .3s ease}
.finding.normal{background:rgba(52,211,153,.08);border-color:rgba(52,211,153,.2)}
.finding.warning{background:rgba(251,191,36,.08);border-color:rgba(251,191,36,.2)}
.finding.critical{background:rgba(248,113,113,.08);border-color:rgba(248,113,113,.2)}
.finding.info{background:rgba(56,189,248,.08);border-color:rgba(56,189,248,.15)}
.finding-icon{font-size:14px;flex-shrink:0}
.finding-body{flex:1}
.finding-lbl{font-size:10px;font-weight:700;letter-spacing:.05em;text-transform:uppercase;margin-bottom:2px}
.finding-desc{font-size:11px;color:var(--text2)}
.conf-row2{display:flex;align-items:center;gap:7px;margin-top:5px}
.conf-lbl2{color:var(--text3);width:65px;font-family:'DM Mono',monospace;font-size:9px}
.conf-track2{flex:1;height:5px;background:var(--surface3);border-radius:3px;overflow:hidden}
.conf-fill2{height:100%;border-radius:3px;transition:width 1s ease}
.conf-pct2{font-family:'DM Mono',monospace;font-size:10px;color:var(--text2);width:30px;text-align:right}
.img-ask-area{padding:10px 14px;border-top:1px solid var(--border);display:flex;gap:7px;flex-shrink:0}
.img-ask-area input{flex:1;padding:7px 10px;background:var(--surface3);border:1px solid var(--border);border-radius:var(--radius);color:var(--text);font-size:11px;outline:none;font-family:'DM Sans',sans-serif}
.img-ask-area input:focus{border-color:var(--accent)}
.img-ask-area input::placeholder{color:var(--text3)}
.img-disclaimer{margin-top:10px;padding:9px 11px;background:rgba(251,191,36,.06);border:1px solid rgba(251,191,36,.2);border-radius:var(--radius);font-size:10px;color:var(--text3);line-height:1.5}

/* ‚ïê‚ïê‚ïê 6 NEW FEATURE STYLES ‚ïê‚ïê‚ïê */
/* Patient Dashboard */
.patient-value-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(190px,1fr));gap:8px}
.pv-card{padding:11px 13px;background:var(--surface2);border-radius:var(--radius);border:1px solid var(--border);position:relative;overflow:hidden;transition:border-color .2s}
.pv-card.feat{border-left:3px solid var(--accent)}
.pv-card.tgt{border-left:3px solid var(--accent3)}
.pv-card.outlier{border-left:3px solid var(--danger);background:rgba(248,113,113,.05)}
.pv-label{font-size:9px;color:var(--text3);font-family:'DM Mono',monospace;text-transform:uppercase;letter-spacing:.05em;margin-bottom:4px}
.pv-value{font-size:16px;font-weight:700;color:var(--text);font-family:'DM Mono',monospace}
.pv-pct{font-size:9px;color:var(--text3);margin-top:3px}
.pv-bar{height:3px;background:var(--surface3);border-radius:2px;margin-top:5px;overflow:hidden}
.pv-bar-fill{height:100%;border-radius:2px;background:var(--accent)}
.pv-bar-fill.hi{background:var(--danger)}
.pv-bar-fill.lo{background:var(--accent2)}
.risk-ring{width:80px;height:80px;border-radius:50%;display:flex;align-items:center;justify-content:center;flex-direction:column;flex-shrink:0;border:4px solid var(--border)}
.risk-ring.HIGH{border-color:var(--danger);background:rgba(248,113,113,.08)}
.risk-ring.MEDIUM{border-color:var(--warn);background:rgba(251,191,36,.07)}
.risk-ring.LOW{border-color:var(--accent2);background:rgba(52,211,153,.07)}
.sim-mini-table{width:100%;border-collapse:collapse;font-size:11px}
.sim-mini-table td,.sim-mini-table th{padding:6px 9px;border-bottom:1px solid rgba(99,179,237,.07)}
.sim-mini-table th{font-size:9px;color:var(--text3);text-transform:uppercase;letter-spacing:.05em;font-weight:600;background:var(--surface2)}
/* Survival */
.km-group-legend{display:flex;gap:12px;flex-wrap:wrap;margin-bottom:10px}
.km-legend-dot{width:10px;height:10px;border-radius:50%;display:inline-block;flex-shrink:0}
.survival-stat-row{display:flex;gap:10px;margin-bottom:14px;flex-wrap:wrap}
/* Multi-target */
.mt-result-card{padding:14px;background:var(--surface2);border-radius:var(--radius);border:1px solid var(--border);margin-bottom:8px;display:flex;align-items:center;gap:14px;transition:border-color .2s}
.mt-result-card.rank1{border-color:rgba(52,211,153,.4);background:rgba(52,211,153,.04)}
.mt-rank{width:28px;height:28px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:11px;font-weight:700;flex-shrink:0}
.mt-rank.r1{background:rgba(52,211,153,.2);color:var(--accent2)}
.mt-rank.r2{background:rgba(56,189,248,.15);color:var(--accent)}
.mt-rank.rn{background:var(--surface3);color:var(--text3)}
.mt-perf-bar{flex:1;height:6px;background:var(--surface3);border-radius:3px;overflow:hidden}
.mt-perf-fill{height:100%;border-radius:3px;background:linear-gradient(90deg,var(--accent2),var(--accent))}
/* Alert Rules */
.rule-builder{background:var(--surface2);border-radius:var(--radius);padding:14px;margin-bottom:10px;border:1px solid var(--border)}
.rule-row{display:grid;grid-template-columns:1fr 120px 70px 100px 1fr auto;gap:7px;align-items:center;margin-bottom:7px}
.alert-triggered{display:flex;align-items:center;gap:10px;padding:10px 13px;border-radius:var(--radius);margin-bottom:7px;border:1px solid transparent;animation:slideIn .3s ease}
.alert-triggered.critical{background:rgba(248,113,113,.08);border-color:rgba(248,113,113,.25)}
.alert-triggered.warning{background:rgba(251,191,36,.07);border-color:rgba(251,191,36,.2)}
.alert-triggered.info{background:rgba(56,189,248,.06);border-color:rgba(56,189,248,.15)}
.alert-triggered.clear{background:rgba(52,211,153,.05);border-color:rgba(52,211,153,.18)}
.alert-pct-bar{width:70px;height:5px;background:var(--surface3);border-radius:3px;overflow:hidden;display:inline-block;vertical-align:middle;margin-left:5px}
.alert-pct-fill{height:100%;border-radius:3px}
/* Dataset Compare */
.compare-col-row{display:grid;grid-template-columns:140px 1fr 1fr 90px 80px;gap:8px;align-items:center;padding:8px 10px;border-radius:8px;margin-bottom:4px;font-size:11px}
.compare-col-row:nth-child(even){background:rgba(56,189,248,.02)}
.compare-col-row.sig{background:rgba(251,191,36,.06)}
.compare-bar-wrap{display:flex;align-items:center;gap:5px}
.compare-bar{height:5px;border-radius:3px;flex:1;background:var(--surface3);overflow:hidden}
.compare-bar-a{height:100%;border-radius:3px;background:var(--accent)}
.compare-bar-b{height:100%;border-radius:3px;background:var(--accent3)}
/* ICD Coding */
.icd-badge{font-family:'DM Mono',monospace;font-size:10px;font-weight:700;padding:3px 8px;border-radius:7px;background:rgba(56,189,248,.15);color:var(--accent);border:1px solid rgba(56,189,248,.3)}
.drug-flag{padding:10px 13px;border-radius:var(--radius);margin-bottom:7px;display:flex;align-items:flex-start;gap:10px;animation:slideIn .3s ease}
.drug-flag.HIGH{background:rgba(248,113,113,.08);border:1px solid rgba(248,113,113,.25)}
.drug-flag.MEDIUM{background:rgba(251,191,36,.07);border:1px solid rgba(251,191,36,.2)}
.coding-rec{padding:9px 13px;background:var(--surface2);border-radius:var(--radius);margin-bottom:6px;border-left:3px solid var(--accent);font-size:12px;color:var(--text2);line-height:1.6}
.coding-rec.gap{border-left-color:var(--warn)}
.coding-rec.note{border-left-color:var(--accent3)}
.insight-narrative{padding:16px 18px;background:linear-gradient(135deg,rgba(56,189,248,.06),rgba(52,211,153,.04));border:1px solid rgba(56,189,248,.2);border-radius:var(--radius-lg);font-size:13px;color:var(--text2);line-height:1.9;margin-bottom:14px;border-left:4px solid var(--accent);position:relative}
.insight-narrative::before{content:'üí°';position:absolute;top:14px;right:14px;font-size:18px;opacity:.4}
.obs-list{list-style:none;padding:0;display:flex;flex-direction:column;gap:8px}
.obs-item{display:flex;align-items:flex-start;gap:10px;padding:10px 13px;background:var(--surface2);border-radius:var(--radius);border-left:3px solid var(--accent2);font-size:12px;color:var(--text2);line-height:1.6}
.obs-item.risk{border-left-color:var(--danger)}
.obs-item.rec{border-left-color:var(--accent3)}
.obs-item.warn{border-left-color:var(--warn)}
.obs-icon{font-size:14px;flex-shrink:0;margin-top:1px}
.conf-pill{display:inline-flex;align-items:center;gap:5px;padding:4px 10px;border-radius:20px;font-size:10px;font-weight:700;letter-spacing:.05em;text-transform:uppercase}
.conf-high{background:rgba(52,211,153,.15);color:var(--accent2);border:1px solid rgba(52,211,153,.3)}
.conf-med{background:rgba(251,191,36,.1);color:var(--warn);border:1px solid rgba(251,191,36,.25)}
.conf-low{background:rgba(248,113,113,.1);color:var(--danger);border:1px solid rgba(248,113,113,.25)}
/* Quality */
.quality-score-ring{width:90px;height:90px;border-radius:50%;display:flex;align-items:center;justify-content:center;flex-direction:column;flex-shrink:0;font-family:'DM Mono',monospace}
.quality-issue-row{display:flex;align-items:flex-start;gap:9px;padding:9px 12px;border-radius:var(--radius);margin-bottom:6px;animation:slideIn .3s ease}
.quality-issue-row.critical{background:rgba(248,113,113,.07);border:1px solid rgba(248,113,113,.2)}
.quality-issue-row.warning{background:rgba(251,191,36,.06);border:1px solid rgba(251,191,36,.18)}
.quality-issue-row.passed{background:rgba(52,211,153,.06);border:1px solid rgba(52,211,153,.18)}
.quality-col-table{width:100%;border-collapse:collapse;font-size:11px}
.quality-col-table th{background:var(--surface2);color:var(--text3);font-size:9px;font-weight:600;letter-spacing:.06em;text-transform:uppercase;padding:7px 10px;text-align:left;border-bottom:1px solid var(--border);font-family:'DM Mono',monospace}
.quality-col-table td{padding:7px 10px;border-bottom:1px solid rgba(99,179,237,.05);color:var(--text2)}
.quality-col-table tr:hover td{background:rgba(56,189,248,.03)}
.miss-bar-track{width:80px;height:5px;background:var(--surface3);border-radius:3px;overflow:hidden;display:inline-block;vertical-align:middle}
.miss-bar-fill{height:100%;border-radius:3px}
/* Privacy */
.phi-card{padding:13px 15px;border-radius:var(--radius);margin-bottom:7px;border:1px solid transparent;animation:slideIn .3s ease;display:flex;align-items:flex-start;gap:12px}
.phi-card.high{background:rgba(248,113,113,.07);border-color:rgba(248,113,113,.25)}
.phi-card.medium{background:rgba(251,191,36,.06);border-color:rgba(251,191,36,.2)}
.phi-card.safe{background:rgba(52,211,153,.06);border-color:rgba(52,211,153,.2)}
.phi-icon{font-size:20px;flex-shrink:0}
.phi-body{flex:1}
.phi-col{font-family:'DM Mono',monospace;font-size:12px;font-weight:600;color:var(--text);margin-bottom:3px}
.phi-meta{font-size:10px;color:var(--text3)}
.phi-risk-badge{font-size:9px;font-weight:700;padding:2px 7px;border-radius:9px;text-transform:uppercase;letter-spacing:.05em;flex-shrink:0;margin-top:2px}
.phi-risk-high{background:rgba(248,113,113,.2);color:var(--danger)}
.phi-risk-med{background:rgba(251,191,36,.15);color:var(--warn)}
.compliance-meter{height:10px;background:var(--surface2);border-radius:5px;overflow:hidden;margin-top:6px}
.compliance-fill{height:100%;border-radius:5px;transition:width 1s ease}
.anon-method-grid{display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-bottom:14px}
.anon-method-card{padding:12px;border:2px solid var(--border);border-radius:var(--radius);cursor:pointer;transition:all .2s;background:var(--surface2)}
.anon-method-card:hover,.anon-method-card.sel{border-color:var(--accent);background:rgba(56,189,248,.06)}
.anon-method-card.sel{border-color:var(--accent3)}
.anon-method-icon{font-size:20px;margin-bottom:4px}
.anon-method-name{font-size:11px;font-weight:600;color:var(--text);margin-bottom:2px}
.anon-method-desc{font-size:9px;color:var(--text3);line-height:1.5}
/* Report */
.report-preview{background:var(--surface2);border:1px solid var(--border);border-radius:var(--radius-lg);overflow:hidden}
.report-preview-bar{padding:10px 14px;background:var(--surface);border-bottom:1px solid var(--border);display:flex;align-items:center;gap:8px;font-size:11px;color:var(--text3)}
.report-preview-frame{width:100%;height:500px;border:none;background:#fff}
/* Risk alert pills */
.risk-alert{display:flex;align-items:flex-start;gap:10px;padding:10px 13px;border-radius:var(--radius);margin-bottom:7px;border:1px solid transparent;animation:slideIn .3s ease}
.risk-alert.critical{background:rgba(248,113,113,.08);border-color:rgba(248,113,113,.25)}
.risk-alert.warning{background:rgba(251,191,36,.07);border-color:rgba(251,191,36,.2)}
.risk-alert.low{background:rgba(56,189,248,.06);border-color:rgba(56,189,248,.15)}
.risk-alert-icon{font-size:16px;flex-shrink:0;margin-top:1px}
.risk-alert-body{flex:1}
.risk-alert-lbl{font-size:10px;font-weight:700;letter-spacing:.05em;text-transform:uppercase;margin-bottom:2px}
.risk-alert.critical .risk-alert-lbl{color:var(--danger)}
.risk-alert.warning .risk-alert-lbl{color:var(--warn)}
.risk-alert.low .risk-alert-lbl{color:var(--accent)}
.risk-alert-msg{font-size:11px;color:var(--text2)}
.risk-alert-pct{font-family:'DM Mono',monospace;font-size:12px;font-weight:600;flex-shrink:0}
.risk-alert.critical .risk-alert-pct{color:var(--danger)}
.risk-alert.warning .risk-alert-pct{color:var(--warn)}
/* XAI contribution bars */
.contrib-row{display:flex;align-items:center;gap:8px;margin-bottom:7px}
.contrib-lbl{font-family:'DM Mono',monospace;font-size:10px;color:var(--text2);width:110px;flex-shrink:0;overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
.contrib-track{flex:1;height:8px;background:var(--surface2);border-radius:4px;overflow:hidden;position:relative}
.contrib-fill-pos{height:100%;background:linear-gradient(90deg,var(--accent2),#10b981);border-radius:4px;transition:width .8s ease}
.contrib-fill-neg{height:100%;background:linear-gradient(90deg,var(--danger),#fb7185);border-radius:4px;transition:width .8s ease}
.contrib-val{font-size:9px;color:var(--text3);width:50px;text-align:right;font-family:'DM Mono',monospace}
/* Similarity table */
.sim-table{width:100%;border-collapse:collapse;font-size:11px}
.sim-table th{background:var(--surface2);color:var(--text3);font-size:9px;font-weight:600;letter-spacing:.06em;text-transform:uppercase;padding:7px 10px;text-align:left;border-bottom:1px solid var(--border);white-space:nowrap;font-family:'DM Mono',monospace}
.sim-table td{padding:6px 10px;border-bottom:1px solid rgba(99,179,237,.05);color:var(--text2);white-space:nowrap}
.sim-table tr:hover td{background:rgba(56,189,248,.03)}
.sim-score-bar{display:inline-flex;align-items:center;gap:5px}
.sim-score-track{width:50px;height:5px;background:var(--surface3);border-radius:3px;overflow:hidden}
.sim-score-fill{height:100%;background:linear-gradient(90deg,var(--accent3),var(--accent));border-radius:3px}
/* Cohort comparison bars */
.cohort-row{display:flex;align-items:center;gap:8px;margin-bottom:10px;padding-bottom:10px;border-bottom:1px solid var(--border)}
.cohort-row:last-child{border-bottom:none;margin-bottom:0;padding-bottom:0}
.cohort-lbl{font-family:'DM Mono',monospace;font-size:10px;color:var(--text2);width:100px;flex-shrink:0}
.cohort-bars{flex:1;display:flex;flex-direction:column;gap:3px}
.cohort-bar-row{display:flex;align-items:center;gap:5px}
.cohort-bar-lbl{font-size:9px;color:var(--text3);width:55px;flex-shrink:0}
.cohort-track{flex:1;height:5px;background:var(--surface3);border-radius:3px;overflow:hidden}
.cohort-fill-pop{height:100%;background:rgba(56,189,248,.5);border-radius:3px}
.cohort-fill-coh{height:100%;background:var(--accent3);border-radius:3px;opacity:.85}
.cohort-fill-qry{height:100%;background:var(--accent2);border-radius:3px}
.cohort-val{font-family:'DM Mono',monospace;font-size:9px;color:var(--text3);width:45px;text-align:right}
/* Trend chart cards */
.trend-chart-card{background:var(--surface);border:1px solid var(--border);border-radius:var(--radius-lg);padding:14px;animation:slideIn .3s ease}
.trend-direction-badge{display:inline-flex;align-items:center;gap:4px;font-size:9px;font-weight:700;padding:2px 8px;border-radius:9px;text-transform:uppercase;letter-spacing:.05em}
.trend-up{background:rgba(248,113,113,.15);color:var(--danger)}
.trend-down{background:rgba(52,211,153,.12);color:var(--accent2)}
.trend-stable{background:rgba(251,191,36,.1);color:var(--warn)}
/* Corr matrix */
.corr-table{border-collapse:collapse;font-size:10px}
.corr-table th,.corr-table td{padding:5px 8px;text-align:center;font-family:'DM Mono',monospace;border:1px solid var(--border);white-space:nowrap}
.corr-table th{background:var(--surface2);color:var(--text3);font-size:9px}
/* Query patient chips */
.qp-grid{display:flex;flex-wrap:wrap;gap:7px}
.qp-chip{background:var(--surface2);border:1px solid var(--border);border-radius:var(--radius);padding:7px 11px;display:flex;flex-direction:column;gap:2px;min-width:100px}
.qp-chip-lbl{font-size:9px;color:var(--text3);font-family:'DM Mono',monospace}
.qp-chip-val{font-size:13px;color:var(--accent);font-family:'DM Mono',monospace;font-weight:600}
</style>
</head>
<body>

<div class="loading-overlay" id="loadingOverlay">
  <div class="loading-card">
    <div class="loading-spinner"></div>
    <div class="loading-text" id="loadingText">Processing...</div>
    <div class="loading-sub" id="loadingSubText">Please wait</div>
  </div>
</div>
<div class="notif" id="notif"></div>

<header class="header">
  <div class="logo">
    <div class="logo-icon">üè•</div>
    <div><div class="logo-text">HealthAI</div><div class="logo-sub">Intelligent Healthcare Analytics</div></div>
  </div>
  <div class="header-right">
    <span class="badge-free">‚ù§ VIRENKUAMR MANIYA</span>
    <div class="status-dot"><div class="dot"></div><span>AI Ready</span></div>
  </div>
</header>

<div class="layout">

<!-- ‚ïê‚ïê‚ïê‚ïê LEFT SIDEBAR ‚ïê‚ïê‚ïê‚ïê -->
<aside class="sidebar-left">

  <div class="panel">
    <div class="panel-title">üìÇ Data Source</div>
    <div class="tab-group">
      <button class="tab-btn active" onclick="switchSrcTab('excel')">üìä Excel/CSV</button>
      <button class="tab-btn" onclick="switchSrcTab('sql')">üóÑ SQL</button>
    </div>
    <div id="tab-excel">
      <div class="upload-zone" id="uploadZone">
        <input type="file" id="fileInput" accept=".xlsx,.xls,.csv">
        <div style="font-size:24px;margin-bottom:6px">üìã</div>
        <div style="font-size:11px;color:var(--text3);line-height:1.5"><strong style="color:var(--accent)">Click to upload</strong> or drag & drop<br>Excel (.xlsx, .xls) or CSV</div>
      </div>
    </div>
    <div id="tab-sql" style="display:none">
      <input class="input-field" id="sqlConn" placeholder="mssql+pyodbc://user:pass@server/db?driver=ODBC+Driver+17+for+SQL+Server" style="font-size:9px;height:50px">
      <textarea class="input-field" id="sqlQuery" rows="3" placeholder="SELECT * FROM patients"></textarea>
      <button class="btn btn-primary" onclick="connectSQL()">üîå Connect & Load</button>
    </div>
    <div id="dataset-info">
      <div class="ds-stat">üìÑ File <strong id="ds-file">‚Äî</strong></div>
      <div class="ds-stat">üìä Rows <strong id="ds-rows">‚Äî</strong></div>
      <div class="ds-stat">üè∑ Cols <strong id="ds-cols">‚Äî</strong></div>
      <button class="btn btn-danger" style="margin-top:7px;width:100%;justify-content:center" onclick="clearSession()">üóë Clear Session</button>
    </div>
  </div>

  <div class="panel" id="column-panel">
    <div class="panel-title">üéõ Column Selector</div>
    <div class="sel-legend">
      <div class="legend-item"><div class="legend-dot" style="background:var(--accent)"></div>Click once = Feature</div>
      <div class="legend-item"><div class="legend-dot" style="background:var(--accent3)"></div>Click twice = Target</div>
    </div>
    <div class="col-search"><input type="text" placeholder="Search columns..." oninput="filterCols(this.value)"></div>
    <div class="col-list" id="colList"></div>
    <div class="sel-summary" id="selSummary">Select feature columns above</div>
  </div>

  <div class="panel" id="analysis-panel">
    <div class="panel-title">‚öôÔ∏è Analysis Settings</div>
    <span class="cfg-label">Task Type</span>
    <select class="cfg-select" id="taskType" onchange="updateTaskUI()">
      <option value="auto">ü§ñ Auto Detect</option>
      <option value="regression">üìà Regression</option>
      <option value="classification">üè∑ Classification</option>
      <option value="clustering">üîµ Clustering</option>
    </select>
    <span class="cfg-label">ML Model</span>
    <select class="cfg-select" id="modelType">
      <option value="random_forest">üå≤ Random Forest</option>
      <option value="linear">üìä Linear / Logistic</option>
      <option value="gradient_boost">üöÄ Gradient Boost</option>
    </select>
    <div id="clusterCfg" style="display:none">
      <span class="cfg-label">Number of Clusters</span>
      <input class="cfg-select" id="nClusters" type="number" min="2" max="10" value="3">
    </div>
    <button class="btn btn-success" onclick="runAnalysis()">‚ñ∂ Run Analysis</button>
  </div>

</aside>

<!-- ‚ïê‚ïê‚ïê‚ïê MAIN ‚ïê‚ïê‚ïê‚ïê -->
<main class="main">

  <div class="main-tabs" id="mainTabs">
    <button class="tab-arrow" id="tabArrowLeft" onclick="scrollTabs(-1)" title="Scroll left">‚Äπ</button>
    <div class="tabs-scroll" id="tabsScroll">
      <!-- GROUP 1: Core -->
      <button class="mtab active" onclick="switchTab('analytics')" id="mtab-analytics" data-group="core">üìä Analytics</button>
      <button class="mtab" onclick="switchTab('preview')" id="mtab-preview" data-group="core">üìã Data Preview</button>
      <button class="mtab" onclick="switchTab('imaging')" id="mtab-imaging" data-group="core">üî¨ Medical Imaging</button>
      <div class="tab-group-sep" title="AI Analysis"></div>
      <!-- GROUP 2: AI Analysis -->
      <button class="mtab" onclick="switchTab('xai')" id="mtab-xai" data-group="ai">üß† Explainability</button>
      <button class="mtab" onclick="switchTab('risk')" id="mtab-risk" data-group="ai">‚ö†Ô∏è Risk Engine</button>
      <button class="mtab" onclick="switchTab('trends')" id="mtab-trends" data-group="ai">üìà Trends</button>
      <button class="mtab" onclick="switchTab('similarity')" id="mtab-similarity" data-group="ai">üë• Similarity</button>
      <button class="mtab" onclick="switchTab('insights')" id="mtab-insights" data-group="ai">üí° AI Insights</button>
      <div class="tab-group-sep" title="Clinical Tools"></div>
      <!-- GROUP 3: Clinical -->
      <button class="mtab" onclick="switchTab('quality')" id="mtab-quality" data-group="clinical">üß™ Data Quality</button>
      <button class="mtab" onclick="switchTab('privacy')" id="mtab-privacy" data-group="clinical">üîí Privacy</button>
      <button class="mtab" onclick="switchTab('patient')" id="mtab-patient" data-group="clinical">üßë‚Äç‚öïÔ∏è Patient View</button>
      <button class="mtab" onclick="switchTab('survival')" id="mtab-survival" data-group="clinical">üìâ Survival</button>
      <button class="mtab" onclick="switchTab('coding')" id="mtab-coding" data-group="clinical">üíä ICD Coding</button>
      <div class="tab-group-sep" title="Advanced"></div>
      <!-- GROUP 4: Advanced -->
      <button class="mtab" onclick="switchTab('multitarget')" id="mtab-multitarget" data-group="advanced">üéØ Multi-Target</button>
      <button class="mtab" onclick="switchTab('alerts')" id="mtab-alerts" data-group="advanced">üîî Alert Rules</button>
      <button class="mtab" onclick="switchTab('compare')" id="mtab-compare" data-group="advanced">‚öñÔ∏è Compare</button>
      <button class="mtab" onclick="switchTab('report')" id="mtab-report" data-group="advanced">üìÑ Report</button>
    </div>
    <button class="tab-arrow" id="tabArrowRight" onclick="scrollTabs(1)" title="Scroll right">‚Ä∫</button>
  </div>

  <!-- ANALYTICS TAB -->
  <div class="tpanel active" id="tpanel-analytics">

    <div class="welcome-card" id="welcomeCard">
      <div class="welcome-title">Healthcare AI Intelligence Platform</div>
      <div class="welcome-desc">Upload your healthcare dataset or connect to SQL Server. Select columns, run AI predictions, regression, clustering, explainability, risk detection, trend forecasting, patient similarity ‚Äî and analyze medical images. Free for hospital &amp; healthcare charity.</div>
      <div class="feature-pills">
        <div class="pill">ü§ñ LLM Chat</div>
        <div class="pill">üìà Regression</div>
        <div class="pill">üè∑ Classification</div>
        <div class="pill">üîµ Clustering</div>
        <div class="pill">üéØ Prediction</div>
        <div class="pill">üî¨ Medical Imaging</div>
        <div class="pill">üß† Explainability</div>
        <div class="pill">‚ö†Ô∏è Risk Engine</div>
        <div class="pill">üìà Trends &amp; Forecast</div>
        <div class="pill">üë• Patient Similarity</div>
        <div class="pill">üí° Clinical Insights</div>
        <div class="pill">üß™ Data Quality</div>
        <div class="pill">üìÑ AI Reports</div>
        <div class="pill">üîí PHI Privacy</div>
        <div class="pill">üßë‚Äç‚öïÔ∏è Patient Dashboard</div>
        <div class="pill">üìâ Survival Analysis</div>
        <div class="pill">üéØ Multi-Target</div>
        <div class="pill">üîî Alert Rules</div>
        <div class="pill">‚öñÔ∏è Dataset Compare</div>
        <div class="pill">üíä ICD Coding</div>
      </div>
    </div>

    <div id="ml-result-card" class="result-card" style="display:none">
      <div class="result-header">
        <div class="result-title" id="result-title">Analysis Results</div>
        <span class="result-badge" id="result-badge">‚Äî</span>
      </div>
      <div class="metrics-grid" id="metrics-grid"></div>
      <div style="display:grid;grid-template-columns:1fr 1fr;gap:14px">
        <div>
          <div style="font-size:10px;font-weight:600;color:var(--text3);margin-bottom:6px;letter-spacing:.06em;text-transform:uppercase">Feature Importance</div>
          <div class="feat-bars" id="feat-bars"></div>
        </div>
        <div>
          <div style="font-size:10px;font-weight:600;color:var(--text3);margin-bottom:6px;letter-spacing:.06em;text-transform:uppercase">Actual vs Predicted</div>
          <div class="chart-wrap"><canvas id="predChart"></canvas></div>
        </div>
      </div>
      <div class="predict-form" id="pred-form">
        <div class="predict-title">üéØ Predict for New Patient <span style="font-size:9px;color:var(--text3);font-weight:400;margin-left:auto">Auto-suggested from dataset</span></div>
        <div class="predict-inputs" id="pred-inputs"></div>
        <button class="btn btn-primary btn-sm" onclick="runPrediction()" style="margin-bottom:0">‚ö° Calculate Prediction</button>
        <div class="pred-result" id="pred-result">
          <div class="pred-result-hdr">üè• Predicted Result</div>
          <div class="pred-result-val" id="pred-val">‚Äî</div>
          <div class="conf-row" id="conf-row" style="display:none">
            <div class="conf-track"><div class="conf-fill" id="conf-fill" style="width:0%"></div></div>
            <div class="conf-lbl" id="conf-lbl">0%</div>
          </div>
          <div class="pred-summary" id="pred-summary"></div>
        </div>
      </div>
    </div>

    <div id="cluster-result-card" class="result-card" style="display:none">
      <div class="result-header">
        <div class="result-title">üîµ Clustering Analysis</div>
        <span class="result-badge badge-clu">K-MEANS</span>
      </div>
      <div class="metrics-grid" id="cluster-metrics"></div>
      <div class="chart-wrap" style="height:200px"><canvas id="clusterChart"></canvas></div>
    </div>

  </div>

  <!-- DATA PREVIEW TAB -->
  <div class="tpanel" id="tpanel-preview">
    <div class="result-card">
      <div class="result-header">
        <div class="result-title">üìã Data Preview</div>
        <span style="font-size:11px;color:var(--text3)" id="prev-stats"></span>
      </div>
      <div class="preview-toolbar">
        <div class="prev-search">
          <input type="text" id="prevSearch" placeholder="Search across all columns..." oninput="onSearch(this.value)">
        </div>
        <div style="position:relative">
          <button class="coltog-btn" onclick="toggleColDrop()">‚öô Columns</button>
          <div class="coltog-drop" id="colTogDrop"></div>
        </div>
      </div>
      <div class="prev-table-wrap">
        <table class="prev-table">
          <thead id="prevHead"></thead>
          <tbody id="prevBody"></tbody>
        </table>
      </div>
      <div class="pg-bar">
        <div style="display:flex;align-items:center;gap:7px">
          <span class="pg-info" id="pg-info">‚Äî</span>
          <select class="pg-size" onchange="changePageSize(this.value)">
            <option value="10">10/page</option>
            <option value="25">25/page</option>
            <option value="50">50/page</option>
            <option value="100">100/page</option>
          </select>
        </div>
        <div class="pg-btns" id="pg-btns"></div>
      </div>
    </div>
  </div>

  <!-- MEDICAL IMAGING TAB -->
  <div class="tpanel" id="tpanel-imaging">

    <div class="result-card" style="position:relative;overflow:hidden;margin-bottom:14px">
      <div style="position:absolute;top:0;left:0;right:0;height:3px;background:linear-gradient(90deg,var(--accent),var(--accent3),var(--accent2))"></div>
      <div style="font-family:'Playfair Display',serif;font-size:20px;font-weight:700;margin-bottom:6px">üî¨ Medical Imaging AI Analysis</div>
      <div style="font-size:12px;color:var(--text3);margin-bottom:14px;line-height:1.6">Upload X-Ray, CT Scan, Sonography, MRI or Dermatology images for AI-assisted findings detection.</div>
      <div style="font-size:9px;color:var(--text3);font-weight:600;text-transform:uppercase;letter-spacing:.08em;margin-bottom:8px">Select Scan Type</div>
      <div class="img-type-grid">
        <div class="img-type-card sel" onclick="selImgType('xray',this)"><div class="img-type-icon">ü´Å</div><div class="img-type-lbl">X-Ray</div><div class="img-type-sub">Chest ¬∑ Bone ¬∑ Spine</div></div>
        <div class="img-type-card" onclick="selImgType('ct',this)"><div class="img-type-icon">üß†</div><div class="img-type-lbl">CT Scan</div><div class="img-type-sub">Brain ¬∑ Abdomen</div></div>
        <div class="img-type-card" onclick="selImgType('sono',this)"><div class="img-type-icon">ü´Ä</div><div class="img-type-lbl">Sonography</div><div class="img-type-sub">Abdomen ¬∑ Heart</div></div>
        <div class="img-type-card" onclick="selImgType('mri',this)"><div class="img-type-icon">ü¶¥</div><div class="img-type-lbl">MRI</div><div class="img-type-sub">Brain ¬∑ Spine</div></div>
        <div class="img-type-card" onclick="selImgType('retinal',this)"><div class="img-type-icon">üëÅ</div><div class="img-type-lbl">Retinal</div><div class="img-type-sub">Fundus ¬∑ OCT</div></div>
        <div class="img-type-card" onclick="selImgType('derma',this)"><div class="img-type-icon">ü©π</div><div class="img-type-lbl">Dermatology</div><div class="img-type-sub">Skin ¬∑ Lesions</div></div>
      </div>
    </div>

    <div class="img-upload" id="imgUpload">
      <input type="file" id="imgFile" accept="image/*" onchange="loadImgFile(this.files[0])">
      <div style="font-size:36px;margin-bottom:10px">üì§</div>
      <div style="font-size:12px;color:var(--text3);line-height:1.6"><strong style="color:var(--accent)">Click to upload</strong> or drag & drop<br>JPEG, PNG, WEBP ¬∑ Max 10MB</div>
    </div>

    <div class="img-work" id="imgWork">
      <div>
        <div class="img-preview-box">
          <img id="imgPreview" src="" alt="Medical scan">
          <div class="img-overlay-lbl" id="imgLbl">X-RAY</div>
        </div>
        <div class="img-toolbar">
          <button class="img-tbtn" onclick="changeImgType('xray')">ü´Å X-Ray</button>
          <button class="img-tbtn" onclick="changeImgType('ct')">üß† CT</button>
          <button class="img-tbtn" onclick="changeImgType('sono')">ü´Ä Sono</button>
          <button class="img-tbtn" onclick="changeImgType('mri')">ü¶¥ MRI</button>
          <button class="img-tbtn" onclick="reAnalyze()" style="color:var(--accent2);border-color:rgba(52,211,153,.3)">üîÑ Re-analyse</button>
          <button class="img-tbtn" onclick="clearImage()" style="margin-left:auto;color:var(--danger);border-color:rgba(248,113,113,.3)">üóë Clear Image</button>
        </div>
      </div>
      <div class="img-findings-box">
        <div class="img-findings-hdr">ü§ñ AI Findings <span id="imgBadge" style="margin-left:auto;font-size:9px;background:rgba(56,189,248,.15);color:var(--accent);padding:2px 7px;border-radius:7px;font-weight:600">X-RAY</span></div>
        <div class="img-findings-body" id="imgBody">
          <div style="text-align:center;padding:36px 16px;color:var(--text3)"><div style="font-size:28px;margin-bottom:10px">üîç</div><div style="font-size:12px">Upload a medical image to begin AI analysis</div></div>
        </div>
        <div class="img-ask-area">
          <input type="text" id="imgQ" placeholder="Ask a specific question about this image..." onkeydown="if(event.key==='Enter')askImg()">
          <button class="btn btn-primary btn-sm" onclick="askImg()" style="white-space:nowrap">Ask AI</button>
        </div>
      </div>
    </div>

  </div>

  <!-- ‚ïê‚ïê XAI / EXPLAINABILITY TAB ‚ïê‚ïê -->
  <div class="tpanel" id="tpanel-xai">
    <div class="result-card" style="position:relative;overflow:hidden;margin-bottom:14px">
      <div style="position:absolute;top:0;left:0;right:0;height:3px;background:linear-gradient(90deg,var(--accent),var(--accent3))"></div>
      <div style="font-family:'Playfair Display',serif;font-size:20px;font-weight:700;margin-bottom:6px">üß† Explainable AI ‚Äî Why This Prediction?</div>
      <div style="font-size:12px;color:var(--text3);margin-bottom:14px;line-height:1.6">Understand exactly which features drive predictions. LIME-style per-feature contribution analysis with global importances.</div>
      <div style="display:flex;gap:8px;flex-wrap:wrap">
        <button class="btn btn-primary btn-sm" onclick="runXAI()">‚ñ∂ Run Explainability</button>
        <div style="display:flex;align-items:center;gap:7px;flex:1;min-width:200px">
          <span style="font-size:10px;color:var(--text3);white-space:nowrap">Sample row #</span>
          <input type="number" id="xaiSampleIdx" value="0" min="0" class="cfg-select" style="width:80px;margin-bottom:0">
        </div>
      </div>
    </div>
    <div id="xai-result" style="display:none">
      <div style="display:grid;grid-template-columns:1fr 1fr;gap:14px;margin-bottom:14px">
        <div class="result-card" style="margin-bottom:0">
          <div style="font-size:10px;font-weight:600;color:var(--text3);text-transform:uppercase;letter-spacing:.06em;margin-bottom:12px">üåç Global Feature Importance</div>
          <div id="xai-global-bars" class="feat-bars"></div>
        </div>
        <div class="result-card" style="margin-bottom:0">
          <div style="font-size:10px;font-weight:600;color:var(--text3);text-transform:uppercase;letter-spacing:.06em;margin-bottom:8px">‚ö° Local Contributions (This Patient)</div>
          <div id="xai-prediction-box" style="margin-bottom:10px"></div>
          <div id="xai-local-bars"></div>
        </div>
      </div>
      <div class="result-card" style="margin-bottom:0">
        <div style="font-size:10px;font-weight:600;color:var(--text3);text-transform:uppercase;letter-spacing:.06em;margin-bottom:8px">üí¨ Why This Prediction?</div>
        <div id="xai-narrative" style="font-size:12px;color:var(--text2);line-height:1.8;white-space:pre-line;padding:12px;background:var(--surface2);border-radius:var(--radius);border-left:3px solid var(--accent)"></div>
      </div>
    </div>
    <div id="xai-empty" class="result-card" style="text-align:center;padding:32px;color:var(--text3)">
      <div style="font-size:32px;margin-bottom:10px">üß†</div>
      <div style="font-size:13px">Run an ML analysis first (Analytics tab), then come back here to explain the results.</div>
    </div>
  </div>

  <!-- ‚ïê‚ïê RISK ENGINE TAB ‚ïê‚ïê -->
  <div class="tpanel" id="tpanel-risk">
    <div class="result-card" style="position:relative;overflow:hidden;margin-bottom:14px">
      <div style="position:absolute;top:0;left:0;right:0;height:3px;background:linear-gradient(90deg,var(--danger),var(--warn))"></div>
      <div style="font-family:'Playfair Display',serif;font-size:20px;font-weight:700;margin-bottom:6px">‚ö†Ô∏è Clinical Risk &amp; Alert Engine</div>
      <div style="font-size:12px;color:var(--text3);margin-bottom:14px;line-height:1.6">Threshold alerts, anomaly detection (IsolationForest), sudden change detection, and composite patient risk scoring.</div>
      <button class="btn btn-primary btn-sm" onclick="runRisk()">‚ñ∂ Run Risk Analysis</button>
    </div>
    <div id="risk-result" style="display:none">
      <!-- Overview KPIs -->
      <div class="metrics-grid" id="risk-kpis" style="margin-bottom:14px"></div>
      <!-- Alerts -->
      <div class="result-card" style="margin-bottom:14px">
        <div style="font-size:10px;font-weight:600;color:var(--text3);text-transform:uppercase;letter-spacing:.06em;margin-bottom:10px">üö® Threshold Alerts</div>
        <div id="risk-alerts"></div>
      </div>
      <!-- Anomalies + Top Risk side-by-side -->
      <div style="display:grid;grid-template-columns:1fr 1fr;gap:14px;margin-bottom:14px">
        <div class="result-card" style="margin-bottom:0">
          <div style="font-size:10px;font-weight:600;color:var(--text3);text-transform:uppercase;letter-spacing:.06em;margin-bottom:10px">ü§ñ Anomaly Detection</div>
          <div id="risk-anomaly"></div>
        </div>
        <div class="result-card" style="margin-bottom:0">
          <div style="font-size:10px;font-weight:600;color:var(--text3);text-transform:uppercase;letter-spacing:.06em;margin-bottom:10px">üî¥ Top Risk Patients</div>
          <div id="risk-top-patients"></div>
        </div>
      </div>
      <!-- Change Detection -->
      <div class="result-card" style="margin-bottom:0">
        <div style="font-size:10px;font-weight:600;color:var(--text3);text-transform:uppercase;letter-spacing:.06em;margin-bottom:10px">üìâ Sudden Change Detection</div>
        <div id="risk-changes"></div>
      </div>
    </div>
    <div id="risk-empty" class="result-card" style="text-align:center;padding:32px;color:var(--text3)">
      <div style="font-size:32px;margin-bottom:10px">‚ö†Ô∏è</div>
      <div style="font-size:13px">Upload a dataset and select feature columns, then run Risk Analysis.</div>
    </div>
  </div>

  <!-- ‚ïê‚ïê TRENDS TAB ‚ïê‚ïê -->
  <div class="tpanel" id="tpanel-trends">
    <div class="result-card" style="position:relative;overflow:hidden;margin-bottom:14px">
      <div style="position:absolute;top:0;left:0;right:0;height:3px;background:linear-gradient(90deg,var(--accent2),var(--accent))"></div>
      <div style="font-family:'Playfair Display',serif;font-size:20px;font-weight:700;margin-bottom:6px">üìà Trend &amp; Forecast Analysis</div>
      <div style="font-size:12px;color:var(--text3);margin-bottom:14px;line-height:1.6">Linear trend detection, moving averages, simple forecasting, and correlation matrix across selected features.</div>
      <div style="display:flex;gap:8px;flex-wrap:wrap;align-items:center">
        <button class="btn btn-primary btn-sm" onclick="runTrends()">‚ñ∂ Run Trend Analysis</button>
        <div style="display:flex;align-items:center;gap:7px">
          <span style="font-size:10px;color:var(--text3)">Forecast steps:</span>
          <input type="number" id="forecastSteps" value="10" min="5" max="50" class="cfg-select" style="width:70px;margin-bottom:0">
        </div>
      </div>
    </div>
    <div id="trends-result" style="display:none">
      <div id="trends-charts-grid" style="display:grid;grid-template-columns:1fr 1fr;gap:14px;margin-bottom:14px"></div>
      <div class="result-card" style="margin-bottom:0">
        <div style="font-size:10px;font-weight:600;color:var(--text3);text-transform:uppercase;letter-spacing:.06em;margin-bottom:10px">üîó Feature Correlation Matrix</div>
        <div id="trends-corr" style="overflow-x:auto"></div>
      </div>
    </div>
    <div id="trends-empty" class="result-card" style="text-align:center;padding:32px;color:var(--text3)">
      <div style="font-size:32px;margin-bottom:10px">üìà</div>
      <div style="font-size:13px">Upload a dataset and select feature columns, then run Trend Analysis.</div>
    </div>
  </div>

  <!-- ‚ïê‚ïê PATIENT SIMILARITY TAB ‚ïê‚ïê -->
  <div class="tpanel" id="tpanel-similarity">
    <div class="result-card" style="position:relative;overflow:hidden;margin-bottom:14px">
      <div style="position:absolute;top:0;left:0;right:0;height:3px;background:linear-gradient(90deg,var(--accent3),var(--accent4))"></div>
      <div style="font-family:'Playfair Display',serif;font-size:20px;font-weight:700;margin-bottom:6px">üë• Patient Similarity Engine</div>
      <div style="font-size:12px;color:var(--text3);margin-bottom:14px;line-height:1.6">Find clinically similar patients using K-Nearest Neighbours. Cohort comparison vs full population.</div>
      <div style="display:flex;gap:8px;flex-wrap:wrap;align-items:center">
        <button class="btn btn-primary btn-sm" onclick="runSimilarity()">‚ñ∂ Find Similar Patients</button>
        <div style="display:flex;align-items:center;gap:7px">
          <span style="font-size:10px;color:var(--text3)">Query row #</span>
          <input type="number" id="simQueryIdx" value="0" min="0" class="cfg-select" style="width:80px;margin-bottom:0">
        </div>
        <div style="display:flex;align-items:center;gap:7px">
          <span style="font-size:10px;color:var(--text3)">N similar:</span>
          <input type="number" id="simN" value="5" min="2" max="20" class="cfg-select" style="width:70px;margin-bottom:0">
        </div>
      </div>
    </div>
    <div id="sim-result" style="display:none">
      <!-- Query Patient -->
      <div class="result-card" style="margin-bottom:14px">
        <div style="font-size:10px;font-weight:600;color:var(--text3);text-transform:uppercase;letter-spacing:.06em;margin-bottom:10px">üéØ Query Patient Profile</div>
        <div id="sim-query-patient"></div>
      </div>
      <!-- Similar Patients Table -->
      <div class="result-card" style="margin-bottom:14px">
        <div style="font-size:10px;font-weight:600;color:var(--text3);text-transform:uppercase;letter-spacing:.06em;margin-bottom:10px">üë• Most Similar Patients</div>
        <div id="sim-patients-table" style="overflow-x:auto"></div>
      </div>
      <!-- Cohort Comparison -->
      <div class="result-card" style="margin-bottom:0">
        <div style="font-size:10px;font-weight:600;color:var(--text3);text-transform:uppercase;letter-spacing:.06em;margin-bottom:10px">üìä Cohort vs Population Comparison</div>
        <div id="sim-cohort" class="feat-bars"></div>
      </div>
    </div>
    <div id="sim-empty" class="result-card" style="text-align:center;padding:32px;color:var(--text3)">
      <div style="font-size:32px;margin-bottom:10px">üë•</div>
      <div style="font-size:13px">Upload a dataset and select feature columns, then find similar patients.</div>
    </div>
  </div>
  <!-- ‚ïê‚ïê CLINICAL INSIGHTS TAB ‚ïê‚ïê -->
  <div class="tpanel" id="tpanel-insights">
    <div class="result-card" style="position:relative;overflow:hidden;margin-bottom:14px">
      <div style="position:absolute;top:0;left:0;right:0;height:3px;background:linear-gradient(90deg,var(--accent),var(--accent2),var(--accent3))"></div>
      <div style="font-family:'Playfair Display',serif;font-size:20px;font-weight:700;margin-bottom:6px">üí° Auto Clinical Insights</div>
      <div style="font-size:12px;color:var(--text3);margin-bottom:14px;line-height:1.6">AI-generated narrative summaries, chart interpretations, and clinical observations ‚Äî powered by LLM + your ML results.</div>
      <div style="display:flex;gap:8px;align-items:center;flex-wrap:wrap">
        <button class="btn btn-primary btn-sm" onclick="runInsights()">ü§ñ Generate Insights</button>
        <span style="font-size:10px;color:var(--text3)">Run an ML analysis first, then generate narrative insights.</span>
      </div>
    </div>
    <div id="insights-empty" class="result-card" style="text-align:center;padding:40px;color:var(--text3)">
      <div style="font-size:40px;margin-bottom:12px">üí°</div>
      <div style="font-size:13px;margin-bottom:8px">No insights yet</div>
      <div style="font-size:11px">Go to the Analytics tab ‚Üí run an analysis ‚Üí come back here and click Generate Insights.</div>
    </div>
    <div id="insights-result" style="display:none">
      <!-- Summary + Confidence -->
      <div class="result-card" style="margin-bottom:14px">
        <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:12px">
          <div style="font-size:10px;font-weight:600;color:var(--text3);text-transform:uppercase;letter-spacing:.06em">üìã Executive Summary</div>
          <div id="insights-conf-badge"></div>
        </div>
        <div class="insight-narrative" id="insights-summary"></div>
      </div>
      <!-- 3-column grid: observations / recommendations / risk flags -->
      <div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:14px;margin-bottom:14px">
        <div class="result-card" style="margin-bottom:0">
          <div style="font-size:10px;font-weight:600;color:var(--accent2);text-transform:uppercase;letter-spacing:.06em;margin-bottom:10px">üî¨ Clinical Observations</div>
          <ul class="obs-list" id="insights-observations"></ul>
        </div>
        <div class="result-card" style="margin-bottom:0">
          <div style="font-size:10px;font-weight:600;color:var(--accent3);text-transform:uppercase;letter-spacing:.06em;margin-bottom:10px">‚úÖ Recommendations</div>
          <ul class="obs-list" id="insights-recommendations"></ul>
        </div>
        <div class="result-card" style="margin-bottom:0">
          <div style="font-size:10px;font-weight:600;color:var(--danger);text-transform:uppercase;letter-spacing:.06em;margin-bottom:10px">‚ö†Ô∏è Risk Flags</div>
          <ul class="obs-list" id="insights-risks"></ul>
        </div>
      </div>
      <!-- Chart interpretation -->
      <div class="result-card" style="margin-bottom:0">
        <div style="font-size:10px;font-weight:600;color:var(--text3);text-transform:uppercase;letter-spacing:.06em;margin-bottom:10px">üìä Chart Interpretation</div>
        <div class="insight-narrative" id="insights-chart" style="background:rgba(244,114,182,.04);border-color:rgba(244,114,182,.2);border-left-color:var(--accent3)"></div>
      </div>
    </div>
  </div>

  <!-- ‚ïê‚ïê DATA QUALITY TAB ‚ïê‚ïê -->
  <div class="tpanel" id="tpanel-quality">
    <div class="result-card" style="position:relative;overflow:hidden;margin-bottom:14px">
      <div style="position:absolute;top:0;left:0;right:0;height:3px;background:linear-gradient(90deg,var(--warn),var(--accent4))"></div>
      <div style="font-family:'Playfair Display',serif;font-size:20px;font-weight:700;margin-bottom:6px">üß™ Data Quality &amp; Bias Detection</div>
      <div style="font-size:12px;color:var(--text3);margin-bottom:14px;line-height:1.6">Missing data alerts, outlier detection, class imbalance warnings, duplicate rows ‚Äî full research-grade quality report.</div>
      <button class="btn btn-primary btn-sm" onclick="runQuality()">üîç Run Quality Check</button>
    </div>
    <div id="quality-empty" class="result-card" style="text-align:center;padding:40px;color:var(--text3)">
      <div style="font-size:40px;margin-bottom:12px">üß™</div>
      <div style="font-size:13px">Upload a dataset then run a quality check.</div>
    </div>
    <div id="quality-result" style="display:none">
      <!-- Score banner -->
      <div class="result-card" style="margin-bottom:14px">
        <div style="display:flex;align-items:center;gap:20px;flex-wrap:wrap">
          <div id="quality-score-ring" class="quality-score-ring"></div>
          <div style="flex:1">
            <div style="font-size:18px;font-weight:700;color:var(--text);margin-bottom:4px" id="quality-recommendation"></div>
            <div class="compliance-meter" style="max-width:320px"><div class="compliance-fill" id="quality-bar"></div></div>
          </div>
          <div class="metrics-grid" id="quality-kpis" style="margin-bottom:0;flex:2;min-width:260px"></div>
        </div>
      </div>
      <!-- Issues + Warnings + Passed side by side -->
      <div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:14px;margin-bottom:14px">
        <div class="result-card" style="margin-bottom:0">
          <div style="font-size:10px;font-weight:600;color:var(--danger);text-transform:uppercase;letter-spacing:.06em;margin-bottom:10px">‚ùå Issues</div>
          <div id="quality-issues"></div>
        </div>
        <div class="result-card" style="margin-bottom:0">
          <div style="font-size:10px;font-weight:600;color:var(--warn);text-transform:uppercase;letter-spacing:.06em;margin-bottom:10px">‚ö†Ô∏è Warnings</div>
          <div id="quality-warnings"></div>
        </div>
        <div class="result-card" style="margin-bottom:0">
          <div style="font-size:10px;font-weight:600;color:var(--accent2);text-transform:uppercase;letter-spacing:.06em;margin-bottom:10px">‚úÖ Passed</div>
          <div id="quality-passed"></div>
        </div>
      </div>
      <!-- Missing data table -->
      <div class="result-card" style="margin-bottom:14px">
        <div style="font-size:10px;font-weight:600;color:var(--text3);text-transform:uppercase;letter-spacing:.06em;margin-bottom:10px">üìä Missing Data Report</div>
        <div id="quality-missing" style="overflow-x:auto"></div>
      </div>
      <!-- Outliers table -->
      <div class="result-card" style="margin-bottom:0">
        <div style="font-size:10px;font-weight:600;color:var(--text3);text-transform:uppercase;letter-spacing:.06em;margin-bottom:10px">üìâ Outlier Detection (3√óIQR)</div>
        <div id="quality-outliers" style="overflow-x:auto"></div>
      </div>
    </div>
  </div>

  <!-- ‚ïê‚ïê PRIVACY TAB ‚ïê‚ïê -->
  <div class="tpanel" id="tpanel-privacy">
    <div class="result-card" style="position:relative;overflow:hidden;margin-bottom:14px">
      <div style="position:absolute;top:0;left:0;right:0;height:3px;background:linear-gradient(90deg,var(--accent3),#a855f7)"></div>
      <div style="font-family:'Playfair Display',serif;font-size:20px;font-weight:700;margin-bottom:6px">üîí Privacy &amp; Compliance Layer</div>
      <div style="font-size:12px;color:var(--text3);margin-bottom:14px;line-height:1.6">PHI detection, anonymisation tools, and compliance scoring ‚Äî makes your dataset healthcare-ready.</div>
      <button class="btn btn-primary btn-sm" onclick="runPrivacy()">üîç Scan for PHI</button>
    </div>
    <div id="privacy-empty" class="result-card" style="text-align:center;padding:40px;color:var(--text3)">
      <div style="font-size:40px;margin-bottom:12px">üîí</div>
      <div style="font-size:13px">Upload a dataset then scan for PHI (Personal Health Information).</div>
    </div>
    <div id="privacy-result" style="display:none">
      <!-- Compliance banner -->
      <div class="result-card" style="margin-bottom:14px">
        <div style="display:flex;align-items:center;gap:20px;flex-wrap:wrap">
          <div style="flex-shrink:0">
            <div id="privacy-status-badge" style="font-size:13px;font-weight:700;padding:8px 18px;border-radius:var(--radius);margin-bottom:8px"></div>
            <div style="font-size:10px;color:var(--text3)">Compliance Score</div>
            <div class="compliance-meter" style="width:160px;margin-top:4px"><div class="compliance-fill" id="privacy-score-bar"></div></div>
          </div>
          <div class="metrics-grid" id="privacy-kpis" style="margin-bottom:0;flex:1;min-width:200px"></div>
        </div>
      </div>
      <!-- PHI columns detected -->
      <div class="result-card" style="margin-bottom:14px">
        <div style="font-size:10px;font-weight:600;color:var(--text3);text-transform:uppercase;letter-spacing:.06em;margin-bottom:10px">üîç Detected PHI Columns</div>
        <div id="privacy-phi-list"></div>
      </div>
      <!-- Anonymisation tool -->
      <div class="result-card" style="margin-bottom:14px">
        <div style="font-size:10px;font-weight:600;color:var(--text3);text-transform:uppercase;letter-spacing:.06em;margin-bottom:12px">üõ° Anonymisation Tool</div>
        <div style="font-size:11px;color:var(--text3);margin-bottom:10px">Select a method then click Anonymise to clean the dataset. The session will be updated with anonymised data.</div>
        <div class="anon-method-grid" id="anon-method-grid">
          <div class="anon-method-card sel" onclick="selAnonMethod('hash',this)"><div class="anon-method-icon">üîê</div><div class="anon-method-name">Hash (SHA-256)</div><div class="anon-method-desc">Replace with 12-char hash. Consistent ‚Äî same value always hashes the same.</div></div>
          <div class="anon-method-card" onclick="selAnonMethod('mask',this)"><div class="anon-method-icon">‚¨õ</div><div class="anon-method-name">Mask</div><div class="anon-method-desc">Replace middle chars with ***. e.g. John ‚Üí J**n</div></div>
          <div class="anon-method-card" onclick="selAnonMethod('pseudonymise',this)"><div class="anon-method-icon">üè∑</div><div class="anon-method-name">Pseudonymise</div><div class="anon-method-desc">Replace with PATIENT_00001 codes. Allows re-linkage with mapping.</div></div>
          <div class="anon-method-card" onclick="selAnonMethod('drop',this)"><div class="anon-method-icon">üóë</div><div class="anon-method-name">Drop Column</div><div class="anon-method-desc">Remove column entirely. Most secure ‚Äî no PHI remains.</div></div>
        </div>
        <div style="display:flex;gap:8px;align-items:center;flex-wrap:wrap">
          <button class="btn btn-primary btn-sm" onclick="runAnonymise()">üõ° Anonymise Selected PHI Columns</button>
          <span style="font-size:10px;color:var(--text3)" id="anon-col-count"></span>
        </div>
        <div id="anon-result" style="display:none;margin-top:12px;padding:12px;background:rgba(52,211,153,.08);border:1px solid rgba(52,211,153,.25);border-radius:var(--radius);font-size:12px;color:var(--accent2)"></div>
      </div>
      <!-- Recommendations -->
      <div class="result-card" style="margin-bottom:0">
        <div style="font-size:10px;font-weight:600;color:var(--text3);text-transform:uppercase;letter-spacing:.06em;margin-bottom:10px">üìã Compliance Recommendations</div>
        <div id="privacy-recs"></div>
      </div>
    </div>
  </div>

  <!-- ‚ïê‚ïê REPORT TAB ‚ïê‚ïê -->
  <div class="tpanel" id="tpanel-report">
    <div class="result-card" style="position:relative;overflow:hidden;margin-bottom:14px">
      <div style="position:absolute;top:0;left:0;right:0;height:3px;background:linear-gradient(90deg,var(--accent2),var(--accent))"></div>
      <div style="font-family:'Playfair Display',serif;font-size:20px;font-weight:700;margin-bottom:6px">üìÑ AI Clinical Report Generator</div>
      <div style="font-size:12px;color:var(--text3);margin-bottom:14px;line-height:1.6">Generate a complete exportable clinical report ‚Äî metrics, feature importance, AI narrative, quality assessment, recommendations. Opens in a new tab as print-ready HTML ‚Üí Save as PDF.</div>
      <div style="display:flex;gap:8px;flex-wrap:wrap">
        <button class="btn btn-success btn-sm" onclick="runReport()">üìÑ Generate Report</button>
        <button class="btn btn-sm" id="report-open-btn" style="display:none;background:rgba(56,189,248,.15);color:var(--accent);border:1px solid rgba(56,189,248,.3)" onclick="openReport()">üîó Open in New Tab</button>
      </div>
    </div>
    <div id="report-empty" class="result-card" style="text-align:center;padding:40px;color:var(--text3)">
      <div style="font-size:40px;margin-bottom:12px">üìÑ</div>
      <div style="font-size:13px;margin-bottom:8px">No report yet</div>
      <div style="font-size:11px">Run an ML analysis first, then generate your clinical report here.</div>
    </div>
    <div id="report-preview-wrap" style="display:none">
      <div class="report-preview">
        <div class="report-preview-bar">
          <span>üìÑ</span>
          <span id="report-preview-title" style="color:var(--text2)">Clinical Report</span>
          <span style="margin-left:auto;display:flex;gap:6px">
            <button onclick="openReport()" style="padding:4px 12px;background:var(--accent);color:#fff;border:none;border-radius:7px;font-size:10px;font-weight:600;cursor:pointer">üîó Open Full Report</button>
            <button onclick="printReport()" style="padding:4px 12px;background:rgba(52,211,153,.2);color:var(--accent2);border:1px solid rgba(52,211,153,.3);border-radius:7px;font-size:10px;font-weight:600;cursor:pointer">üñ® Print / PDF</button>
          </span>
        </div>
        <iframe id="report-frame" class="report-preview-frame"></iframe>
      </div>
    </div>
  </div>
  <!-- ‚ïê‚ïê PATIENT DASHBOARD TAB ‚ïê‚ïê -->
  <div class="tpanel" id="tpanel-patient">
    <div class="result-card" style="position:relative;overflow:hidden;margin-bottom:14px">
      <div style="position:absolute;top:0;left:0;right:0;height:3px;background:linear-gradient(90deg,var(--accent),var(--accent2))"></div>
      <div style="font-family:'Playfair Display',serif;font-size:20px;font-weight:700;margin-bottom:6px">üßë‚Äç‚öïÔ∏è Patient Dashboard</div>
      <div style="font-size:12px;color:var(--text3);margin-bottom:14px;line-height:1.6">Select any patient row ‚Äî see all values, percentile ranks, composite risk score, predicted outcome, and most similar patients in one unified view.</div>
      <div style="display:flex;gap:8px;align-items:center;flex-wrap:wrap">
        <span style="font-size:10px;color:var(--text3)">Patient Row #</span>
        <input type="number" id="patientRowIdx" value="0" min="0" class="cfg-select" style="width:90px;margin-bottom:0">
        <button class="btn btn-primary btn-sm" onclick="runPatientDashboard()">üßë‚Äç‚öïÔ∏è View Patient</button>
        <button class="btn btn-sm" style="background:var(--surface2);border:1px solid var(--border);color:var(--text3)" onclick="patientRowIdx.value=Math.max(0,+patientRowIdx.value-1);runPatientDashboard()">‚óÄ Prev</button>
        <button class="btn btn-sm" style="background:var(--surface2);border:1px solid var(--border);color:var(--text3)" onclick="patientRowIdx.value=+patientRowIdx.value+1;runPatientDashboard()">Next ‚ñ∂</button>
      </div>
    </div>
    <div id="patient-empty" class="result-card" style="text-align:center;padding:40px;color:var(--text3)">
      <div style="font-size:40px;margin-bottom:12px">üßë‚Äç‚öïÔ∏è</div>
      <div style="font-size:13px">Upload a dataset and select columns, then click View Patient.</div>
    </div>
    <div id="patient-result" style="display:none">
      <!-- Risk + Nav -->
      <div class="result-card" style="margin-bottom:14px">
        <div style="display:flex;align-items:center;gap:18px;flex-wrap:wrap">
          <div class="risk-ring" id="patient-risk-ring">
            <div id="patient-risk-score" style="font-size:22px;font-weight:700;font-family:'DM Mono',monospace"></div>
            <div style="font-size:9px;color:var(--text3)">Risk</div>
          </div>
          <div style="flex:1">
            <div id="patient-risk-label" style="font-size:14px;font-weight:700;margin-bottom:4px"></div>
            <div id="patient-anomaly" style="font-size:11px;color:var(--text3);line-height:1.6"></div>
            <div id="patient-missing" style="font-size:10px;color:var(--warn);margin-top:4px"></div>
          </div>
          <div id="patient-prediction-box" style="display:none;padding:12px 16px;background:rgba(52,211,153,.08);border:1px solid rgba(52,211,153,.25);border-radius:var(--radius);text-align:center">
            <div style="font-size:9px;color:var(--text3);margin-bottom:3px">PREDICTED OUTCOME</div>
            <div id="patient-pred-val" style="font-size:20px;font-weight:700;color:var(--accent2);font-family:'DM Mono',monospace"></div>
          </div>
        </div>
      </div>
      <!-- All values grid -->
      <div class="result-card" style="margin-bottom:14px">
        <div style="font-size:10px;font-weight:600;color:var(--text3);text-transform:uppercase;letter-spacing:.06em;margin-bottom:12px">üìä All Column Values ‚Äî Percentile vs Population</div>
        <div class="patient-value-grid" id="patient-values-grid"></div>
      </div>
      <!-- Population comparison + similar patients -->
      <div style="display:grid;grid-template-columns:1fr 1fr;gap:14px;margin-bottom:0">
        <div class="result-card" style="margin-bottom:0">
          <div style="font-size:10px;font-weight:600;color:var(--text3);text-transform:uppercase;letter-spacing:.06em;margin-bottom:10px">üìà vs Population Average</div>
          <div id="patient-pop-bars" class="feat-bars"></div>
        </div>
        <div class="result-card" style="margin-bottom:0">
          <div style="font-size:10px;font-weight:600;color:var(--text3);text-transform:uppercase;letter-spacing:.06em;margin-bottom:10px">üë• Most Similar Patients</div>
          <div id="patient-similar-table"></div>
        </div>
      </div>
    </div>
  </div>

  <!-- ‚ïê‚ïê SURVIVAL ANALYSIS TAB ‚ïê‚ïê -->
  <div class="tpanel" id="tpanel-survival">
    <div class="result-card" style="position:relative;overflow:hidden;margin-bottom:14px">
      <div style="position:absolute;top:0;left:0;right:0;height:3px;background:linear-gradient(90deg,var(--accent3),var(--accent))"></div>
      <div style="font-family:'Playfair Display',serif;font-size:20px;font-weight:700;margin-bottom:6px">üìâ Kaplan-Meier Survival Analysis</div>
      <div style="font-size:12px;color:var(--text3);margin-bottom:14px;line-height:1.6">Standard clinical research tool. Estimate time-to-event survival curves, compare groups, find median survival. Requires a duration column (time) and event column (0/1).</div>
      <div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:10px;margin-bottom:12px">
        <div>
          <label class="cfg-label">Duration Column (time to event/censoring)</label>
          <select id="survDurationCol" class="cfg-select" style="margin-bottom:0"></select>
        </div>
        <div>
          <label class="cfg-label">Event Column (1=event, 0=censored)</label>
          <select id="survEventCol" class="cfg-select" style="margin-bottom:0"></select>
        </div>
        <div>
          <label class="cfg-label">Stratify By (optional group column)</label>
          <select id="survGroupCol" class="cfg-select" style="margin-bottom:0"><option value="">‚Äî No grouping ‚Äî</option></select>
        </div>
      </div>
      <button class="btn btn-primary btn-sm" onclick="runSurvival()">üìâ Run Survival Analysis</button>
    </div>
    <div id="survival-empty" class="result-card" style="text-align:center;padding:40px;color:var(--text3)">
      <div style="font-size:40px;margin-bottom:12px">üìâ</div>
      <div style="font-size:13px">Select duration and event columns, then run survival analysis.</div>
    </div>
    <div id="survival-result" style="display:none">
      <!-- KPI row -->
      <div class="metrics-grid" id="survival-kpis" style="margin-bottom:14px"></div>
      <!-- Kaplan-Meier Chart -->
      <div class="result-card" style="margin-bottom:14px">
        <div style="font-size:10px;font-weight:600;color:var(--text3);text-transform:uppercase;letter-spacing:.06em;margin-bottom:10px">üìâ Kaplan-Meier Survival Curve</div>
        <div id="survival-legend" class="km-group-legend"></div>
        <div class="chart-wrap" style="height:240px"><canvas id="survivalChart"></canvas></div>
      </div>
      <!-- Median survival + interpretation -->
      <div style="display:grid;grid-template-columns:1fr 1fr;gap:14px">
        <div class="result-card" style="margin-bottom:0">
          <div style="font-size:10px;font-weight:600;color:var(--text3);text-transform:uppercase;letter-spacing:.06em;margin-bottom:10px">‚è± Median Survival by Group</div>
          <div id="survival-medians"></div>
        </div>
        <div class="result-card" style="margin-bottom:0">
          <div style="font-size:10px;font-weight:600;color:var(--text3);text-transform:uppercase;letter-spacing:.06em;margin-bottom:10px">üí¨ Clinical Interpretation</div>
          <div id="survival-interpretation" style="font-size:12px;color:var(--text2);line-height:1.8;padding:10px;background:var(--surface2);border-radius:var(--radius);border-left:3px solid var(--accent)"></div>
        </div>
      </div>
    </div>
  </div>

  <!-- ‚ïê‚ïê MULTI-TARGET TAB ‚ïê‚ïê -->
  <div class="tpanel" id="tpanel-multitarget">
    <div class="result-card" style="position:relative;overflow:hidden;margin-bottom:14px">
      <div style="position:absolute;top:0;left:0;right:0;height:3px;background:linear-gradient(90deg,var(--accent2),var(--accent4))"></div>
      <div style="font-family:'Playfair Display',serif;font-size:20px;font-weight:700;margin-bottom:6px">üéØ Multi-Target Prediction Comparator</div>
      <div style="font-size:12px;color:var(--text3);margin-bottom:14px;line-height:1.6">Run the same feature set against multiple outcome columns simultaneously. Compare model performance side-by-side ‚Äî e.g. predict Diabetes AND Heart Disease AND Readmission together.</div>
      <div style="margin-bottom:12px">
        <label class="cfg-label">Select Target Columns to Compare (click multiple)</label>
        <div id="mt-target-selector" style="display:flex;flex-wrap:wrap;gap:5px;padding:10px;background:var(--surface2);border-radius:var(--radius);border:1px solid var(--border);min-height:44px"></div>
        <div style="font-size:10px;color:var(--text3);margin-top:5px">Selected: <span id="mt-target-count" style="color:var(--accent)">0</span> targets (need ‚â•2)</div>
      </div>
      <button class="btn btn-primary btn-sm" onclick="runMultiTarget()">üéØ Compare All Targets</button>
    </div>
    <div id="multitarget-empty" class="result-card" style="text-align:center;padding:40px;color:var(--text3)">
      <div style="font-size:40px;margin-bottom:12px">üéØ</div>
      <div style="font-size:13px">Upload a dataset, select feature columns in the sidebar, then select ‚â•2 target columns above.</div>
    </div>
    <div id="multitarget-result" style="display:none">
      <div class="result-card" style="margin-bottom:14px;padding:14px 18px;background:rgba(52,211,153,.06);border-color:rgba(52,211,153,.3)">
        <div style="font-size:10px;color:var(--text3);margin-bottom:4px;text-transform:uppercase;letter-spacing:.06em">üèÜ Best Performing Target</div>
        <div id="mt-best" style="font-size:14px;font-weight:700;color:var(--accent2)"></div>
      </div>
      <div id="mt-results-list"></div>
    </div>
  </div>

  <!-- ‚ïê‚ïê ALERT RULES TAB ‚ïê‚ïê -->
  <div class="tpanel" id="tpanel-alerts">
    <div class="result-card" style="position:relative;overflow:hidden;margin-bottom:14px">
      <div style="position:absolute;top:0;left:0;right:0;height:3px;background:linear-gradient(90deg,var(--danger),var(--warn))"></div>
      <div style="font-family:'Playfair Display',serif;font-size:20px;font-weight:700;margin-bottom:6px">üîî Clinical Alert Rules Builder</div>
      <div style="font-size:12px;color:var(--text3);margin-bottom:14px;line-height:1.6">Define custom threshold rules (e.g. Glucose > 140 ‚Üí Critical). Auto-suggests rules based on your column names. Run on current dataset to see how many patients trigger each alert.</div>
      <div style="display:flex;gap:8px;flex-wrap:wrap">
        <button class="btn btn-primary btn-sm" onclick="loadSuggestedRules()">‚ú® Auto-Suggest Rules</button>
        <button class="btn btn-sm" style="background:var(--surface2);border:1px solid var(--border);color:var(--text2)" onclick="addRuleRow()">Ôºã Add Rule</button>
        <button class="btn btn-sm" style="background:rgba(52,211,153,.15);border:1px solid rgba(52,211,153,.3);color:var(--accent2)" onclick="runAlerts()">‚ñ∂ Evaluate All Rules</button>
        <button class="btn btn-sm" style="background:var(--surface2);border:1px solid var(--border);color:var(--text3)" onclick="clearRules()">üóë Clear</button>
      </div>
    </div>
    <!-- Rule builder -->
    <div class="result-card" style="margin-bottom:14px">
      <div style="font-size:10px;font-weight:600;color:var(--text3);text-transform:uppercase;letter-spacing:.06em;margin-bottom:10px">üìã Alert Rules</div>
      <div style="display:grid;grid-template-columns:1fr 130px 70px 100px 1fr 36px;gap:6px;margin-bottom:6px">
        <span style="font-size:9px;color:var(--text3);padding:0 4px">Column</span>
        <span style="font-size:9px;color:var(--text3);padding:0 4px">Operator</span>
        <span style="font-size:9px;color:var(--text3);padding:0 4px">Value</span>
        <span style="font-size:9px;color:var(--text3);padding:0 4px">Severity</span>
        <span style="font-size:9px;color:var(--text3);padding:0 4px">Action / Name</span>
        <span></span>
      </div>
      <div id="alert-rules-rows"></div>
    </div>
    <!-- Results -->
    <div id="alerts-result" style="display:none">
      <div class="result-card" style="margin-bottom:14px">
        <div style="display:flex;align-items:center;gap:14px;flex-wrap:wrap">
          <div id="alerts-status-badge" style="font-size:13px;font-weight:700;padding:8px 18px;border-radius:var(--radius)"></div>
          <div class="metrics-grid" id="alerts-kpis" style="margin-bottom:0;flex:1;min-width:260px"></div>
        </div>
      </div>
      <div id="alerts-triggered-list"></div>
    </div>
  </div>

  <!-- ‚ïê‚ïê DATASET COMPARE TAB ‚ïê‚ïê -->
  <div class="tpanel" id="tpanel-compare">
    <div class="result-card" style="position:relative;overflow:hidden;margin-bottom:14px">
      <div style="position:absolute;top:0;left:0;right:0;height:3px;background:linear-gradient(90deg,var(--accent),var(--accent3))"></div>
      <div style="font-family:'Playfair Display',serif;font-size:20px;font-weight:700;margin-bottom:6px">‚öñÔ∏è Dataset Comparator</div>
      <div style="font-size:12px;color:var(--text3);margin-bottom:14px;line-height:1.6">Compare two datasets statistically ‚Äî before/after treatment, control vs intervention, two time periods. Detects significant differences using Cohen's d effect size.</div>
      <div style="display:grid;grid-template-columns:1fr 1fr;gap:14px;margin-bottom:12px">
        <div>
          <label class="cfg-label">Dataset A ‚Äî Already loaded (current session)</label>
          <div style="padding:8px 10px;background:var(--surface2);border-radius:var(--radius);font-size:11px;color:var(--accent2);border:1px solid rgba(52,211,153,.2)" id="compare-a-info">No dataset loaded yet</div>
        </div>
        <div>
          <label class="cfg-label">Dataset B ‚Äî Upload second file to compare</label>
          <div class="upload-zone" style="padding:12px;margin-bottom:0" id="compareUploadZone">
            <input type="file" id="compareFileInput" accept=".xlsx,.xls,.csv" onchange="handleCompareUpload(this)">
            <div style="font-size:20px;margin-bottom:4px">üì§</div>
            <div style="font-size:10px;color:var(--text3)"><strong style="color:var(--accent)">Upload</strong> second dataset</div>
          </div>
          <div id="compare-b-info" style="display:none;padding:8px 10px;background:var(--surface2);border-radius:var(--radius);font-size:11px;color:var(--accent3);border:1px solid rgba(244,114,182,.2);margin-top:6px"></div>
        </div>
      </div>
      <div style="display:flex;gap:8px;align-items:center;flex-wrap:wrap">
        <input id="compareNameA" class="cfg-select" placeholder="Name A (e.g. Before Treatment)" style="width:200px;margin-bottom:0;font-size:11px" value="Dataset A">
        <input id="compareNameB" class="cfg-select" placeholder="Name B (e.g. After Treatment)" style="width:200px;margin-bottom:0;font-size:11px" value="Dataset B">
        <button class="btn btn-primary btn-sm" onclick="runCompare()">‚öñÔ∏è Compare Datasets</button>
      </div>
    </div>
    <div id="compare-empty" class="result-card" style="text-align:center;padding:40px;color:var(--text3)">
      <div style="font-size:40px;margin-bottom:12px">‚öñÔ∏è</div>
      <div style="font-size:13px">Load Dataset A (main upload), then upload Dataset B above.</div>
    </div>
    <div id="compare-result" style="display:none">
      <div class="result-card" style="margin-bottom:14px;padding:14px 18px;background:rgba(56,189,248,.04);border-color:rgba(56,189,248,.2)">
        <div style="font-size:10px;color:var(--text3);margin-bottom:4px;text-transform:uppercase;letter-spacing:.06em">üìã Summary</div>
        <div id="compare-summary" style="font-size:13px;color:var(--text2);line-height:1.7"></div>
      </div>
      <div class="result-card" style="margin-bottom:14px">
        <div style="display:flex;align-items:center;gap:8px;margin-bottom:10px">
          <div style="font-size:10px;font-weight:600;color:var(--text3);text-transform:uppercase;letter-spacing:.06em">üìä Column-by-Column Comparison</div>
          <div style="margin-left:auto;display:flex;gap:10px;font-size:10px">
            <span style="display:flex;align-items:center;gap:4px"><span style="width:10px;height:4px;background:var(--accent);border-radius:2px;display:inline-block"></span><span id="compare-name-a-lbl">A</span></span>
            <span style="display:flex;align-items:center;gap:4px"><span style="width:10px;height:4px;background:var(--accent3);border-radius:2px;display:inline-block"></span><span id="compare-name-b-lbl">B</span></span>
          </div>
        </div>
        <div style="display:grid;grid-template-columns:140px 1fr 1fr 90px 80px;gap:8px;padding:6px 10px;margin-bottom:4px">
          <span style="font-size:9px;color:var(--text3);font-weight:600;text-transform:uppercase">Column</span>
          <span style="font-size:9px;color:var(--accent)">Dataset A</span>
          <span style="font-size:9px;color:var(--accent3)">Dataset B</span>
          <span style="font-size:9px;color:var(--text3)">Difference</span>
          <span style="font-size:9px;color:var(--text3)">Effect</span>
        </div>
        <div id="compare-cols-list"></div>
      </div>
    </div>
  </div>

  <!-- ‚ïê‚ïê ICD CODING TAB ‚ïê‚ïê -->
  <div class="tpanel" id="tpanel-coding">
    <div class="result-card" style="position:relative;overflow:hidden;margin-bottom:14px">
      <div style="position:absolute;top:0;left:0;right:0;height:3px;background:linear-gradient(90deg,#a855f7,var(--accent3))"></div>
      <div style="font-family:'Playfair Display',serif;font-size:20px;font-weight:700;margin-bottom:6px">üíä Clinical Coding Assistant</div>
      <div style="font-size:12px;color:var(--text3);margin-bottom:14px;line-height:1.6">Automatically detects ICD-10 codes from your column names and data values. Flags potential drug interactions. Provides LLM-powered clinical coding recommendations.</div>
      <button class="btn btn-primary btn-sm" onclick="runCoding()">üíä Analyse for ICD Codes</button>
    </div>
    <div id="coding-empty" class="result-card" style="text-align:center;padding:40px;color:var(--text3)">
      <div style="font-size:40px;margin-bottom:12px">üíä</div>
      <div style="font-size:13px">Upload a healthcare dataset to detect ICD-10 codes and drug interactions.</div>
    </div>
    <div id="coding-result" style="display:none">
      <!-- ICD-10 detections -->
      <div class="result-card" style="margin-bottom:14px">
        <div style="font-size:10px;font-weight:600;color:var(--text3);text-transform:uppercase;letter-spacing:.06em;margin-bottom:12px">üè• Detected ICD-10 Codes</div>
        <div id="coding-icd-list"></div>
      </div>
      <!-- Drug interactions -->
      <div class="result-card" style="margin-bottom:14px">
        <div style="font-size:10px;font-weight:600;color:var(--text3);text-transform:uppercase;letter-spacing:.06em;margin-bottom:10px">‚ö†Ô∏è Drug Interaction Flags</div>
        <div id="coding-drug-list"></div>
      </div>
      <!-- LLM advice -->
      <div id="coding-llm-advice" style="display:none">
        <div class="result-card" style="margin-bottom:14px">
          <div style="font-size:10px;font-weight:600;color:var(--text3);text-transform:uppercase;letter-spacing:.06em;margin-bottom:10px">ü§ñ AI Coding Recommendations</div>
          <div id="coding-recs"></div>
        </div>
        <div class="result-card" style="margin-bottom:14px">
          <div style="font-size:10px;font-weight:600;color:var(--warn);text-transform:uppercase;letter-spacing:.06em;margin-bottom:10px">üìã Documentation Gaps</div>
          <div id="coding-gaps"></div>
        </div>
        <div class="result-card" style="margin-bottom:0">
          <div style="font-size:10px;font-weight:600;color:var(--accent3);text-transform:uppercase;letter-spacing:.06em;margin-bottom:10px">üí° Suggested Additional Fields</div>
          <div id="coding-suggestions"></div>
        </div>
      </div>
    </div>
  </div>

</main>

<!-- ‚ïê‚ïê‚ïê‚ïê RIGHT SIDEBAR (CHAT) ‚ïê‚ïê‚ïê‚ïê -->
<aside class="sidebar-right">
  <div class="section-head">
    <span class="section-title">ü§ñ AI Health Assistant</span>
    <span style="font-size:9px;color:var(--text3)">Groq LLaMA</span>
  </div>
  <div class="chat-msgs" id="chatMsgs">
    <div class="msg msg-ai">
      <div class="msg-bubble">
        Hello! üëã I'm your Healthcare AI Assistant.<br><br>
        Upload a dataset and I can help you:<br>
        ‚Ä¢ Explain prediction results<br>
        ‚Ä¢ Analyze health patterns<br>
        ‚Ä¢ Answer medical data questions<br><br>
        <em style="color:var(--text3);font-size:10px">AI insights support but do not replace professional medical diagnosis.</em>
      </div>
      <div class="msg-time">HealthAI</div>
    </div>
  </div>
  <div class="chat-input-area">
    <div class="quick-btns">
      <button class="q-btn" onclick="quickAsk('Explain my latest analysis results')">üìä Explain</button>
      <button class="q-btn" onclick="quickAsk('What patterns do you see in this dataset?')">üîç Patterns</button>
      <button class="q-btn" onclick="quickAsk('Which features are most important?')">‚≠ê Key features</button>
      <button class="q-btn" onclick="quickAsk('What are the health risks based on this data?')">‚ö†Ô∏è Risks</button>
    </div>
    <div class="chat-row">
      <textarea id="chatInput" placeholder="Ask about your health data..." rows="1" onkeydown="handleChatKey(event)" oninput="autoResize(this)"></textarea>
      <button class="send-btn" id="sendBtn" onclick="sendChat()">‚û§</button>
    </div>
  </div>
</aside>

</div>

<script>
// ‚ïê‚ïê STATE ‚ïê‚ïê
let colInfo=[], selFeatures=new Set(), selTarget=null, lastResult=null, charts={}, colStats={};
let imgFile=null, imgType='xray';
let pvRows=[], pvFiltered=[], pvCols=[], pvVisible=[], pvPage=1, pvSize=10, pvSortCol=null, pvSortAsc=true, pvTotal=0;

// ‚ïê‚ïê UTILS ‚ïê‚ïê
function cookie(n){
  // Try cookie first
  for(const c of document.cookie.split(';')){
    const parts=c.trim().split('=');
    if(parts[0]===n)return decodeURIComponent(parts.slice(1).join('='));
  }
  return null;
}
function getCSRF(){
  // Try cookie, then meta tag, then hidden input
  return cookie('csrftoken') || 
    document.querySelector('meta[name=csrf-token]')?.content || 
    document.querySelector('[name=csrfmiddlewaretoken]')?.value || '';
}
function notif(msg,type='success'){const e=document.getElementById('notif');e.textContent=(type==='success'?'‚úÖ ':'‚ùå ')+msg;e.className=`notif ${type} show`;setTimeout(()=>e.classList.remove('show'),3500);}
function showLoad(t='Loading...',s='Please wait'){document.getElementById('loadingText').textContent=t;document.getElementById('loadingSubText').textContent=s;document.getElementById('loadingOverlay').classList.add('active');}
function hideLoad(){document.getElementById('loadingOverlay').classList.remove('active');}
async function post(url,data){const r=await fetch(url,{method:'POST',headers:{'Content-Type':'application/json','X-CSRFToken':getCSRF()},body:JSON.stringify(data)});return r.json();}

// ‚ïê‚ïê MAIN TABS ‚Äî ENHANCED ‚ïê‚ïê
// Tab registry: defines order, display name, and optional init callback
const TAB_REGISTRY = [
  {id:'analytics',   label:'üìä Analytics',      group:'core'},
  {id:'preview',     label:'üìã Data Preview',    group:'core'},
  {id:'imaging',     label:'üî¨ Medical Imaging', group:'core'},
  {id:'xai',         label:'üß† Explainability',  group:'ai'},
  {id:'risk',        label:'‚ö†Ô∏è Risk Engine',     group:'ai'},
  {id:'trends',      label:'üìà Trends',          group:'ai'},
  {id:'similarity',  label:'üë• Similarity',      group:'ai'},
  {id:'insights',    label:'üí° AI Insights',     group:'ai'},
  {id:'quality',     label:'üß™ Data Quality',    group:'clinical'},
  {id:'privacy',     label:'üîí Privacy',         group:'clinical'},
  {id:'patient',     label:'üßë‚Äç‚öïÔ∏è Patient View', group:'clinical'},
  {id:'survival',    label:'üìâ Survival',        group:'clinical'},
  {id:'coding',      label:'üíä ICD Coding',      group:'clinical'},
  {id:'multitarget', label:'üéØ Multi-Target',    group:'advanced'},
  {id:'alerts',      label:'üîî Alert Rules',     group:'advanced'},
  {id:'compare',     label:'‚öñÔ∏è Compare',         group:'advanced'},
  {id:'report',      label:'üìÑ Report',          group:'advanced'},
];
let _activeTab = 'analytics';
let _tabInited = new Set(['analytics']); // track lazy-init calls

function switchTab(tab, opts={}) {
  if(tab === _activeTab && !opts.force) return;
  _activeTab = tab;

  // swap panel visibility
  document.querySelectorAll('.tpanel').forEach(p => p.classList.remove('active'));
  document.querySelectorAll('.mtab').forEach(b => b.classList.remove('active'));
  const panel = document.getElementById('tpanel-' + tab);
  const btn   = document.getElementById('mtab-' + tab);
  if(panel) { panel.classList.add('active'); panel.scrollTop = 0; }
  if(btn)   { btn.classList.add('active'); scrollTabIntoView(btn); }

  // update URL hash for deep-linking
  history.replaceState(null, '', '#' + tab);

  // run any lazy init on first visit
  if(!_tabInited.has(tab)) {
    _tabInited.add(tab);
    _onTabFirstVisit(tab);
  }

  updateTabArrows();
}

function _onTabFirstVisit(tab) {
  // hook: run tab-specific setup on first open
  if(tab === 'survival' && colInfo.length) populateSurvivalSelects();
  if(tab === 'multitarget' && colInfo.length) populateMTTargets();
}

// scroll the active tab button into view inside the scroll track
function scrollTabIntoView(btn) {
  const track = document.getElementById('tabsScroll');
  if(!track || !btn) return;
  const bLeft = btn.offsetLeft;
  const bRight = bLeft + btn.offsetWidth;
  const tLeft = track.scrollLeft;
  const tRight = tLeft + track.clientWidth;
  if(bLeft < tLeft + 20)       track.scrollLeft = bLeft - 20;
  else if(bRight > tRight - 20) track.scrollLeft = bRight - track.clientWidth + 20;
}

// arrow button scroll
function scrollTabs(dir) {
  const track = document.getElementById('tabsScroll');
  if(track) track.scrollLeft += dir * 180;
  setTimeout(updateTabArrows, 150);
}

// show/hide arrow buttons based on scroll position
function updateTabArrows() {
  const track = document.getElementById('tabsScroll');
  const lBtn  = document.getElementById('tabArrowLeft');
  const rBtn  = document.getElementById('tabArrowRight');
  if(!track) return;
  const atStart = track.scrollLeft < 10;
  const atEnd   = track.scrollLeft >= track.scrollWidth - track.clientWidth - 10;
  if(lBtn) lBtn.classList.toggle('hidden', atStart);
  if(rBtn) rBtn.classList.toggle('hidden', atEnd);
}

// keyboard navigation: Alt+‚Üê / Alt+‚Üí to cycle tabs
document.addEventListener('keydown', e => {
  if(!e.altKey) return;
  const ids = TAB_REGISTRY.map(t => t.id);
  const cur = ids.indexOf(_activeTab);
  if(e.key === 'ArrowRight' && cur < ids.length - 1) { e.preventDefault(); switchTab(ids[cur+1]); }
  if(e.key === 'ArrowLeft'  && cur > 0)              { e.preventDefault(); switchTab(ids[cur-1]); }
});

// restore from URL hash on load
(function restoreTabFromHash() {
  const hash = location.hash.replace('#','');
  if(hash && document.getElementById('tpanel-'+hash)) switchTab(hash);
})();

// init arrow visibility on load + on scroll
document.addEventListener('DOMContentLoaded', () => {
  updateTabArrows();
  const track = document.getElementById('tabsScroll');
  if(track) track.addEventListener('scroll', updateTabArrows, {passive:true});
});
// also init immediately since DOMContentLoaded may have already fired
setTimeout(updateTabArrows, 50);

// ‚ïê‚ïê SOURCE TABS ‚ïê‚ïê
function switchSrcTab(tab){
  document.getElementById('tab-excel').style.display=tab==='excel'?'block':'none';
  document.getElementById('tab-sql').style.display=tab==='sql'?'block':'none';
  document.querySelectorAll('.tab-btn').forEach((b,i)=>b.classList.toggle('active',(i===0&&tab==='excel')||(i===1&&tab==='sql')));
}

// ‚ïê‚ïê UPLOAD ‚ïê‚ïê
let _uploadBusy = false; // guard against re-entrant calls

async function handleUpload(input){
  // Guard: input.value='' below can re-fire onchange in some browsers ‚Äî ignore it
  if(_uploadBusy){ input.value=''; return; }
  const file = input.files[0];
  if(!file){ return; }

  _uploadBusy = true;

  // Detach handler, reset value, reattach ‚Äî the ONLY safe way to allow same-file re-upload
  input.onchange = null;
  input.value = '';
  setTimeout(() => { input.onchange = e => handleUpload(e.target); }, 300);

  // Clear session state locally (no API call needed here ‚Äî upload endpoint handles server side)
  resetSessionState();

  await handleUploadFile(file);
  _uploadBusy = false;
}

// Reset all client-side state without hitting the API
function resetSessionState(){
  colInfo=[]; selFeatures.clear(); selTarget=null; lastResult=null;
  document.getElementById('dataset-info').style.display='none';
  document.getElementById('column-panel').style.display='none';
  document.getElementById('analysis-panel').style.display='none';
  const mlCard = document.getElementById('ml-result-card');
  const clCard = document.getElementById('cluster-result-card');
  if(mlCard) mlCard.style.display='none';
  if(clCard) clCard.style.display='none';
  document.getElementById('welcomeCard').style.display='block';
  document.getElementById('colList').innerHTML='';
  document.getElementById('selSummary').textContent='Select feature columns above';
  pvRows=[]; pvFiltered=[]; pvCols=[]; pvVisible=[]; pvPage=1; pvSortCol=null;
  const prevHead = document.getElementById('prevHead');
  const prevBody = document.getElementById('prevBody');
  const pgBtns   = document.getElementById('pg-btns');
  const pgInfo   = document.getElementById('pg-info');
  const prevStats = document.getElementById('prev-stats');
  const prevSearch = document.getElementById('prevSearch');
  if(prevHead)  prevHead.innerHTML='';
  if(prevBody)  prevBody.innerHTML='';
  if(pgBtns)    pgBtns.innerHTML='';
  if(pgInfo)    pgInfo.textContent='‚Äî';
  if(prevStats) prevStats.textContent='';
  if(prevSearch) prevSearch.value='';
}

async function handleUploadFile(file){
  // Validate before sending
  const ext = file.name.split('.').pop().toLowerCase();
  if(!['xlsx','xls','csv'].includes(ext)){
    notif('Unsupported file type. Please upload .xlsx, .xls or .csv','error');
    return;
  }
  if(file.size > 100 * 1024 * 1024){
    notif('File too large ‚Äî max 100MB','error');
    return;
  }

  showLoad('Reading dataset‚Ä¶','Parsing columns and data types');
  const fd = new FormData();
  fd.append('file', file);
  try{
    const r = await fetch('/api/upload/', {
      method: 'POST',
      headers: {'X-CSRFToken': getCSRF()},
      body: fd
    });
    if(!r.ok) throw new Error('Server error ' + r.status);
    const d = await r.json();
    if(d.success){ onData(d); notif('Loaded ' + d.rows + ' rows √ó ' + d.columns + ' columns'); }
    else notif(d.error || 'Upload failed', 'error');
  } catch(e){
    notif('Upload failed: ' + e.message, 'error');
  } finally {
    hideLoad();
  }
}

// ‚ïê‚ïê SQL ‚ïê‚ïê
async function connectSQL(){
  const conn=document.getElementById('sqlConn').value.trim();
  const query=document.getElementById('sqlQuery').value.trim();
  if(!conn||!query){notif('Please fill connection string and query','error');return;}
  showLoad('Connecting to database...','Executing query');
  const d=await post('/api/connect-sql/',{connection_string:conn,query});
  hideLoad();
  if(d.success){onData(d);notif('Connected! '+d.rows+' rows loaded');}
  else notif(d.error,'error');
}

// ‚ïê‚ïê ON DATA LOADED ‚ïê‚ïê
function onData(d){
  colInfo=d.column_info;
  document.getElementById('ds-file').textContent=d.file_name||'SQL Query';
  document.getElementById('ds-rows').textContent=d.rows.toLocaleString();
  document.getElementById('ds-cols').textContent=d.columns;
  document.getElementById('dataset-info').style.display='block';
  document.getElementById('welcomeCard').style.display='none';
  document.getElementById('column-panel').style.display='block';
  document.getElementById('analysis-panel').style.display='block';
  renderCols(colInfo);
  renderPreview(d.preview,d.rows,d.columns);
  fetchColStats();
  switchTab('analytics');
  // extra panel updates
  if(typeof populateSurvivalSelects==='function') populateSurvivalSelects();
  if(typeof populateMultiTargetSelector==='function') populateMultiTargetSelector();
  const ai=document.getElementById('compare-a-info');
  if(ai) ai.textContent=`${d.file_name} ‚Äî ${d.rows?.toLocaleString()} rows √ó ${d.columns} columns`;
}

// ‚ïê‚ïê COLUMNS ‚ïê‚ïê
function renderCols(cols){
  const list=document.getElementById('colList');list.innerHTML='';
  cols.forEach(col=>{
    const item=document.createElement('div');
    item.className='col-item';item.dataset.col=col.name;
    item.innerHTML=`<div class="col-chk" id="chk-${col.name}">‚Äî</div><span class="col-name" title="${col.name}">${col.name}</span><span class="col-badge ${col.col_type==='numeric'?'badge-num':'badge-cat'}">${col.col_type==='numeric'?'NUM':'CAT'}</span>`;
    item.addEventListener('click',()=>toggleCol(col.name));
    list.appendChild(item);
  });
  updateSelUI();
}
function toggleCol(name){
  if(selTarget===name){selTarget=null;}
  else if(selFeatures.has(name)){selFeatures.delete(name);selTarget=name;}
  else{selFeatures.add(name);}
  updateSelUI();
}
function updateSelUI(){
  document.querySelectorAll('.col-item').forEach(item=>{
    const c=item.dataset.col,chk=item.querySelector('.col-chk');
    item.classList.remove('feat','tgt');
    if(selFeatures.has(c)){item.classList.add('feat');chk.textContent='‚úì';}
    else if(selTarget===c){item.classList.add('tgt');chk.textContent='‚òÖ';}
    else{chk.textContent='‚Äî';}
  });
  document.getElementById('selSummary').innerHTML=`Features: <span>${selFeatures.size}</span> selected &nbsp;|&nbsp; Target: <span>${selTarget||'none'}</span>`;
}
function filterCols(q){document.querySelectorAll('.col-item').forEach(item=>{item.style.display=item.dataset.col.toLowerCase().includes(q.toLowerCase())?'flex':'none';});}

// ‚ïê‚ïê DATA PREVIEW ‚ïê‚ïê
function renderPreview(rows,total,cols){
  if(!rows||!rows.length)return;
  pvRows=rows;pvFiltered=rows;pvCols=Object.keys(rows[0]);pvVisible=[...pvCols];pvPage=1;pvTotal=total;pvSortCol=null;pvSortAsc=true;
  document.getElementById('prev-stats').innerHTML=`<strong style="color:var(--accent)">${rows.length.toLocaleString()}</strong> loaded of <strong style="color:var(--accent2)">${total.toLocaleString()}</strong> total √ó <strong>${cols}</strong> cols`;
  buildHead();buildColDrop();renderPage();
}
function buildHead(){
  document.getElementById('prevHead').innerHTML='<tr><th class="rn">#</th>'+pvVisible.map(c=>{let cls='';if(pvSortCol===c)cls=pvSortAsc?'sort-asc':'sort-desc';return`<th class="${cls}" onclick="sortPv('${c}')">${c}</th>`;}).join('')+'</tr>';
}
function renderPage(){
  const s=(pvPage-1)*pvSize,e=s+pvSize,pageRows=pvFiltered.slice(s,e);
  document.getElementById('prevBody').innerHTML=pageRows.map((row,i)=>'<tr><td class="rn">'+(s+i+1)+'</td>'+pvVisible.map(c=>{const v=row[c]!=null?row[c]:'';const d=String(v).length>18?String(v).slice(0,18)+'‚Ä¶':v;return`<td title="${v}">${d}</td>`;}).join('')+'</tr>').join('');
  updatePg();
}
function updatePg(){
  const total=pvFiltered.length,pages=Math.max(1,Math.ceil(total/pvSize)),s=Math.min((pvPage-1)*pvSize+1,total),e=Math.min(pvPage*pvSize,total);
  const tag=pvFiltered.length<pvRows.length?' <span style="color:var(--accent3)">(filtered)</span>':'';
  document.getElementById('pg-info').innerHTML=`Showing <strong>${s}‚Äì${e}</strong> of <strong>${total.toLocaleString()}</strong>${tag}`;
  const ctrl=document.getElementById('pg-btns');ctrl.innerHTML='';
  const add=(lbl,pg,active,disabled,ellip)=>{const b=document.createElement('button');b.className='pg-btn'+(active?' active':'')+(ellip?' ellip':'');b.textContent=lbl;b.disabled=disabled||ellip;if(!disabled&&!ellip)b.onclick=()=>goPage(pg);ctrl.appendChild(b);};
  add('‚Üê Prev',pvPage-1,false,pvPage<=1);
  pgNums(pvPage,pages).forEach(p=>p==='...'?add('‚Ä¶',null,false,false,true):add(p,p,p===pvPage));
  add('Next ‚Üí',pvPage+1,false,pvPage>=pages);
}
function pgNums(cur,total){if(total<=7)return Array.from({length:total},(_,i)=>i+1);const p=[1];if(cur>3)p.push('...');for(let i=Math.max(2,cur-1);i<=Math.min(total-1,cur+1);i++)p.push(i);if(cur<total-2)p.push('...');p.push(total);return p;}
function goPage(pg){pvPage=Math.max(1,Math.min(pg,Math.ceil(pvFiltered.length/pvSize)));buildHead();renderPage();}
function changePageSize(s){pvSize=parseInt(s);pvPage=1;renderPage();}
function onSearch(q){pvFiltered=q?pvRows.filter(row=>pvVisible.some(c=>String(row[c]??'').toLowerCase().includes(q.toLowerCase()))):pvRows;pvPage=1;buildHead();renderPage();}
function sortPv(col){if(pvSortCol===col)pvSortAsc=!pvSortAsc;else{pvSortCol=col;pvSortAsc=true;}pvFiltered=[...pvFiltered].sort((a,b)=>{const va=a[col],vb=b[col];if(va==null)return 1;if(vb==null)return-1;const na=parseFloat(va),nb=parseFloat(vb);const cmp=!isNaN(na)&&!isNaN(nb)?na-nb:String(va).localeCompare(String(vb));return pvSortAsc?cmp:-cmp;});pvPage=1;buildHead();renderPage();}
function buildColDrop(){const d=document.getElementById('colTogDrop');d.innerHTML=`<div style="display:flex;justify-content:space-between;margin-bottom:6px"><span style="font-size:9px;color:var(--text3);font-weight:600;text-transform:uppercase">Show/Hide</span><span style="font-size:9px;color:var(--accent);cursor:pointer" onclick="toggleAllCols(true)">All</span></div>`+pvCols.map(c=>`<label class="coltog-item"><input type="checkbox" checked id="coltog-${c}" onchange="toggleColVis('${c}',this.checked)">${c}</label>`).join('');}
function toggleColDrop(){document.getElementById('colTogDrop').classList.toggle('open');}
document.addEventListener('click',e=>{if(!e.target.closest('.coltog-btn')&&!e.target.closest('.coltog-drop'))document.getElementById('colTogDrop')?.classList.remove('open');});
function toggleColVis(col,checked){pvVisible=pvCols.filter(c=>{const el=document.getElementById(`coltog-${c}`);return el?el.checked:true;});pvPage=1;buildHead();renderPage();}
function toggleAllCols(show){pvCols.forEach(c=>{const el=document.getElementById(`coltog-${c}`);if(el)el.checked=show;});pvVisible=show?[...pvCols]:[];buildHead();renderPage();}

// ‚ïê‚ïê TASK UI ‚ïê‚ïê
function updateTaskUI(){document.getElementById('clusterCfg').style.display=document.getElementById('taskType').value==='clustering'?'block':'none';}

// ‚ïê‚ïê RUN ANALYSIS ‚ïê‚ïê
async function runAnalysis(){
  const features=[...selFeatures];
  if(!features.length){notif('Select at least one feature column','error');return;}
  const task=document.getElementById('taskType').value;
  if(task!=='clustering'&&!selTarget){notif('Select a target column (click twice for Target ‚òÖ)','error');return;}
  showLoad('Running AI Analysis...','Training '+document.getElementById('modelType').value+' model');
  const d=await post('/api/run-analysis/',{feature_columns:features,target_column:selTarget||'',task_type:task,model_type:document.getElementById('modelType').value,n_clusters:parseInt(document.getElementById('nClusters').value)});
  hideLoad();
  if(d.success){lastResult=d.result;renderResult(d.result);notif('Analysis complete! '+d.result.task+' model trained.');switchTab('analytics');setTimeout(()=>document.getElementById('ml-result-card').scrollIntoView({behavior:'smooth',block:'start'}),200);}
  else notif(d.error,'error');
}

// ‚ïê‚ïê RENDER RESULTS ‚ïê‚ïê
function renderResult(r){
  Object.values(charts).forEach(c=>c.destroy());charts={};
  document.getElementById('ml-result-card').style.display='none';
  document.getElementById('cluster-result-card').style.display='none';
  if(r.task==='clustering')renderClustering(r);else renderML(r);
}
function renderML(r){
  document.getElementById('ml-result-card').style.display='block';
  document.getElementById('result-title').textContent=(r.task==='regression'?'üìà Regression':'üè∑ Classification')+' ‚Äî Target: '+r.target;
  const badge=document.getElementById('result-badge');badge.textContent=r.task.toUpperCase();badge.className='result-badge '+(r.task==='regression'?'badge-reg':'badge-cls');
  const g=document.getElementById('metrics-grid');
  if(r.task==='regression'){const m=r.metrics;g.innerHTML=`<div class="metric-card"><div class="metric-val">${m.r2_percent}%</div><div class="metric-lbl">R¬≤ Score</div></div><div class="metric-card"><div class="metric-val" style="color:var(--accent2)">${m.rmse}</div><div class="metric-lbl">RMSE</div></div><div class="metric-card"><div class="metric-val" style="color:var(--accent4)">${r.total_rows}</div><div class="metric-lbl">Rows</div></div><div class="metric-card"><div class="metric-val" style="color:var(--text2)">${r.features.length}</div><div class="metric-lbl">Features</div></div>`;}
  else{const m=r.metrics;g.innerHTML=`<div class="metric-card"><div class="metric-val">${m.accuracy_percent}%</div><div class="metric-lbl">Accuracy</div></div><div class="metric-card"><div class="metric-val" style="color:var(--accent4)">${r.total_rows}</div><div class="metric-lbl">Rows</div></div><div class="metric-card"><div class="metric-val" style="color:var(--text2)">${r.features.length}</div><div class="metric-lbl">Features</div></div>`;}
  const fb=document.getElementById('feat-bars');fb.innerHTML='';
  if(r.feature_importance&&r.feature_importance.length){const top=r.feature_importance.slice(0,8),max=top[0].importance;top.forEach(f=>{const pct=Math.round(f.importance/max*100);fb.innerHTML+=`<div class="feat-row"><div class="feat-lbl" title="${f.feature}">${f.feature}</div><div class="feat-track"><div class="feat-fill" style="width:${pct}%"></div></div><div class="feat-pct">${(f.importance*100).toFixed(1)}%</div></div>`;});}
  else fb.innerHTML='<div style="color:var(--text3);font-size:11px">Not available</div>';
  if(r.sample_predictions&&r.sample_predictions.length){const ctx=document.getElementById('predChart').getContext('2d');charts.pred=new Chart(ctx,{type:'scatter',data:{datasets:[{label:'Actual vs Predicted',data:r.sample_predictions.map(p=>({x:p.actual,y:p.predicted})),backgroundColor:'rgba(56,189,248,.6)',borderColor:'rgba(56,189,248,.9)',pointRadius:5}]},options:{responsive:true,maintainAspectRatio:false,plugins:{legend:{labels:{color:'#94a3b8',font:{size:9}}}},scales:{x:{ticks:{color:'#64748b',font:{size:9}},grid:{color:'rgba(99,179,237,.06)'},title:{display:true,text:'Actual',color:'#64748b'}},y:{ticks:{color:'#64748b',font:{size:9}},grid:{color:'rgba(99,179,237,.06)'},title:{display:true,text:'Predicted',color:'#64748b'}}}}});}
  buildPredForm(r.features);
}
function renderClustering(r){
  document.getElementById('cluster-result-card').style.display='block';
  document.getElementById('cluster-metrics').innerHTML=`<div class="metric-card"><div class="metric-val">${r.n_clusters}</div><div class="metric-lbl">Clusters</div></div><div class="metric-card"><div class="metric-val" style="color:var(--accent2)">${r.metrics.silhouette_score}</div><div class="metric-lbl">Silhouette</div></div><div class="metric-card"><div class="metric-val" style="color:var(--accent4)">${r.total_rows}</div><div class="metric-lbl">Rows</div></div>`;
  const ctx=document.getElementById('clusterChart').getContext('2d');
  const dist=r.cluster_distribution,colors=['rgba(56,189,248,.7)','rgba(52,211,153,.7)','rgba(244,114,182,.7)','rgba(251,146,60,.7)','rgba(167,139,250,.7)'];
  charts.cluster=new Chart(ctx,{type:'doughnut',data:{labels:dist.map(d=>d.cluster),datasets:[{data:dist.map(d=>d.count),backgroundColor:colors,borderColor:'#1a2235',borderWidth:2}]},options:{responsive:true,maintainAspectRatio:false,plugins:{legend:{labels:{color:'#94a3b8',font:{size:11}}}}}});
}

// ‚ïê‚ïê COL STATS ‚ïê‚ïê
async function fetchColStats(){try{const r=await fetch('/api/column-stats/');const d=await r.json();if(d.success)colStats=d.stats;}catch(e){}}

// ‚ïê‚ïê PREDICT FORM ‚ïê‚ïê
function buildPredForm(features){
  const c=document.getElementById('pred-inputs');c.innerHTML='';
  document.getElementById('pred-result').style.display='none';
  features.forEach(col=>{
    const s=colStats[col];const field=document.createElement('div');field.className='pred-field';
    if(!s){field.innerHTML=`<label class="pred-label">${col} <span class="ftype-badge ftype-num">NUM</span></label><input type="number" id="pred-${col}" class="slider-val" style="width:100%" placeholder="Enter value">`;}
    else if(s.type==='numeric'){field.innerHTML=`<label class="pred-label">${col} <span class="ftype-badge ftype-num">NUM</span></label><div class="slider-wrap"><div class="slider-row"><input type="range" class="slider-input" id="sli-${col}" min="${s.min}" max="${s.max}" step="${s.step}" value="${s.median}" oninput="syncSli('${col}',this.value)"><input type="number" class="slider-val" id="pred-${col}" value="${s.median}" oninput="syncVal('${col}',this.value)"></div><div class="slider-hints"><span>Min:${s.min}</span><span style="color:var(--accent)">Avg:${s.mean}</span><span>Max:${s.max}</span></div><div class="chips" id="chips-${col}"></div></div>`;}
    else{const opts=s.unique_values.map(v=>`<option value="${v}" ${v==s.most_common?'selected':''}>${v}</option>`).join('');field.innerHTML=`<label class="pred-label">${col} <span class="ftype-badge ftype-cat">CAT</span></label><select class="cat-select" id="pred-${col}">${opts}</select><div class="chips" id="chips-${col}"></div>`;}
    c.appendChild(field);
    if(s&&s.type==='numeric'){const cc=document.getElementById(`chips-${col}`);[{l:'Low',v:s.min},{l:'Avg',v:s.mean},{l:'Med',v:s.median},{l:'High',v:s.max}].forEach(x=>{const ch=document.createElement('span');ch.className='chip';ch.textContent=x.l+':'+x.v;ch.onclick=()=>{syncSli(col,x.v);cc.querySelectorAll('.chip').forEach(c=>c.classList.remove('active'));ch.classList.add('active');};cc.appendChild(ch);});}
    else if(s&&s.type==='categorical'){const cc=document.getElementById(`chips-${col}`);s.unique_values.slice(0,5).forEach(v=>{const ch=document.createElement('span');ch.className='chip'+(v==s.most_common?' active':'');ch.textContent=v;ch.onclick=()=>{const el=document.getElementById(`pred-${col}`);if(el)el.value=v;cc.querySelectorAll('.chip').forEach(c=>c.classList.remove('active'));ch.classList.add('active');};cc.appendChild(ch);});}
  });
}
function syncSli(col,val){const s=document.getElementById('sli-'+col),i=document.getElementById('pred-'+col);if(s)s.value=val;if(i)i.value=val;}
function syncVal(col,val){const s=document.getElementById('sli-'+col);if(s)s.value=val;}
async function runPrediction(){
  if(!lastResult||!lastResult.features)return;
  const vals={};lastResult.features.forEach(f=>{const el=document.getElementById('pred-'+f);if(el)vals[f]=el.value;});
  showLoad('Calculating prediction...','Running model on patient input');
  const d=await post('/api/predict/',{feature_columns:lastResult.features,target_column:selTarget||'',input_values:vals});
  hideLoad();
  if(d.success){
    const p=d.prediction;
    document.getElementById('pred-val').textContent=p.prediction_label||parseFloat(p.prediction).toFixed(3);
    const cr=document.getElementById('conf-row');
    if(p.confidence){cr.style.display='flex';setTimeout(()=>{document.getElementById('conf-fill').style.width=p.confidence+'%';document.getElementById('conf-lbl').textContent=p.confidence+'%';},100);}
    else cr.style.display='none';
    document.getElementById('pred-summary').innerHTML=lastResult.features.map(f=>{const v=vals[f];const s=colStats[f];let h='';if(s&&s.type==='numeric'){const n=parseFloat(v);if(n<=s.min+(s.max-s.min)*.25)h='üü¢ Low';else if(n>=s.max-(s.max-s.min)*.25)h='üî¥ High';else h='üü° Normal';}return f+': '+v+' '+h;}).join('<br>');
    document.getElementById('pred-result').style.display='block';
    document.getElementById('pred-result').scrollIntoView({behavior:'smooth',block:'nearest'});
  }else notif(d.error,'error');
}

// ‚ïê‚ïê CHAT ‚ïê‚ïê
function addMsg(role,text){
  const c=document.getElementById('chatMsgs');
  const d=document.createElement('div');d.className='msg msg-'+role;
  const t=new Date().toLocaleTimeString([],{hour:'2-digit',minute:'2-digit'});
  d.innerHTML=`<div class="msg-bubble">${text.replace(/\n/g,'<br>').replace(/\*\*(.*?)\*\*/g,'<strong>$1</strong>').replace(/`(.*?)`/g,'<code>$1</code>')}</div><div class="msg-time">${role==='user'?'You':'HealthAI'} ¬∑ ${t}</div>`;
  c.appendChild(d);c.scrollTop=c.scrollHeight;
}
function addTyping(){const c=document.getElementById('chatMsgs');const d=document.createElement('div');d.className='msg msg-ai';d.id='typing';d.innerHTML='<div class="msg-bubble"><div class="loading-dots"><span></span><span></span><span></span></div></div>';c.appendChild(d);c.scrollTop=c.scrollHeight;}
function removeTyping(){document.getElementById('typing')?.remove();}
async function sendChat(){
  const input=document.getElementById('chatInput');const msg=input.value.trim();if(!msg)return;
  input.value='';autoResize(input);addMsg('user',msg);
  document.getElementById('sendBtn').disabled=true;addTyping();
  const d=await post('/api/chat/',{message:msg,include_dataset:true});
  removeTyping();document.getElementById('sendBtn').disabled=false;
  if(d.success)addMsg('ai',d.message);
  else addMsg('ai','‚ö†Ô∏è '+(d.error||'Could not reach LLM. Check GROQ_API_KEY in settings.py.'));
}
function quickAsk(msg){document.getElementById('chatInput').value=msg;sendChat();}
function handleChatKey(e){if(e.key==='Enter'&&!e.shiftKey){e.preventDefault();sendChat();}}
function autoResize(el){el.style.height='auto';el.style.height=Math.min(el.scrollHeight,90)+'px';}

// ‚ïê‚ïê CLEAR (full ‚Äî also hits API) ‚ïê‚ïê
async function clearSession(){
  try { await post('/api/clear/', {}); } catch(e){}

  resetSessionState();

  // ‚îÄ‚îÄ reset medical imaging ‚îÄ‚îÄ
  imgFile = null;
  imgType = 'xray';
  const imgPreview = document.getElementById('imgPreview');
  const imgWork    = document.getElementById('imgWork');
  const imgUpload  = document.getElementById('imgUpload');
  const imgBody    = document.getElementById('imgBody');
  const imgQ       = document.getElementById('imgQ');
  const imgLbl     = document.getElementById('imgLbl');
  const imgBadge   = document.getElementById('imgBadge');
  const imgFileEl  = document.getElementById('imgFile');
  if(imgPreview) imgPreview.src = '';
  if(imgWork)    imgWork.classList.remove('on');
  if(imgUpload)  imgUpload.style.display = 'block';
  if(imgBody)    imgBody.innerHTML = '<div style="text-align:center;padding:36px 16px;color:var(--text3)"><div style="font-size:28px;margin-bottom:10px">üîç</div><div style="font-size:12px">Upload a medical image to begin AI analysis</div></div>';
  if(imgQ)       imgQ.value = '';
  if(imgLbl)     imgLbl.textContent = 'X-RAY';
  if(imgBadge)   imgBadge.textContent = 'X-RAY';
  // safely reset file input without triggering onchange
  if(imgFileEl){ imgFileEl.onchange = null; imgFileEl.value = ''; imgFileEl.onchange = e => loadImgFile(e.target.files[0]); }

  document.querySelectorAll('.img-type-card').forEach(c => c.classList.remove('sel'));
  document.querySelector('.img-type-card')?.classList.add('sel');

  switchTab('analytics');
  notif('Session cleared ‚Äî all data and images reset');
}

// ‚ïê‚ïê DRAG/DROP dataset ‚ïê‚ïê
const uz = document.getElementById('uploadZone');
uz.addEventListener('dragover', e => { e.preventDefault(); uz.classList.add('drag-over'); });
uz.addEventListener('dragleave', () => uz.classList.remove('drag-over'));
uz.addEventListener('drop', e => {
  e.preventDefault();
  uz.classList.remove('drag-over');
  const f = e.dataTransfer.files[0];
  if(!f) return;
  if(_uploadBusy){ notif('Upload already in progress‚Ä¶','error'); return; }
  _uploadBusy = true;
  resetSessionState();
  handleUploadFile(f).finally(() => { _uploadBusy = false; });
});

// ‚ïê‚ïê MEDICAL IMAGING ‚ïê‚ïê
const IMG_LABELS={xray:'X-RAY',ct:'CT SCAN',sono:'SONOGRAPHY',mri:'MRI',retinal:'RETINAL',derma:'DERMATOLOGY'};
const SCAN_NAMES={xray:'chest X-ray / bone X-ray',ct:'CT scan',sono:'sonography / ultrasound',mri:'MRI scan',retinal:'retinal fundus image',derma:'dermatology / skin image'};
function selImgType(type,el){imgType=type;document.querySelectorAll('.img-type-card').forEach(c=>c.classList.remove('sel'));el.classList.add('sel');}
function changeImgType(type){imgType=type;const lbl=IMG_LABELS[type]||type.toUpperCase();document.getElementById('imgLbl').textContent=lbl;document.getElementById('imgBadge').textContent=lbl;if(imgFile)analyzeImg(imgFile,type);}
function loadImgFile(file){
  if(!file) return;
  // validate size (10MB)
  if(file.size > 10 * 1024 * 1024){ notif('Image too large ‚Äî max 10MB','error'); return; }
  if(!file.type.startsWith('image/')){ notif('Please upload an image file','error'); return; }
  imgFile = file;
  const reader = new FileReader();
  reader.onerror = () => notif('Failed to read image file','error');
  reader.onload = e => {
    const dataUrl = e.target.result;
    const b64 = dataUrl.split(',')[1]; // ‚Üê extract base64 ONCE here, avoids double-read
    document.getElementById('imgPreview').src = dataUrl;
    document.getElementById('imgUpload').style.display = 'none';
    document.getElementById('imgWork').classList.add('on');
    const lbl = IMG_LABELS[imgType] || 'SCAN';
    document.getElementById('imgLbl').textContent = lbl;
    document.getElementById('imgBadge').textContent = lbl;
    analyzeImgB64(b64, imgType, file.type); // pass b64 directly ‚Äî no second FileReader
  };
  reader.readAsDataURL(file);
}
function reAnalyze(){
  if(!imgFile) return;
  // re-read from stored file
  const r = new FileReader();
  r.onload = e => analyzeImgB64(e.target.result.split(',')[1], imgType, imgFile.type);
  r.readAsDataURL(imgFile);
}
function clearImage(){
  imgFile=null;
  document.getElementById('imgPreview').src='';
  document.getElementById('imgWork').classList.remove('on');
  document.getElementById('imgUpload').style.display='block';
  document.getElementById('imgBody').innerHTML='<div style="text-align:center;padding:36px 16px;color:var(--text3)"><div style="font-size:28px;margin-bottom:10px">üîç</div><div style="font-size:12px">Upload a medical image to begin AI analysis</div></div>';
  document.getElementById('imgQ').value='';
  document.getElementById('imgFile').value='';
  document.getElementById('imgLbl').textContent=IMG_LABELS[imgType]||'SCAN';
  notif('Image cleared');
}
async function analyzeImg(file, scanType){
  // wrapper for backward-compat (reAnalyze, changeImgType)
  if(!file) return;
  const r = new FileReader();
  r.onload = e => analyzeImgB64(e.target.result.split(',')[1], scanType, file.type);
  r.readAsDataURL(file);
}

async function analyzeImgB64(b64, scanType, mimeType){
  // main analysis ‚Äî takes already-extracted base64, no FileReader needed
  const body = document.getElementById('imgBody');
  body.innerHTML = `<div style="text-align:center;padding:28px"><div class="loading-dots" style="justify-content:center"><span></span><span></span><span></span></div><div style="margin-top:10px;font-size:11px;color:var(--text3)">Analyzing ${scanType.toUpperCase()} image...</div></div>`;
  const prompt = `You are an expert radiologist analyzing a ${SCAN_NAMES[scanType]||scanType}. Analyze this image and respond ONLY with valid JSON in this exact format:
{"quality":{"rating":"Good","note":"brief note"},"findings":[{"type":"normal","label":"Finding Name","description":"detailed description","confidence":85}],"recommendation":"clinical recommendation","summary":"2-3 sentence summary"}
Types must be: normal, warning, critical, or info. Include 3-6 findings. Educational use only.`;
  try{
    const r = await fetch('/api/analyze-image/',{method:'POST',headers:{'Content-Type':'application/json','X-CSRFToken':getCSRF()},body:JSON.stringify({image_base64:b64,prompt,scan_type:scanType,mime_type:mimeType||'image/jpeg'})});
    const d = await r.json();
    if(d.success) renderFindings(d.result);
    else body.innerHTML = `<div style="padding:14px"><div style="color:var(--danger);font-size:12px;margin-bottom:7px">‚ö†Ô∏è Analysis Error</div><div style="color:var(--text3);font-size:11px">${d.error}</div><div style="margin-top:10px;font-size:10px;color:var(--text3)">Ensure Groq API key is set and supports vision models.</div></div>`;
  }catch(e){
    body.innerHTML = `<div style="padding:14px;color:var(--danger);font-size:12px">‚ö†Ô∏è Network error: ${e.message}</div>`;
  }
}
function renderFindings(result){
  const body=document.getElementById('imgBody');
  let p=null;try{const m=result.match(/\{[\s\S]*\}/);p=m?JSON.parse(m[0]):null;}catch(e){p=null;}
  if(!p){body.innerHTML=`<div class="finding info"><div class="finding-icon">ü§ñ</div><div class="finding-body"><div class="finding-lbl" style="color:var(--accent)">AI Analysis</div><div class="finding-desc">${result.replace(/\n/g,'<br>')}</div></div></div><div class="img-disclaimer">‚ö†Ô∏è Educational/assistive use only. Consult a medical professional.</div>`;return;}
  const icons={normal:'‚úÖ',warning:'‚ö†Ô∏è',critical:'üî¥',info:'‚ÑπÔ∏è'};
  const tclr={normal:'var(--accent2)',warning:'var(--warn)',critical:'var(--danger)',info:'var(--accent)'};
  const qclr={Good:'var(--accent2)',Fair:'var(--warn)',Poor:'var(--danger)'};
  let h='';
  if(p.quality)h+=`<div style="display:flex;align-items:center;gap:9px;margin-bottom:12px;padding:7px 10px;background:var(--surface);border-radius:var(--radius);border:1px solid var(--border)"><span style="font-size:10px;color:var(--text3)">Image Quality:</span><span style="font-size:11px;font-weight:700;color:${qclr[p.quality.rating]||'var(--accent)'}">${p.quality.rating}</span><span style="font-size:10px;color:var(--text3);flex:1">${p.quality.note||''}</span></div>`;
  if(p.summary)h+=`<div style="font-size:11px;color:var(--text2);line-height:1.7;margin-bottom:12px;padding:9px 11px;background:rgba(56,189,248,.05);border-radius:var(--radius);border-left:3px solid var(--accent)">${p.summary}</div>`;
  if(p.findings&&p.findings.length){h+=`<div style="font-size:9px;font-weight:600;color:var(--text3);text-transform:uppercase;letter-spacing:.08em;margin-bottom:7px">Key Findings</div>`;p.findings.forEach(f=>{const t=f.type||'info';h+=`<div class="finding ${t}"><div class="finding-icon">${icons[t]||'‚ÑπÔ∏è'}</div><div class="finding-body"><div class="finding-lbl" style="color:${tclr[t]||'var(--accent)'}">${f.label||'Finding'}</div><div class="finding-desc">${f.description||''}</div>${f.confidence?`<div class="conf-row2"><div class="conf-lbl2">Confidence</div><div class="conf-track2"><div class="conf-fill2" style="width:${f.confidence}%;background:${f.confidence>80?'var(--accent2)':f.confidence>60?'var(--warn)':'var(--danger)'}"></div></div><div class="conf-pct2">${f.confidence}%</div></div>`:''}</div></div>`;});}
  if(p.recommendation)h+=`<div style="margin-top:10px;padding:9px 12px;background:rgba(251,146,60,.08);border:1px solid rgba(251,146,60,.2);border-radius:var(--radius)"><div style="font-size:9px;font-weight:700;color:var(--accent4);text-transform:uppercase;letter-spacing:.06em;margin-bottom:3px">üìã Recommendation</div><div style="font-size:11px;color:var(--text2);line-height:1.6">${p.recommendation}</div></div>`;
  h+=`<div class="img-disclaimer">‚ö†Ô∏è AI analysis for educational/assistive purposes only. Does not constitute a medical diagnosis. Always consult a qualified healthcare professional.</div>`;
  body.innerHTML=h;
}
async function askImg(){
  const q = document.getElementById('imgQ')?.value?.trim();
  if(!q || !imgFile){ notif('Upload an image first','error'); return; }
  const body = document.getElementById('imgBody');
  body.innerHTML = `<div style="padding:9px 11px;background:rgba(56,189,248,.1);border:1px solid rgba(56,189,248,.2);border-radius:var(--radius);margin-bottom:10px;font-size:11px;color:var(--accent)">üîç "${q}"</div><div style="text-align:center;padding:18px"><div class="loading-dots" style="justify-content:center"><span></span><span></span><span></span></div></div>`;
  const b64 = await new Promise((res,rej)=>{const r=new FileReader();r.onload=()=>res(r.result.split(',')[1]);r.onerror=()=>rej(new Error('read fail'));r.readAsDataURL(imgFile);});
  try{
    const r = await fetch('/api/analyze-image/',{method:'POST',headers:{'Content-Type':'application/json','X-CSRFToken':getCSRF()},body:JSON.stringify({image_base64:b64,prompt:`You are an expert radiologist. For this ${imgType} medical image, answer: ${q}\n\nBe specific and clinically relevant. Educational purposes only.`,scan_type:imgType,mime_type:imgFile.type})});
    const d = await r.json();
    if(d.success) body.innerHTML=`<div style="padding:9px 11px;background:rgba(56,189,248,.1);border:1px solid rgba(56,189,248,.2);border-radius:var(--radius);margin-bottom:10px;font-size:11px;color:var(--accent)">üîç "${q}"</div><div style="font-size:12px;color:var(--text2);line-height:1.7">${d.result.replace(/\n/g,'<br>')}</div><div style="margin-top:10px"><button onclick="reAnalyze()" style="background:transparent;border:1px solid var(--border);border-radius:7px;padding:5px 10px;color:var(--text3);font-size:10px;cursor:pointer;font-family:'DM Sans',sans-serif">‚Üê Back to full analysis</button></div><div class="img-disclaimer">‚ö†Ô∏è AI response for educational purposes only.</div>`;
    else{ notif(d.error||'Analysis failed','error'); reAnalyze(); }
  }catch(e){ notif('Network error: '+e.message,'error'); reAnalyze(); }
  document.getElementById('imgQ').value='';
}
// drag/drop imaging
const iz=document.getElementById('imgUpload');
iz.addEventListener('dragover',e=>{e.preventDefault();iz.classList.add('over');});
iz.addEventListener('dragleave',()=>iz.classList.remove('over'));
iz.addEventListener('drop',e=>{e.preventDefault();iz.classList.remove('over');const f=e.dataTransfer.files[0];if(f&&f.type.startsWith('image/'))loadImgFile(f);});

// ‚ïê‚ïê XAI ‚Äî EXPLAINABILITY ‚ïê‚ïê
async function runXAI(){
  if(!selFeatures.size){notif('Select feature columns first','error');return;}
  if(!selTarget){notif('Select a target column (click twice)','error');return;}
  const sampleIdx=parseInt(document.getElementById('xaiSampleIdx').value)||0;
  showLoad('Running Explainability...','Calculating per-feature contributions');
  const d=await post('/api/run-explainability/',{feature_columns:[...selFeatures],target_column:selTarget,sample_index:sampleIdx,model_type:document.getElementById('modelType').value});
  hideLoad();
  if(!d.success){notif(d.error||'XAI failed','error');return;}
  const r=d.result;
  document.getElementById('xai-empty').style.display='none';
  document.getElementById('xai-result').style.display='block';
  // Global bars
  const gb=document.getElementById('xai-global-bars');gb.innerHTML='';
  if(r.global_importance&&r.global_importance.length){
    const maxG=r.global_importance[0].importance||1;
    r.global_importance.slice(0,8).forEach(f=>{
      const pct=Math.round(f.importance/maxG*100);
      gb.innerHTML+=`<div class="feat-row"><div class="feat-lbl" title="${f.feature}">${f.feature}</div><div class="feat-track"><div class="feat-fill" style="width:${pct}%"></div></div><div class="feat-pct">${f.percent||pct}%</div></div>`;
    });
  }
  // Prediction box
  document.getElementById('xai-prediction-box').innerHTML=`<div style="padding:9px 12px;background:rgba(52,211,153,.08);border:1px solid rgba(52,211,153,.25);border-radius:var(--radius)"><div style="font-size:9px;color:var(--text3);text-transform:uppercase;letter-spacing:.08em;margin-bottom:4px">Prediction</div><div style="font-family:'DM Mono',monospace;font-size:22px;color:var(--accent2);font-weight:500">${parseFloat(r.prediction).toFixed(3)}</div><div style="font-size:10px;color:var(--text3);margin-top:3px">Baseline: ${parseFloat(r.baseline).toFixed(3)}</div></div>`;
  // Local contribution bars
  const lb=document.getElementById('xai-local-bars');lb.innerHTML='';
  if(r.local_contributions&&r.local_contributions.length){
    const maxC=Math.max(...r.local_contributions.map(c=>Math.abs(c.contribution)))||1;
    r.local_contributions.slice(0,8).forEach(c=>{
      const pct=Math.round(Math.abs(c.contribution)/maxC*100);
      const isPos=c.contribution>=0;
      lb.innerHTML+=`<div class="contrib-row"><div class="contrib-lbl" title="${c.feature}">${c.feature}</div><div class="contrib-track"><div class="${isPos?'contrib-fill-pos':'contrib-fill-neg'}" style="width:${pct}%"></div></div><div class="contrib-val" style="color:${isPos?'var(--accent2)':'var(--danger)'}">${isPos?'+':''}${c.contribution.toFixed(3)}</div></div>`;
    });
  }
  // Narrative
  document.getElementById('xai-narrative').textContent=r.why_narrative||'No narrative available.';
  notif('Explainability complete!');
}

// ‚ïê‚ïê RISK ENGINE ‚ïê‚ïê
async function runRisk(){
  if(!selFeatures.size){notif('Select feature columns first','error');return;}
  showLoad('Running Risk Engine...','Detecting anomalies and thresholds');
  const d=await post('/api/run-risk-engine/',{feature_columns:[...selFeatures],target_column:selTarget||''});
  hideLoad();
  if(!d.success){notif(d.error||'Risk analysis failed','error');return;}
  const r=d.result;
  document.getElementById('risk-empty').style.display='none';
  document.getElementById('risk-result').style.display='block';
  // KPIs
  const kd=r.risk_distribution||{};
  const ano=r.anomaly_detection||{};
  document.getElementById('risk-kpis').innerHTML=`
    <div class="metric-card"><div class="metric-val" style="color:var(--danger)">${r.alerts?r.alerts.length:0}</div><div class="metric-lbl">Active Alerts</div></div>
    <div class="metric-card"><div class="metric-val" style="color:var(--warn)">${kd.high_risk_count||0}</div><div class="metric-lbl">High Risk Patients</div></div>
    <div class="metric-card"><div class="metric-val" style="color:var(--accent4)">${ano.n_anomalies||0}</div><div class="metric-lbl">Anomalies Detected</div></div>
    <div class="metric-card"><div class="metric-val">${kd.high_risk_percent||0}%</div><div class="metric-lbl">High Risk %</div></div>`;
  // Alerts
  const alertDiv=document.getElementById('risk-alerts');alertDiv.innerHTML='';
  if(r.alerts&&r.alerts.length){
    r.alerts.forEach(a=>{
      const lvlCls=a.level==='CRITICAL'?'critical':a.level==='WARNING'?'warning':'low';
      const icon=a.level==='CRITICAL'?'üî¥':a.level==='WARNING'?'‚ö†Ô∏è':'üîµ';
      alertDiv.innerHTML+=`<div class="risk-alert ${lvlCls}"><div class="risk-alert-icon">${icon}</div><div class="risk-alert-body"><div class="risk-alert-lbl">${a.level} ‚Äî ${a.column}</div><div class="risk-alert-msg">${a.message}</div></div><div class="risk-alert-pct">${a.percent}%</div></div>`;
    });
  } else {alertDiv.innerHTML='<div style="color:var(--accent2);font-size:12px;padding:8px">‚úÖ No threshold alerts detected.</div>';}
  // Anomaly
  const aDiv=document.getElementById('risk-anomaly');
  aDiv.innerHTML=`<div style="padding:10px;background:rgba(251,146,60,.08);border:1px solid rgba(251,146,60,.2);border-radius:var(--radius);margin-bottom:10px"><div style="font-size:22px;font-family:'DM Mono',monospace;color:var(--accent4);font-weight:500">${ano.n_anomalies||0}</div><div style="font-size:10px;color:var(--text3);margin-top:2px">anomalies out of ${kd.total||0} patients (${ano.anomaly_percent||0}%)</div></div>`;
  if(ano.top_anomalies && ano.top_anomalies.length){
    // Get all column keys except row_index, take first 5
    const allKeys = Object.keys(ano.top_anomalies[0]);
    const cols = allKeys.filter(k => k !== 'row_index').slice(0, 5);

    // Table header
      let th = '<tr><th style="min-width:40px">#</th>'
        + cols.map(c => `<th style="min-width:80px;max-width:120px;overflow:hidden;text-overflow:ellipsis" title="${c}">${c.length>10?c.slice(0,10)+'‚Ä¶':c}</th>`).join('')
        + '</tr>';

      // Table body
      let tb = ano.top_anomalies.slice(0, 8).map(row => {
        const rowIdx = row.row_index !== undefined ? row.row_index : '‚Äî';
        const cells = cols.map(c => {
          const val = row[c];
          const display = (val === undefined || val === null) ? '‚Äî' : val;
          return `<td style="font-family:'DM Mono',monospace;font-size:11px">${display}</td>`;
        }).join('');
        return `<tr>
          <td style="font-weight:600;color:var(--accent4);font-size:11px">${rowIdx}</td>
          ${cells}
        </tr>`;
      }).join('');

      aDiv.innerHTML += `
        <div style="overflow-x:auto;margin-top:8px">
          <table class="prev-table" style="font-size:11px;width:100%">
            <thead>${th}</thead>
            <tbody>${tb}</tbody>
          </table>
        </div>`;
  }
  // Top risk patients
  const trDiv=document.getElementById('risk-top-patients');trDiv.innerHTML='';
  if(r.top_risk_patients&&r.top_risk_patients.length){
    r.top_risk_patients.slice(0,8).forEach((p,i)=>{
      const c=p.risk_score>70?'var(--danger)':p.risk_score>40?'var(--warn)':'var(--accent2)';
      trDiv.innerHTML+=`<div class="feat-row"><div class="feat-lbl">Row #${p.index}</div><div class="feat-track"><div class="feat-fill" style="width:${p.risk_score}%;background:${c}"></div></div><div class="feat-pct" style="color:${c}">${p.risk_score}%</div></div>`;
    });
  }
  // Change alerts
  const chDiv=document.getElementById('risk-changes');chDiv.innerHTML='';
  if(r.change_alerts&&r.change_alerts.length){
    r.change_alerts.forEach(ca=>{
  const dir = ca.direction === 'increasing' ? 'üìà' : 'üìâ';
  const pct = ca.change_percent || 0;
  const msg = ca.message || `${ca.direction} by ${pct}% vs overall average`;
  chDiv.innerHTML+=`<div class="risk-alert warning">
    <div class="risk-alert-icon">${dir}</div>
    <div class="risk-alert-body">
      <div class="risk-alert-lbl">Sudden Change ‚Äî ${ca.column}</div>
      <div class="risk-alert-msg">${msg}</div>
    </div>
    <div class="risk-alert-pct">${pct}%</div>
  </div>`;
});
  } else {chDiv.innerHTML='<div style="color:var(--accent2);font-size:12px;padding:8px">‚úÖ No sudden changes detected.</div>';}
  notif('Risk analysis complete!');
}

// ‚ïê‚ïê TRENDS ‚ïê‚ïê
async function runTrends(){
  if(!selFeatures.size){notif('Select feature columns first','error');return;}
  showLoad('Running Trend Analysis...','Computing trends and forecasts');
  const d=await post('/api/run-trend-analysis/',{feature_columns:[...selFeatures],forecast_steps:parseInt(document.getElementById('forecastSteps').value)||10});
  hideLoad();
  if(!d.success){notif(d.error||'Trend analysis failed','error');return;}
  const r=d.result;
  document.getElementById('trends-empty').style.display='none';
  document.getElementById('trends-result').style.display='block';
  const grid=document.getElementById('trends-charts-grid');grid.innerHTML='';
  Object.values(charts).forEach(c=>c.destroy&&c.destroy());
  const cols=r.columns||Object.keys(r.trends||{});
  cols.forEach((col,idx)=>{
    const t=r.trends[col];if(!t)return;
    const dirCls=t.direction==='increasing'?'trend-up':t.direction==='decreasing'?'trend-down':'trend-stable';
    const dirArrow=t.direction==='increasing'?'‚Üë':t.direction==='decreasing'?'‚Üì':'‚Üí';
    const card=document.createElement('div');card.className='trend-chart-card';
    const canvasId=`trendChart_${idx}`;
    card.innerHTML=`<div style="display:flex;align-items:center;gap:8px;margin-bottom:10px"><div style="font-size:12px;font-weight:600;color:var(--text);flex:1">${col}</div><span class="trend-direction-badge ${dirCls}">${dirArrow} ${t.direction}</span><span style="font-size:10px;color:var(--text3)">R¬≤=${t.r2}</span></div><div style="display:flex;gap:12px;margin-bottom:8px"><div style="font-size:10px;color:var(--text3)">Start: <strong style="color:var(--accent)">${t.start}</strong></div><div style="font-size:10px;color:var(--text3)">Now: <strong style="color:var(--accent2)">${t.current}</strong></div><div style="font-size:10px;color:var(--text3)">Œî: <strong style="color:${parseFloat(t.change_pct)>=0?'var(--accent2)':'var(--danger)'}">${t.change_pct}%</strong></div></div><div style="height:160px"><canvas id="${canvasId}"></canvas></div>`;
    grid.appendChild(card);
    setTimeout(()=>{
      const ctx=document.getElementById(canvasId);if(!ctx)return;
      const vals=t.values||[];const trendLine=t.trend_line||[];const ma=t.moving_average||[];
      const forecast=(r.forecasts&&r.forecasts[col])?r.forecasts[col].values:[];
      const labels=[...vals.map((_,i)=>i),...forecast.map((_,i)=>vals.length+i)];
      const mainData=[...vals,...Array(forecast.length).fill(null)];
      const forecastData=[...Array(vals.length-1).fill(null),vals[vals.length-1]||0,...forecast];
      charts[`trend_${col}`]=new Chart(ctx.getContext('2d'),{type:'line',data:{labels,datasets:[
        {label:'Actual',data:mainData,borderColor:'rgba(56,189,248,.8)',backgroundColor:'rgba(56,189,248,.05)',borderWidth:1.5,pointRadius:0,tension:.3},
        {label:'Trend',data:[...trendLine,...Array(forecast.length).fill(null)],borderColor:'rgba(244,114,182,.6)',borderDash:[4,4],borderWidth:1.5,pointRadius:0},
        {label:'Forecast',data:forecastData,borderColor:'rgba(251,146,60,.7)',borderDash:[3,3],borderWidth:1.5,pointRadius:0,tension:.3},
      ]},options:{responsive:true,maintainAspectRatio:false,plugins:{legend:{labels:{color:'#64748b',font:{size:8},boxWidth:10}}},scales:{x:{display:false},y:{ticks:{color:'#64748b',font:{size:9}},grid:{color:'rgba(99,179,237,.05)'}}}}}); 
    },50);
  });
  // Correlation matrix
  const corrDiv=document.getElementById('trends-corr');
  if(r.correlation_matrix&&r.correlation_matrix.length){
    const corrCols=[...new Set(r.correlation_matrix.map(c=>c.row))];
    let html=`<table class="corr-table"><thead><tr><th></th>${corrCols.map(c=>`<th>${c.length>10?c.slice(0,10)+'‚Ä¶':c}</th>`).join('')}</tr></thead><tbody>`;
    corrCols.forEach(row=>{
      html+=`<tr><th>${row.length>10?row.slice(0,10)+'‚Ä¶':row}</th>`;
      corrCols.forEach(col=>{
        const cell=r.correlation_matrix.find(x=>x.row===row&&x.col===col);
        const v=cell?cell.value:0;
        const abs=Math.abs(v);
        const bg=v===1?'rgba(56,189,248,.25)':abs>0.7?`rgba(${v>0?'52,211,153':'248,113,113'},.${Math.round(abs*25)+5})`:abs>0.3?`rgba(${v>0?'52,211,153':'248,113,113'},.1)`:'transparent';
        html+=`<td style="background:${bg};color:${abs>0.5?'var(--text)':'var(--text3)'}">${v.toFixed(2)}</td>`;
      });
      html+='</tr>';
    });
    html+='</tbody></table>';
    corrDiv.innerHTML=html;
  } else {corrDiv.innerHTML='<div style="color:var(--text3);font-size:11px">Not enough numeric columns for correlation.</div>';}
  notif('Trend analysis complete!');
}

// ‚ïê‚ïê PATIENT SIMILARITY ‚ïê‚ïê
async function runSimilarity(){
  if(!selFeatures.size){notif('Select feature columns first','error');return;}
  showLoad('Finding Similar Patients...','Computing KNN distances');
  const d=await post('/api/run-patient-similarity/',{feature_columns:[...selFeatures],query_index:parseInt(document.getElementById('simQueryIdx').value)||0,n_similar:parseInt(document.getElementById('simN').value)||5});
  hideLoad();
  if(!d.success){notif(d.error||'Similarity failed','error');return;}
  const r=d.result;
  document.getElementById('sim-empty').style.display='none';
  document.getElementById('sim-result').style.display='block';
  // Query patient
  const qpDiv=document.getElementById('sim-query-patient');
  const qp=r.query_patient||{};
  qpDiv.innerHTML=`<div class="qp-grid">${Object.entries(qp).map(([k,v])=>`<div class="qp-chip"><div class="qp-chip-lbl">${k}</div><div class="qp-chip-val">${v}</div></div>`).join('')}</div>`;
  // Similar patients table
  const spDiv=document.getElementById('sim-patients-table');
  if(r.similar_patients&&r.similar_patients.length){
    const fcols=r.feature_cols||Object.keys(r.similar_patients[0]).filter(k=>!['rank','index','distance','similarity_pct'].includes(k));
    let th=`<tr><th>#</th><th>Row</th>${fcols.slice(0,5).map(c=>`<th>${c}</th>`).join('')}<th>Similarity</th></tr>`;
    let tb=r.similar_patients.map(p=>`<tr><td style="color:var(--accent);font-weight:600">${p.rank}</td><td style="color:var(--text3)">#${p.index}</td>${fcols.slice(0,5).map(c=>`<td>${p[c]!=null?p[c]:'‚Äî'}</td>`).join('')}<td><div class="sim-score-bar"><div class="sim-score-track"><div class="sim-score-fill" style="width:${p.similarity_pct}%"></div></div><span style="font-size:10px;color:var(--accent3);font-family:'DM Mono',monospace">${p.similarity_pct}%</span></div></td></tr>`).join('');
    spDiv.innerHTML=`<table class="sim-table"><thead>${th}</thead><tbody>${tb}</tbody></table>`;
  }
  // Cohort comparison
  const ccDiv=document.getElementById('sim-cohort');ccDiv.innerHTML='';
  if(r.cohort_comparison&&r.cohort_comparison.length){
    const maxVal=Math.max(...r.cohort_comparison.map(c=>Math.max(c.population_mean,c.cohort_mean,c.query_value)));
    r.cohort_comparison.forEach(c=>{
      const popW=Math.round(c.population_mean/maxVal*100)||1;
      const cohW=Math.round(c.cohort_mean/maxVal*100)||1;
      const qryW=Math.round(c.query_value/maxVal*100)||1;
      ccDiv.innerHTML+=`<div class="cohort-row"><div class="cohort-lbl" title="${c.feature}">${c.feature}</div><div class="cohort-bars"><div class="cohort-bar-row"><div class="cohort-bar-lbl" style="color:rgba(56,189,248,.6)">Population</div><div class="cohort-track"><div class="cohort-fill-pop" style="width:${popW}%"></div></div><div class="cohort-val">${c.population_mean}</div></div><div class="cohort-bar-row"><div class="cohort-bar-lbl" style="color:var(--accent3)">Cohort</div><div class="cohort-track"><div class="cohort-fill-coh" style="width:${cohW}%"></div></div><div class="cohort-val">${c.cohort_mean}</div></div><div class="cohort-bar-row"><div class="cohort-bar-lbl" style="color:var(--accent2)">This Patient</div><div class="cohort-track"><div class="cohort-fill-qry" style="width:${qryW}%"></div></div><div class="cohort-val">${c.query_value}</div></div></div></div>`;
    });
  }
  notif(`Found ${r.n_similar} similar patients!`);
}

// ‚ïê‚ïê CLINICAL INSIGHTS ‚ïê‚ïê
async function runInsights(){
  showLoad('Generating Clinical Insights...','AI is analysing your ML results');
  const d=await post('/api/clinical-insights/',{});
  hideLoad();
  if(!d.success){notif(d.error||'Run an ML analysis first','error');return;}
  const ins=d.insights;
  document.getElementById('insights-empty').style.display='none';
  document.getElementById('insights-result').style.display='block';
  // Summary
  document.getElementById('insights-summary').textContent=ins.executive_summary||'‚Äî';
  // Confidence badge
  const conf=ins.confidence_assessment||'medium';
  const confCls=conf==='high'?'conf-high':conf==='low'?'conf-low':'conf-med';
  document.getElementById('insights-conf-badge').innerHTML=`<span class="conf-pill ${confCls}">‚óè ${conf} confidence</span>`;
  // Observations
  const obsEl=document.getElementById('insights-observations');obsEl.innerHTML='';
  (ins.clinical_observations||[]).forEach(o=>{obsEl.innerHTML+=`<li class="obs-item"><span class="obs-icon">üî¨</span>${o}</li>`;});
  if(!obsEl.children.length)obsEl.innerHTML='<li class="obs-item"><span class="obs-icon">‚ÑπÔ∏è</span>No observations generated.</li>';
  // Recommendations
  const recEl=document.getElementById('insights-recommendations');recEl.innerHTML='';
  (ins.recommendations||[]).forEach(r=>{recEl.innerHTML+=`<li class="obs-item rec"><span class="obs-icon">‚úÖ</span>${r}</li>`;});
  if(!recEl.children.length)recEl.innerHTML='<li class="obs-item rec"><span class="obs-icon">‚ÑπÔ∏è</span>No recommendations.</li>';
  // Risk flags
  const riskEl=document.getElementById('insights-risks');riskEl.innerHTML='';
  (ins.risk_flags||[]).forEach(r=>{riskEl.innerHTML+=`<li class="obs-item risk"><span class="obs-icon">‚ö†Ô∏è</span>${r}</li>`;});
  if(!riskEl.children.length)riskEl.innerHTML='<li class="obs-item risk"><span class="obs-icon">‚úÖ</span>No critical risk flags.</li>';
  // Chart interpretation
  document.getElementById('insights-chart').textContent=ins.chart_interpretation||'‚Äî';
  notif('Clinical insights generated!');
}

// ‚ïê‚ïê DATA QUALITY ‚ïê‚ïê
async function runQuality(){
  showLoad('Running Data Quality Check...','Analysing missing data, outliers, bias');
  const r=await fetch('/api/data-quality/',{headers:{'X-CSRFToken':getCSRF()}});
  const d=await r.json();
  hideLoad();
  if(!d.success){notif(d.error||'Upload data first','error');return;}
  const q=d.result;
  document.getElementById('quality-empty').style.display='none';
  document.getElementById('quality-result').style.display='block';
  // Score ring
  const sc=q.overall_score||0;
  const gc=sc>=90?'var(--accent2)':sc>=75?'var(--warn)':'var(--danger)';
  document.getElementById('quality-score-ring').innerHTML=`<div style="font-family:'DM Mono',monospace;font-size:26px;font-weight:700;color:${gc}">${sc}</div><div style="font-size:9px;color:var(--text3);margin-top:2px">Grade ${q.grade||'?'}</div>`;
  document.getElementById('quality-score-ring').style.background=`conic-gradient(${gc} ${sc*3.6}deg,var(--surface3) 0)`;
  document.getElementById('quality-score-ring').style.boxShadow=`0 0 0 3px var(--surface),0 0 0 4px ${gc}`;
  document.getElementById('quality-recommendation').textContent=q.recommendation||'';
  document.getElementById('quality-bar').style.cssText=`width:${sc}%;background:${gc}`;
  // KPIs
  document.getElementById('quality-kpis').innerHTML=`
    <div class="metric-card"><div class="metric-val" style="color:var(--accent)">${q.total_rows?.toLocaleString()}</div><div class="metric-lbl">Total Rows</div></div>
    <div class="metric-card"><div class="metric-val" style="color:var(--accent2)">${q.total_cols}</div><div class="metric-lbl">Columns</div></div>
    <div class="metric-card"><div class="metric-val" style="color:var(--danger)">${q.issues?.length||0}</div><div class="metric-lbl">Issues</div></div>
    <div class="metric-card"><div class="metric-val" style="color:var(--warn)">${q.warnings?.length||0}</div><div class="metric-lbl">Warnings</div></div>`;
  // Issues
  const issDiv=document.getElementById('quality-issues');issDiv.innerHTML='';
  (q.issues||[]).forEach(i=>{issDiv.innerHTML+=`<div class="quality-issue-row critical"><span>‚ùå</span><span style="font-size:11px;color:var(--text2)">${i}</span></div>`;});
  if(!issDiv.children.length)issDiv.innerHTML='<div class="quality-issue-row passed"><span>‚úÖ</span><span style="font-size:11px;color:var(--accent2)">No critical issues.</span></div>';
  // Warnings
  const warnDiv=document.getElementById('quality-warnings');warnDiv.innerHTML='';
  (q.warnings||[]).forEach(w=>{warnDiv.innerHTML+=`<div class="quality-issue-row warning"><span>‚ö†Ô∏è</span><span style="font-size:11px;color:var(--text2)">${w}</span></div>`;});
  if(!warnDiv.children.length)warnDiv.innerHTML='<div class="quality-issue-row passed"><span>‚úÖ</span><span style="font-size:11px;color:var(--accent2)">No warnings.</span></div>';
  // Passed
  const passDiv=document.getElementById('quality-passed');passDiv.innerHTML='';
  (q.passed||[]).forEach(p=>{passDiv.innerHTML+=`<div class="quality-issue-row passed"><span>‚úÖ</span><span style="font-size:11px;color:var(--text2)">${p}</span></div>`;});
  // Missing data table
  const misDiv=document.getElementById('quality-missing');
  if(q.missing_report&&q.missing_report.length){
    let th='<tr><th>Column</th><th>Missing</th><th>%</th><th>Level</th><th>Visual</th></tr>';
    let tb=q.missing_report.map(r=>{
      const c=r.level==='critical'?'var(--danger)':r.level==='warning'?'var(--warn)':'var(--accent)';
      return `<tr><td style="font-family:'DM Mono',monospace">${r.column}</td><td>${r.missing}</td><td style="color:${c};font-weight:600">${r.percent}%</td><td><span style="font-size:9px;font-weight:700;color:${c};text-transform:uppercase">${r.level}</span></td><td><div class="miss-bar-track"><div class="miss-bar-fill" style="width:${Math.min(r.percent,100)}%;background:${c}"></div></div></td></tr>`;
    }).join('');
    misDiv.innerHTML=`<table class="quality-col-table"><thead>${th}</thead><tbody>${tb}</tbody></table>`;
  } else {misDiv.innerHTML='<div style="color:var(--accent2);font-size:12px;padding:8px">‚úÖ No missing values detected.</div>';}
  // Outliers
  const outDiv=document.getElementById('quality-outliers');
  if(q.outlier_report&&q.outlier_report.length){
    let th='<tr><th>Column</th><th>Outliers</th><th>%</th><th>Value Range</th></tr>';
    let tb=q.outlier_report.map(r=>`<tr><td style="font-family:'DM Mono',monospace">${r.column}</td><td style="color:var(--warn);font-weight:600">${r.outliers}</td><td>${r.percent}%</td><td style="font-size:10px;color:var(--text3)">[${r.range[0]}, ${r.range[1]}]</td></tr>`).join('');
    outDiv.innerHTML=`<table class="quality-col-table"><thead>${th}</thead><tbody>${tb}</tbody></table>`;
  } else {outDiv.innerHTML='<div style="color:var(--accent2);font-size:12px;padding:8px">‚úÖ No significant outliers detected.</div>';}
  notif('Data quality check complete!');
}

// ‚ïê‚ïê PRIVACY ‚ïê‚ïê
let privacyPhiCols=[], anonMethod='hash';
async function runPrivacy(){
  showLoad('Scanning for PHI...','Detecting personal health information');
  const r=await fetch('/api/privacy-check/',{headers:{'X-CSRFToken':getCSRF()}});
  const d=await r.json();
  hideLoad();
  if(!d.success){notif(d.error||'Upload data first','error');return;}
  const p=d.result;
  privacyPhiCols=p.phi_columns||[];
  document.getElementById('privacy-empty').style.display='none';
  document.getElementById('privacy-result').style.display='block';
  // Status badge
  const sc=p.compliance_score||0;
  const gc=sc>=90?'var(--accent2)':sc>=60?'var(--warn)':'var(--danger)';
  const stText=p.status==='COMPLIANT'?'‚úÖ COMPLIANT':p.status==='REVIEW_NEEDED'?'‚ö†Ô∏è REVIEW NEEDED':'‚õî NON-COMPLIANT';
  const stBg=sc>=90?'rgba(52,211,153,.12)':sc>=60?'rgba(251,191,36,.1)':'rgba(248,113,113,.1)';
  document.getElementById('privacy-status-badge').innerHTML=stText;
  document.getElementById('privacy-status-badge').style.cssText=`background:${stBg};color:${gc};border:1px solid ${gc};font-size:13px;font-weight:700;padding:8px 18px;border-radius:var(--radius);margin-bottom:8px;display:inline-block`;
  document.getElementById('privacy-score-bar').style.cssText=`width:${sc}%;background:${gc}`;
  // KPIs
  document.getElementById('privacy-kpis').innerHTML=`
    <div class="metric-card"><div class="metric-val" style="color:${gc}">${sc}</div><div class="metric-lbl">Compliance Score</div></div>
    <div class="metric-card"><div class="metric-val" style="color:var(--danger)">${p.high_risk_count||0}</div><div class="metric-lbl">High Risk PHI</div></div>
    <div class="metric-card"><div class="metric-val" style="color:var(--warn)">${p.medium_risk_count||0}</div><div class="metric-lbl">Medium Risk PHI</div></div>
    <div class="metric-card"><div class="metric-val" style="color:var(--accent)">${p.total_columns||0}</div><div class="metric-lbl">Total Columns</div></div>`;
  // PHI list
  const phiDiv=document.getElementById('privacy-phi-list');phiDiv.innerHTML='';
  if(privacyPhiCols.length){
    privacyPhiCols.forEach(c=>{
      const isHigh=c.risk_level==='HIGH';
      const icon=isHigh?'‚õî':'‚ö†Ô∏è';
      phiDiv.innerHTML+=`<div class="phi-card ${isHigh?'high':'medium'}"><div class="phi-icon">${icon}</div><div class="phi-body"><div class="phi-col">${c.column}</div><div class="phi-meta">Type: ${c.dtype} ¬∑ Sample: <code style="font-size:9px;background:var(--surface3);padding:1px 5px;border-radius:4px;color:var(--accent3)">${String(c.sample).slice(0,30)}</code></div></div><span class="phi-risk-badge ${isHigh?'phi-risk-high':'phi-risk-med'}">${c.risk_level}</span></div>`;
    });
    document.getElementById('anon-col-count').textContent=`Will anonymise ${privacyPhiCols.length} column${privacyPhiCols.length!==1?'s':''}`;
  } else {
    phiDiv.innerHTML='<div class="phi-card safe"><div class="phi-icon">‚úÖ</div><div class="phi-body"><div class="phi-col" style="color:var(--accent2)">No PHI columns detected</div><div class="phi-meta">Dataset appears safe for analysis.</div></div></div>';
    document.getElementById('anon-col-count').textContent='No PHI columns to anonymise';
  }
  // Recommendations
  const recDiv=document.getElementById('privacy-recs');recDiv.innerHTML='';
  (p.recommendations||[]).forEach(r=>{
    const isUrgent=r.startsWith('‚õî')||r.startsWith('Mask')||r.startsWith('Use');
    recDiv.innerHTML+=`<div class="quality-issue-row ${isUrgent?'warning':'passed'}"><span>${isUrgent?'üìã':'‚úÖ'}</span><span style="font-size:11px;color:var(--text2)">${r}</span></div>`;
  });
  notif(`Privacy scan complete ‚Äî ${privacyPhiCols.length} PHI column${privacyPhiCols.length!==1?'s':''} detected`);
}
function selAnonMethod(method, el){
  anonMethod=method;
  document.querySelectorAll('.anon-method-card').forEach(c=>c.classList.remove('sel'));
  el.classList.add('sel');
}
async function runAnonymise(){
  if(!privacyPhiCols.length){notif('No PHI columns detected to anonymise','error');return;}
  const cols=privacyPhiCols.map(c=>c.column);
  showLoad('Anonymising PHI columns...','Applying '+anonMethod+' method');
  const d=await post('/api/anonymise/',{columns:cols,method:anonMethod});
  hideLoad();
  if(!d.success){notif(d.error,'error');return;}
  const resDiv=document.getElementById('anon-result');
  resDiv.style.display='block';
  resDiv.innerHTML=`‚úÖ ${d.message}<br><div style="margin-top:6px;font-size:10px;color:var(--text3)">${(d.audit_log||[]).map(a=>`‚Ä¢ ${a.column}: ${a.method} (${a.rows_affected} rows)`).join('<br>')}</div>`;
  notif(d.message);
  // Re-scan after anonymisation
  setTimeout(runPrivacy,500);
}

// ‚ïê‚ïê REPORT ‚ïê‚ïê
let reportHtml='';
async function runReport(){
  showLoad('Generating Clinical Report...','Building AI narrative and quality assessment');
  const d=await post('/api/generate-report/',{});
  hideLoad();
  if(!d.success){notif(d.error||'Run an ML analysis first','error');return;}
  reportHtml=d.html;
  document.getElementById('report-empty').style.display='none';
  document.getElementById('report-preview-wrap').style.display='block';
  document.getElementById('report-open-btn').style.display='inline-flex';
  // Load into iframe
  const frame=document.getElementById('report-frame');
  const blob=new Blob([reportHtml],{type:'text/html'});
  frame.src=URL.createObjectURL(blob);
  document.getElementById('report-preview-title').textContent='Clinical Report ‚Äî '+new Date().toLocaleDateString();
  notif('Report generated! Click "Open Full Report" to print or save as PDF.');
}
function openReport(){
  if(!reportHtml){notif('Generate a report first','error');return;}
  const w=window.open('','_blank');
  w.document.write(reportHtml);
  w.document.close();
}
function printReport(){
  if(!reportHtml){notif('Generate a report first','error');return;}
  const frame=document.getElementById('report-frame');
  frame.contentWindow.print();
}


// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// 6 NEW FEATURE JS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

// ‚îÄ‚îÄ Helper: populate survival column selects when data loads ‚îÄ‚îÄ
function populateSurvivalSelects(){
  const numeric = colInfo.filter(c=>c.col_type==='numeric');
  const all     = colInfo;
  ['survDurationCol','survEventCol'].forEach(id=>{
    const el=document.getElementById(id);
    el.innerHTML='<option value="">‚Äî Select column ‚Äî</option>';
    numeric.forEach(c=>el.innerHTML+=`<option value="${c.name}">${c.name}</option>`);
  });
  const grp=document.getElementById('survGroupCol');
  grp.innerHTML='<option value="">‚Äî No grouping ‚Äî</option>';
  all.forEach(c=>grp.innerHTML+=`<option value="${c.name}">${c.name}</option>`);
}

// ‚îÄ‚îÄ Helper: populate multi-target selector ‚îÄ‚îÄ
let mtSelectedTargets=new Set();
function populateMultiTargetSelector(){
  const el=document.getElementById('mt-target-selector');
  el.innerHTML='';
  colInfo.forEach(c=>{
    const chip=document.createElement('div');
    chip.className='chip';chip.textContent=c.name;chip.dataset.col=c.name;
    chip.onclick=()=>{
      if(mtSelectedTargets.has(c.name)){mtSelectedTargets.delete(c.name);chip.classList.remove('active');}
      else{mtSelectedTargets.add(c.name);chip.classList.add('active');}
      document.getElementById('mt-target-count').textContent=mtSelectedTargets.size;
    };
    el.appendChild(chip);
  });
}

// onData override merged into original above

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// 1. PATIENT DASHBOARD
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
async function runPatientDashboard(){
  const rowIdx = parseInt(document.getElementById('patientRowIdx').value) || 0;

  // ‚úÖ Auto-use all available columns if none manually selected
  let feats = [...selFeatures];
  if(!feats.length && colInfo && colInfo.length){
    feats = colInfo.filter(c => c.col_type === 'numeric').map(c => c.name);
  }
  if(!feats.length){
    notif('Please upload a dataset first','error');
    return;
  }

  showLoad('Loading Patient Profile...','Calculating risk score and similar patients');
  const d = await post('/api/patient-dashboard/', {
    row_index:       rowIdx,
    feature_columns: feats,
    target_column:   selTarget || ''
  });
  hideLoad();

  if(!d.success){
    notif(d.error || 'Patient profile failed','error');
    return;
  }
  const r = d.result;
  if(r.error){
    notif(r.error,'error');
    return;
  }

  document.getElementById('patient-empty').style.display  = 'none';
  document.getElementById('patient-result').style.display = 'block';

  // ‚îÄ‚îÄ Risk ring ‚îÄ‚îÄ
  const ring = document.getElementById('patient-risk-ring');
  ring.className = 'risk-ring ' + (r.risk_level||'LOW').toLowerCase();
  document.getElementById('patient-risk-score').textContent  = (r.risk_score||0) + '%';
  document.getElementById('patient-risk-label').innerHTML =
    `<span style="color:${r.risk_level==='HIGH'?'var(--danger)':r.risk_level==='MEDIUM'?'var(--warn)':'var(--accent2)'}">
      ${r.risk_level||'LOW'} RISK
    </span> ‚Äî Patient #${r.row_index} of ${r.total_patients}`;
  document.getElementById('patient-anomaly').textContent =
    r.anomaly_flag ? ('‚ö†Ô∏è ' + r.anomaly_reason) : '‚úÖ No anomalies detected';
  document.getElementById('patient-missing').textContent =
    r.missing_count > 0 ? `${r.missing_count} missing values` : '';

  // ‚îÄ‚îÄ Prediction box ‚îÄ‚îÄ
  const pbox = document.getElementById('patient-prediction-box');
  if(r.prediction && r.prediction.prediction !== undefined){
    pbox.style.display = 'block';
    document.getElementById('patient-pred-val').textContent =
      typeof r.prediction.prediction === 'number'
        ? r.prediction.prediction.toFixed(3)
        : r.prediction.prediction;
  } else {
    pbox.style.display = 'none';
  }

  // ‚îÄ‚îÄ Values grid ‚îÄ‚îÄ
  const grid = document.getElementById('patient-values-grid');
  grid.innerHTML = '';
  (r.profile_values || []).forEach(v => {
    const cls     = v.is_outlier ? 'outlier' : v.is_target ? 'tgt' : v.is_feature ? 'feat' : '';
    const pct     = v.percentile !== undefined ? v.percentile : null;
    const dir     = v.direction || 'normal';
    const barColor = dir === 'high' ? 'hi' : dir === 'low' ? 'lo' : '';
    const dispVal  = v.is_missing ? '‚Äî'
      : typeof v.value === 'number'
        ? (v.value % 1 !== 0 ? Number(v.value).toFixed(2) : v.value)
        : String(v.value).slice(0, 18);
    grid.innerHTML += `
      <div class="pv-card ${cls}">
        <div class="pv-label">${v.column}${v.is_outlier ? ' ‚ö†Ô∏è' : ''}</div>
        <div class="pv-value">${dispVal}${v.is_missing ? ' <span style="font-size:9px;color:var(--warn)">MISSING</span>' : ''}</div>
        ${pct !== null
          ? `<div class="pv-pct">${pct}th pct ¬∑ z=${v.z_score ?? '‚Äî'}</div>
             <div class="pv-bar"><div class="pv-bar-fill ${barColor}" style="width:${pct}%"></div></div>`
          : ''}
      </div>`;
  });

  // ‚îÄ‚îÄ Population comparison bars ‚îÄ‚îÄ
  const popDiv = document.getElementById('patient-pop-bars');
  popDiv.innerHTML = '';
  Object.entries(r.population_stats || {}).slice(0, 7).forEach(([col, s]) => {
    const base = Math.abs(s.population_mean) || 0.001;
    const diff = ((s.patient_value - s.population_mean) / base * 100).toFixed(1);
    const col_good = diff > 0 ? 'var(--accent4)' : 'var(--accent2)';
    popDiv.innerHTML += `
      <div class="feat-row" style="margin-bottom:8px">
        <div class="feat-lbl" title="${col}">${col.length>12 ? col.slice(0,12)+'‚Ä¶' : col}</div>
        <div class="feat-track">
          <div class="feat-fill" style="width:${s.percentile}%;background:${col_good}"></div>
        </div>
        <div class="feat-pct" style="color:${col_good}">${diff > 0 ? '+' : ''}${diff}%</div>
      </div>`;
  });

  // ‚îÄ‚îÄ Similar patients ‚îÄ‚îÄ
  const simDiv = document.getElementById('patient-similar-table');
  if(r.similar_patients && r.similar_patients.length){
    const rows = r.similar_patients.map(s => {
      const vals = Object.entries(s.values || {}).slice(0, 3).map(([k,v]) => `${k}:${v}`).join(', ');
      return `<tr>
        <td>Row #${s.row_index}</td>
        <td style="color:var(--accent2);font-weight:600">${s.similarity_pct}%</td>
        <td style="font-size:9px;color:var(--text3)">${vals || '‚Äî'}</td>
      </tr>`;
    }).join('');
    simDiv.innerHTML = `
      <table class="sim-mini-table">
        <thead><tr><th>Patient</th><th>Similarity</th><th>Key Values</th></tr></thead>
        <tbody>${rows}</tbody>
      </table>`;
  } else {
    simDiv.innerHTML = '<div style="color:var(--text3);font-size:11px;padding:8px">Not enough numeric features for similarity.</div>';
  }

  notif(`Patient #${rowIdx} profile loaded ‚úÖ`);
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// 2. SURVIVAL ANALYSIS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const KM_COLORS=['#38bdf8','#34d399','#f472b6','#fb923c','#a78bfa','#fbbf24'];
async function runSurvival(){
  const dur=document.getElementById('survDurationCol').value;
  const evt=document.getElementById('survEventCol').value;
  const grp=document.getElementById('survGroupCol').value||null;
  if(!dur||!evt){notif('Select Duration and Event columns','error');return;}
  showLoad('Running Survival Analysis...','Computing Kaplan-Meier curves');
  const d=await post('/api/survival-analysis/',{duration_col:dur,event_col:evt,group_col:grp});
  hideLoad();
  if(!d.success){notif(d.error,'error');return;}
  const r=d.result;
  document.getElementById('survival-empty').style.display='none';
  document.getElementById('survival-result').style.display='block';

  // KPIs
  document.getElementById('survival-kpis').innerHTML=`
    <div class="metric-card"><div class="metric-val">${r.n_total?.toLocaleString()}</div><div class="metric-lbl">Patients</div></div>
    <div class="metric-card"><div class="metric-val" style="color:var(--danger)">${r.n_events}</div><div class="metric-lbl">Events</div></div>
    <div class="metric-card"><div class="metric-val" style="color:var(--accent2)">${r.n_censored}</div><div class="metric-lbl">Censored</div></div>
    <div class="metric-card"><div class="metric-val" style="color:var(--warn)">${r.event_rate}%</div><div class="metric-lbl">Event Rate</div></div>`;

  // KM Chart
  if(charts.survival)charts.survival.destroy();
  const groups=r.groups||{};
  const groupNames=Object.keys(groups);
  const datasets=[];
  const legend=document.getElementById('survival-legend');legend.innerHTML='';
  groupNames.forEach((grpName,i)=>{
    const c=KM_COLORS[i%KM_COLORS.length];
    const curve=groups[grpName];
    datasets.push({
      label:grpName,
      data:curve.times.map((t,j)=>({x:t,y:curve.survival[j]})),
      borderColor:c,fill:false,stepped:'after',
      borderWidth:2,pointRadius:0,tension:0
    });
    // CI band
    datasets.push({
      label:`${grpName} CI`,
      data:curve.times.map((t,j)=>({x:t,y:curve.ci_upper[j]})),
      borderColor:'transparent',
      backgroundColor:c.replace('rgb','rgba').replace(')',',0.08)'),
      fill:'+1',stepped:'after',pointRadius:0,tension:0,borderWidth:0
    });
    datasets.push({
      label:`${grpName} CI lower`,
      data:curve.times.map((t,j)=>({x:t,y:curve.ci_lower[j]})),
      borderColor:'transparent',fill:false,stepped:'after',pointRadius:0,tension:0,borderWidth:0
    });
    legend.innerHTML+=`<div style="display:flex;align-items:center;gap:5px;font-size:11px;color:var(--text2)"><span class="km-legend-dot" style="background:${c}"></span>${grpName}</div>`;
  });
  const ctx=document.getElementById('survivalChart').getContext('2d');
  charts.survival=new Chart(ctx,{
    type:'line',
    data:{datasets},
    options:{
      responsive:true,maintainAspectRatio:false,
      plugins:{legend:{display:false}},
      scales:{
        x:{type:'linear',title:{display:true,text:'Time',color:'#64748b'},ticks:{color:'#64748b',font:{size:9}},grid:{color:'rgba(99,179,237,.06)'}},
        y:{min:0,max:1,title:{display:true,text:'Survival Probability',color:'#64748b'},ticks:{color:'#64748b',font:{size:9}},grid:{color:'rgba(99,179,237,.06)'}}
      }
    }
  });

  // Medians
  const medDiv=document.getElementById('survival-medians');medDiv.innerHTML='';
  Object.entries(r.median_survival||{}).forEach(([grp,med],i)=>{
    const c=KM_COLORS[i%KM_COLORS.length];
    medDiv.innerHTML+=`<div style="display:flex;align-items:center;gap:8px;padding:8px 10px;background:var(--surface2);border-radius:var(--radius);margin-bottom:6px">
      <span class="km-legend-dot" style="background:${c};width:10px;height:10px;border-radius:50%;flex-shrink:0"></span>
      <div style="flex:1;font-size:12px;font-weight:600;color:var(--text)">${grp}</div>
      <div style="font-family:'DM Mono',monospace;font-size:13px;color:${c}">${med!=null?med+' units':'Not reached'}</div>
    </div>`;
  });

  document.getElementById('survival-interpretation').textContent=r.interpretation||'‚Äî';
  notif('Kaplan-Meier analysis complete!');
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// 3. MULTI-TARGET COMPARATOR
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
async function runMultiTarget(){
  const feats=[...selFeatures];
  const targets=[...mtSelectedTargets];
  if(!feats.length){notif('Select feature columns in the sidebar first','error');return;}
  if(targets.length<2){notif('Select at least 2 target columns to compare','error');return;}
  showLoad('Comparing Targets...','Training models for each target column');
  const d=await post('/api/multi-target-compare/',{
    feature_columns:feats,target_columns:targets,model_type:'random_forest'
  });
  hideLoad();
  if(!d.success){notif(d.error,'error');return;}
  const r=d.result;
  document.getElementById('multitarget-empty').style.display='none';
  document.getElementById('multitarget-result').style.display='block';

  document.getElementById('mt-best').textContent=
    r.best_target?`${r.best_target} ‚Äî ${(r.best_performance*100).toFixed(1)}% performance`:'No successful models';

  const list=document.getElementById('mt-results-list');list.innerHTML='';
  (r.results||[]).forEach(res=>{
    if(res.status==='error'){
      list.innerHTML+=`<div class="mt-result-card"><div class="mt-rank rn">!</div><div style="flex:1"><div style="font-size:12px;font-weight:600;color:var(--danger)">${res.target}</div><div style="font-size:10px;color:var(--text3)">${res.error}</div></div></div>`;
      return;
    }
    const perf=res.performance||0;
    const rankCls=res.rank===1?'r1':res.rank===2?'r2':'rn';
    const metric=res.task==='regression'?`R¬≤ ${(perf*100).toFixed(1)}%`:`Acc ${(perf*100).toFixed(1)}%`;
    const taskBadge=res.task==='regression'?'<span class="result-badge badge-reg" style="font-size:9px">REG</span>':'<span class="result-badge badge-cls" style="font-size:9px">CLS</span>';
    const top3=(res.feature_importance||[]).slice(0,3).map(f=>f.feature).join(', ');
    list.innerHTML+=`<div class="mt-result-card ${res.rank===1?'rank1':''}">
      <div class="mt-rank ${rankCls}">#${res.rank}</div>
      <div style="flex:1">
        <div style="display:flex;align-items:center;gap:7px;margin-bottom:4px">
          <span style="font-size:13px;font-weight:700;color:var(--text)">${res.target}</span>${taskBadge}
        </div>
        <div class="mt-perf-bar"><div class="mt-perf-fill" style="width:${perf*100}%"></div></div>
        <div style="font-size:10px;color:var(--text3);margin-top:4px">Top features: ${top3||'‚Äî'} ¬∑ ${res.n_rows} rows</div>
      </div>
      <div style="text-align:right;flex-shrink:0">
        <div style="font-family:'DM Mono',monospace;font-size:16px;font-weight:700;color:${res.rank===1?'var(--accent2)':'var(--accent)'}">${metric}</div>
      </div>
    </div>`;
  });
  notif(`Compared ${r.results.length} targets!`);
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// 4. ALERT RULES BUILDER
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
let alertRules=[];
function addRuleRow(rule={}){
  const id='rule-'+Date.now()+Math.random().toString(36).slice(2,5);
  const colOpts=colInfo.map(c=>`<option value="${c.name}" ${rule.column===c.name?'selected':''}>${c.name}</option>`).join('');
  const ops=['>', '<', '>=', '<=', '==', '!='];
  const opOpts=ops.map(o=>`<option value="${o}" ${rule.operator===o?'selected':''}>${o}</option>`).join('');
  const sevs=['critical','warning','info'];
  const sevOpts=sevs.map(s=>`<option value="${s}" ${rule.severity===s?'selected':''}>${s}</option>`).join('');
  const div=document.createElement('div');
  div.id=id;div.className='rule-builder';
  div.style.cssText='display:grid;grid-template-columns:1fr 110px 70px 100px 1fr 36px;gap:6px;align-items:center;padding:10px;margin-bottom:6px';
  div.innerHTML=`
    <select class="cfg-select" style="margin-bottom:0" data-field="column">${colOpts}</select>
    <select class="cfg-select" style="margin-bottom:0" data-field="operator">${opOpts}</select>
    <input type="number" class="cfg-select" style="margin-bottom:0" data-field="value" value="${rule.value||''}">
    <select class="cfg-select" style="margin-bottom:0" data-field="severity">${sevOpts}</select>
    <input type="text" class="cfg-select" style="margin-bottom:0" data-field="action" value="${rule.action||rule.name||''}" placeholder="Alert action/name">
    <button onclick="this.parentElement.remove()" style="width:32px;height:32px;border:none;background:rgba(248,113,113,.15);color:var(--danger);border-radius:7px;cursor:pointer;font-size:14px;display:flex;align-items:center;justify-content:center">√ó</button>`;
  document.getElementById('alert-rules-rows').appendChild(div);
}
function gatherRules(){
  const rows=document.getElementById('alert-rules-rows').children;
  return Array.from(rows).map(row=>({
    column:  row.querySelector('[data-field=column]').value,
    operator:row.querySelector('[data-field=operator]').value,
    value:   parseFloat(row.querySelector('[data-field=value]').value)||0,
    severity:row.querySelector('[data-field=severity]').value,
    action:  row.querySelector('[data-field=action]').value||'Review required',
    name:    row.querySelector('[data-field=action]').value||'Alert',
  }));
}
async function loadSuggestedRules(){
  showLoad('Finding Suggested Rules...','Scanning column names for clinical patterns');
  const r=await fetch('/api/suggest-alert-rules/').then(r=>r.json());
  hideLoad();
  if(!r.success){notif(r.error||'Upload data first','error');return;}
  document.getElementById('alert-rules-rows').innerHTML='';
  (r.suggestions||[]).slice(0,10).forEach(rule=>addRuleRow(rule));
  notif(`${r.suggestions.length} rules auto-suggested!`);
}
function clearRules(){document.getElementById('alert-rules-rows').innerHTML='';}
async function runAlerts(){
  const rules=gatherRules();
  if(!rules.length){notif('Add at least one rule first','error');return;}
  showLoad('Evaluating Alert Rules...','Scanning dataset for triggered conditions');
  const d=await post('/api/evaluate-alert-rules/',{rules});
  hideLoad();
  if(!d.success){notif(d.error,'error');return;}
  const r=d.result;
  document.getElementById('alerts-result').style.display='block';

  // Status banner
  const badge=document.getElementById('alerts-status-badge');
  const isCrit=r.overall_status==='CRITICAL',isWarn=r.overall_status==='WARNING';
  badge.textContent=isCrit?'‚õî CRITICAL ALERTS':isWarn?'‚ö†Ô∏è WARNINGS DETECTED':'‚úÖ ALL CLEAR';
  badge.style.cssText=`font-size:13px;font-weight:700;padding:8px 18px;border-radius:var(--radius);background:${isCrit?'rgba(248,113,113,.1)':isWarn?'rgba(251,191,36,.08)':'rgba(52,211,153,.08)'};color:${isCrit?'var(--danger)':isWarn?'var(--warn)':'var(--accent2)'};border:1px solid ${isCrit?'rgba(248,113,113,.3)':isWarn?'rgba(251,191,36,.25)':'rgba(52,211,153,.25)'}`;

  document.getElementById('alerts-kpis').innerHTML=`
    <div class="metric-card"><div class="metric-val" style="color:var(--danger)">${r.critical_alerts}</div><div class="metric-lbl">Critical</div></div>
    <div class="metric-card"><div class="metric-val" style="color:var(--warn)">${r.warning_alerts}</div><div class="metric-lbl">Warnings</div></div>
    <div class="metric-card"><div class="metric-val" style="color:var(--accent)">${r.rules_evaluated}</div><div class="metric-lbl">Rules Checked</div></div>`;

  const list=document.getElementById('alerts-triggered-list');list.innerHTML='';
  (r.triggered||[]).forEach(t=>{
    const isTrig=t.status==='TRIGGERED';
    const sc=t.severity==='critical'?'critical':t.severity==='warning'?'warning':t.status==='TRIGGERED'?'info':'clear';
    const icon=t.severity==='critical'?'‚õî':t.severity==='warning'?'‚ö†Ô∏è':isTrig?'‚ÑπÔ∏è':'‚úÖ';
    const barColor=t.severity==='critical'?'var(--danger)':t.severity==='warning'?'var(--warn)':'var(--accent)';
    list.innerHTML+=`<div class="alert-triggered ${isTrig?sc:'clear'}">
      <span style="font-size:18px;flex-shrink:0">${icon}</span>
      <div style="flex:1">
        <div style="font-size:12px;font-weight:600;color:var(--text);margin-bottom:3px">${t.rule_name}</div>
        <div style="font-size:10px;color:var(--text3);line-height:1.6">${t.action}${t.error?' ‚Äî Error: '+t.error:''}</div>
      </div>
      ${isTrig?`<div style="text-align:right;flex-shrink:0">
        <div style="font-family:'DM Mono',monospace;font-size:14px;font-weight:700;color:${barColor}">${t.n_triggered} patients</div>
        <div style="font-size:9px;color:var(--text3)">${t.percent}% of dataset</div>
        <div class="alert-pct-bar"><div class="alert-pct-fill" style="width:${Math.min(t.percent,100)}%;background:${barColor}"></div></div>
      </div>`:'<div style="font-size:10px;color:var(--accent2);font-weight:600">CLEAR</div>'}
    </div>`;
  });
  notif(`${r.critical_alerts} critical ¬∑ ${r.warning_alerts} warnings`);
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// 5. DATASET COMPARATOR
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
let compareBData=null;
async function handleCompareUpload(input){
  const file=input.files[0];if(!file)return;
  showLoad('Reading Dataset B...','Parsing columns');
  const fd=new FormData();fd.append('file',file);
  // We parse it client-side by loading into a temp fetch
  // Actually we'll read it via a hidden upload then save rows
  const r=await fetch('/api/upload-temp/',{method:'POST',headers:{'X-CSRFToken':getCSRF()},body:fd});
  // If no temp endpoint, we'll read via preview from the main upload temporarily
  // Simpler: re-upload as main, grab data_json, restore
  // Better approach: upload to a temp key and get rows back
  // For simplicity: read file as FormData, get preview back from standard upload
  const d2=await fetch('/api/upload/',{method:'POST',headers:{'X-CSRFToken':getCSRF()},body:fd}).then(r=>r.json());
  hideLoad();
  if(!d2.success){notif(d2.error,'error');return;}
  compareBData=d2.preview; // use preview rows for comparison
  document.getElementById('compare-b-info').style.display='block';
  document.getElementById('compare-b-info').textContent=`${file.name} ‚Äî ${d2.rows?.toLocaleString()} rows √ó ${d2.columns} columns`;
  notif('Dataset B loaded: '+file.name);
}
async function runCompare(){
  if(!compareBData){notif('Upload Dataset B first','error');return;}
  const nameA=document.getElementById('compareNameA').value||'Dataset A';
  const nameB=document.getElementById('compareNameB').value||'Dataset B';
  showLoad('Comparing Datasets...','Statistical difference analysis');
  const d=await post('/api/compare-datasets/',{data_b:compareBData,name_a:nameA,name_b:nameB});
  hideLoad();
  if(!d.success){notif(d.error,'error');return;}
  const r=d.result;
  document.getElementById('compare-empty').style.display='none';
  document.getElementById('compare-result').style.display='block';
  document.getElementById('compare-summary').textContent=r.summary||'';
  document.getElementById('compare-name-a-lbl').textContent=nameA;
  document.getElementById('compare-name-b-lbl').textContent=nameB;

  const list=document.getElementById('compare-cols-list');list.innerHTML='';
  const maxMean=Math.max(...(r.col_comparisons||[]).map(c=>Math.max(Math.abs(c.mean_a),Math.abs(c.mean_b))||1));
  (r.col_comparisons||[]).slice(0,30).forEach(c=>{
    const sig=c.significant;
    const effColor=c.effect_size==='large'?'var(--danger)':c.effect_size==='medium'?'var(--warn)':'var(--text3)';
    const barA=Math.abs(c.mean_a)/maxMean*100;
    const barB=Math.abs(c.mean_b)/maxMean*100;
    list.innerHTML+=`<div class="compare-col-row ${sig?'sig':''}">
      <div style="font-family:'DM Mono',monospace;font-size:10px;color:var(--text2);overflow:hidden;text-overflow:ellipsis;white-space:nowrap" title="${c.column}">${c.column}${sig?' *':''}</div>
      <div class="compare-bar-wrap"><div class="compare-bar"><div class="compare-bar-a" style="width:${barA}%"></div></div><span style="font-size:10px;color:var(--accent);width:55px;text-align:right;flex-shrink:0">${c.mean_a}</span></div>
      <div class="compare-bar-wrap"><div class="compare-bar"><div class="compare-bar-b" style="width:${barB}%"></div></div><span style="font-size:10px;color:var(--accent3);width:55px;text-align:right;flex-shrink:0">${c.mean_b}</span></div>
      <div style="font-size:10px;font-weight:600;color:${c.mean_diff>0?'var(--accent)':'var(--accent3)'}">${c.mean_diff>0?'+':''}${c.mean_diff}</div>
      <div style="font-size:9px;font-weight:700;color:${effColor};text-transform:uppercase">${c.effect_size}</div>
    </div>`;
  });
  notif(`Found ${r.n_significant} significant differences`);
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// 6. ICD CLINICAL CODING
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
async function runCoding(){
  showLoad('Scanning for ICD-10 Codes...','Detecting clinical terminology and drug interactions');
  const r=await fetch('/api/clinical-coding/').then(r=>r.json());
  hideLoad();
  if(!r.success){notif(r.error||'Upload data first','error');return;}
  const res=r.result;
  document.getElementById('coding-empty').style.display='none';
  document.getElementById('coding-result').style.display='block';

  // ICD-10 list
  const icdDiv=document.getElementById('coding-icd-list');
  if(res.icd10_suggestions&&res.icd10_suggestions.length){
    icdDiv.innerHTML='';
    res.icd10_suggestions.forEach(s=>{
      icdDiv.innerHTML+=`<div style="display:flex;align-items:center;gap:10px;padding:9px 12px;background:var(--surface2);border-radius:var(--radius);margin-bottom:6px;border:1px solid var(--border)">
        <span class="icd-badge">${s.icd10_code}</span>
        <div style="flex:1">
          <div style="font-size:12px;font-weight:600;color:var(--text)">${s.description}</div>
          <div style="font-size:10px;color:var(--text3)">Detected in column: <code style="font-family:'DM Mono',monospace;color:var(--accent)">${s.column}</code>${s.value?' ¬∑ value: "'+s.value+'"':''}</div>
        </div>
        <span style="font-size:9px;color:var(--text3);text-transform:uppercase">${s.match_type.replace('_',' ')}</span>
      </div>`;
    });
  } else {
    icdDiv.innerHTML='<div style="color:var(--text3);font-size:12px;padding:8px">No ICD-10 patterns detected in column names or values. Try datasets with clinical terminology (diabetes, glucose, hypertension, etc.)</div>';
  }

  // Drug interactions
  const drugDiv=document.getElementById('coding-drug-list');
  if(res.drug_interaction_flags&&res.drug_interaction_flags.length){
    drugDiv.innerHTML='';
    res.drug_interaction_flags.forEach(f=>{
      drugDiv.innerHTML+=`<div class="drug-flag ${f.severity}">
        <span style="font-size:20px">${f.severity==='HIGH'?'‚õî':'‚ö†Ô∏è'}</span>
        <div>
          <div style="font-size:12px;font-weight:600;color:var(--text);margin-bottom:3px">${f.drug_a.toUpperCase()} + ${f.drug_b.toUpperCase()}</div>
          <div style="font-size:11px;color:var(--text2)">${f.message}</div>
        </div>
        <span class="phi-risk-badge ${f.severity==='HIGH'?'phi-risk-high':'phi-risk-med'}" style="margin-left:auto;flex-shrink:0">${f.severity}</span>
      </div>`;
    });
  } else {
    drugDiv.innerHTML='<div style="color:var(--accent2);font-size:12px;padding:8px">‚úÖ No drug interaction patterns detected.</div>';
  }

  // LLM advice
  if(res.llm_advice){
    document.getElementById('coding-llm-advice').style.display='block';
    const recDiv=document.getElementById('coding-recs');recDiv.innerHTML='';
    (res.llm_advice.coding_recommendations||[]).forEach(r=>{
      recDiv.innerHTML+=`<div class="coding-rec">${r}</div>`;
    });
    const gapDiv=document.getElementById('coding-gaps');gapDiv.innerHTML='';
    (res.llm_advice.documentation_gaps||[]).forEach(g=>{
      gapDiv.innerHTML+=`<div class="coding-rec gap">${g}</div>`;
    });
    const sugDiv=document.getElementById('coding-suggestions');sugDiv.innerHTML='';
    (res.llm_advice.suggested_fields||[]).forEach(s=>{
      sugDiv.innerHTML+=`<div class="coding-rec note">${s}</div>`;
    });
  }

  notif(`Found ${res.icd10_suggestions?.length||0} ICD codes ¬∑ ${res.drug_interaction_flags?.length||0} drug flags`);
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// ‚ïê‚ïê SESSION RESTORE ‚ïê‚ïê
(async()=>{
  // Wire file input safely ‚Äî inline onchange removed to prevent re-entrant firing
  const fi = document.getElementById('fileInput');
  if(fi) fi.onchange = e => handleUpload(e.target);

  const d=await fetch('/api/columns/').then(r=>r.json());
  if(d.success&&d.columns.length>0){
    colInfo=d.columns;
    document.getElementById('ds-rows').textContent=d.rows.toLocaleString();
    document.getElementById('ds-cols').textContent=d.columns.length;
    document.getElementById('ds-file').textContent='Session restored';
    document.getElementById('dataset-info').style.display='block';
    document.getElementById('welcomeCard').style.display='none';
    document.getElementById('column-panel').style.display='block';
    document.getElementById('analysis-panel').style.display='block';
    renderCols(colInfo);
    if(d.preview)renderPreview(d.preview,d.rows,d.columns.length);
    fetchColStats();
  }
})();
</script>
</body>
</html>